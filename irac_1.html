<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRAC æ³•å¾‹æ€ç¶­å°èˆªå„€</title>
    <style>
        :root {
            --primary-color: #2c3e50; /* æ³•å¾‹å°ˆæ¥­æ·±è— */
            --accent-color: #c0392b; /* è­¦ç¤º/é‡é»ç´… */
            --success-color: #27ae60;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
        }

        body {
            font-family: "Helvetica Neue", Arial, "PingFang TC", "Heiti TC", sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h1 { margin: 0; font-size: 1.5rem; }
        .subtitle { font-size: 0.9rem; opacity: 0.8; }

        /* Main Layout */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden; /* é˜²æ­¢æ•´é æ»¾å‹• */
        }

        /* Left Panel: Case Facts */
        .left-panel {
            width: 35%;
            background-color: #eef2f5;
            padding: 2rem;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }

        .case-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            line-height: 1.8;
        }

        .case-title {
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--accent-color);
            display: inline-block;
            padding-bottom: 5px;
        }

        /* Right Panel: Interaction */
        .right-panel {
            width: 65%;
            display: flex;
            flex-direction: column;
            padding: 0;
            background: white;
        }

        /* Progress Bar */
        .progress-bar {
            display: flex;
            justify-content: space-around;
            padding: 1.5rem;
            background: #fff;
            border-bottom: 1px solid #eee;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.4;
            transition: all 0.3s;
            position: relative;
            flex: 1;
        }

        .step.active { opacity: 1; font-weight: bold; color: var(--primary-color); }
        .step.completed { opacity: 1; color: var(--success-color); }
        
        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #ccc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .step.active .step-circle { background: var(--primary-color); transform: scale(1.1); }
        .step.completed .step-circle { background: var(--success-color); }

        /* Chat Area */
        .chat-history {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            max-width: 80%;
            padding: 1rem;
            border-radius: 12px;
            line-height: 1.6;
            position: relative;
        }

        .ai-message {
            align-self: flex-start;
            background-color: #f0f4f8;
            color: #2c3e50;
            border-left: 4px solid var(--primary-color);
        }
        
        .ai-message.feedback-fail {
            background-color: #fff5f5;
            border-left-color: var(--accent-color);
        }

        .ai-message.feedback-pass {
            background-color: #e8f8f5;
            border-left-color: var(--success-color);
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
        }

        /* Input Area */
        .input-area {
            padding: 2rem;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 1rem;
        }

        textarea {
            flex: 1;
            padding: 1rem;
            border: 2px solid #eee;
            border-radius: 8px;
            resize: none;
            font-size: 1rem;
            height: 60px;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        button {
            padding: 0 2rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover { background-color: #34495e; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Loading dots */
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

    </style>
</head>
<body>

<header>
    <div>
        <h1>IRAC æ³•å¾‹æ€ç¶­å°èˆªå„€</h1>
        <span class="subtitle">AI-Powered Legal Reasoning Trainer</span>
    </div>
    <div style="font-size: 0.9rem;">èª²ç¨‹ï¼šæ³•å¾‹èˆ‡äººå·¥æ™ºæ…§</div>
</header>

<div class="container">
    <div class="left-panel">
        <div class="case-card">
            <div class="case-title">æ¡ˆä¾‹äº‹å¯¦ (Case Facts)</div>
            <p id="caseFactsText">
                ç”²ï¼ˆç”·ï¼Œ30æ­²ï¼‰èˆ‡ä¹™ï¼ˆç”·ï¼Œ28æ­²ï¼‰ç‚ºé„°å±…ï¼Œç´ æœ‰ç©æ€¨ã€‚æŸæ—¥æ™šé–“ï¼Œå…©äººåœ¨ç¤¾å€é–€å£ç›¸é‡ï¼Œç™¼ç”Ÿæ¿€çƒˆå£è§’ã€‚ä¹™çªç„¶å¾å£è¢‹æ‹¿å‡ºæŠ˜ç–Šåˆ€ï¼Œå°ç”²å«å›‚ï¼šã€Œä¿¡ä¸ä¿¡æˆ‘æ…æ­»ä½ ï¼ã€ä¸¦å‘ç”²é€¼è¿‘ã€‚
                <br><br>
                ç”²è¦‹ç‹€é©šæï¼Œéš¨æ‰‹æ‹¿èµ·è·¯é‚Šçš„ç£šé ­ä¸Ÿå‘ä¹™ã€‚ç£šé ­æ“Šä¸­ä¹™çš„é ­éƒ¨ï¼Œä¹™ç•¶å ´å€’åœ°ï¼Œé€é†«å¾Œå› é¡±å…§å‡ºè¡€ä¸æ²»æ­»äº¡ã€‚
                <br><br>
                è«‹ä¾æ“šä¸Šè¿°äº‹å¯¦ï¼Œåˆ†æç”²çš„åˆ‘äº‹è²¬ä»»ã€‚
            </p>
        </div>
        <div style="margin-top: 20px; color: #666; font-size: 0.85rem;">
            <p><strong>ğŸ’¡ è€å¸«çš„å°æç¤ºï¼š</strong></p>
            <ul>
                <li>è«‹ä¸è¦æ€¥è‘—åˆ¤æ–·æœ‰ç½ªç„¡ç½ªã€‚</li>
                <li>ä¾ç…§å³å´çš„å°èˆªï¼Œä¸€æ­¥ä¸€æ­¥å»ºç«‹è«–è­‰ã€‚</li>
                <li>AI å°‡æ“”ä»»ä½ çš„ã€Œè˜‡æ ¼æ‹‰åº•å°å¸«ã€ã€‚</li>
            </ul>
        </div>
    </div>

    <div class="right-panel">
        <div class="progress-bar">
            <div class="step active" id="step-issue">
                <div class="step-circle">I</div>
                <span>çˆ­é» (Issue)</span>
            </div>
            <div class="step" id="step-rule">
                <div class="step-circle">R</div>
                <span>è¦å‰‡ (Rule)</span>
            </div>
            <div class="step" id="step-application">
                <div class="step-circle">A</div>
                <span>æ¶µæ” (Application)</span>
            </div>
            <div class="step" id="step-conclusion">
                <div class="step-circle">C</div>
                <span>çµè«– (Conclusion)</span>
            </div>
        </div>

        <div class="chat-history" id="chatHistory">
            <div class="message ai-message">
                æ­¡è¿ä¾†åˆ°æ€ç¶­è¨“ç·´ã€‚æˆ‘å€‘å¾ç¬¬ä¸€æ­¥é–‹å§‹ï¼š<br><br>
                <strong>è«‹æŒ‡å‡ºæœ¬æ¡ˆæœ€æ ¸å¿ƒçš„æ³•å¾‹çˆ­é»ï¼ˆIssueï¼‰æ˜¯ä»€éº¼ï¼Ÿ</strong><br>
                ï¼ˆè«‹è©¦è‘—ç”¨å•å¥å½¢å¼æå‡ºï¼Œä¾‹å¦‚ï¼šç”²çš„è¡Œç‚ºæ˜¯å¦æ§‹æˆ...ï¼Ÿï¼‰
            </div>
        </div>

        <div class="input-area">
            <textarea id="userInput" placeholder="åœ¨æ­¤è¼¸å…¥ä½ çš„æƒ³æ³•..."></textarea>
            <button id="sendBtn" onclick="handleSubmit()">é€å‡º</button>
        </div>
    </div>
</div>

<script>
    // =================CONFIG=================
    // è«‹å°‡æ‚¨çš„ n8n Webhook URL è²¼åœ¨é€™è£¡
    // è¨˜å¾—è¦æ˜¯ Production URLï¼Œæˆ–è€…æ˜¯ Test URL (ä½† Test URL éœ€è¦ä¿æŒ n8n è¦–çª—é–‹å•Ÿ)
    const N8N_WEBHOOK_URL = "https://kf0630.zeabur.app/webhook/irac-tutor"; 
    // ========================================

    const stages = ['issue', 'rule', 'application', 'conclusion'];
    let currentStageIndex = 0;
    
    // éšæ®µæç¤ºèª (ç•¶é€²å…¥è©²éšæ®µæ™‚é¡¯ç¤º)
    const stagePrompts = {
        'issue': 'è«‹æŒ‡å‡ºæœ¬æ¡ˆæœ€æ ¸å¿ƒçš„æ³•å¾‹çˆ­é»ï¼ˆIssueï¼‰æ˜¯ä»€éº¼ï¼Ÿ',
        'rule': 'é‡å°ä½ æå‡ºçš„çˆ­é»ï¼Œæ³•å¾‹è¦ç¯„ï¼ˆRuleï¼‰æ˜¯ä»€éº¼ï¼Ÿè«‹åˆ—å‡ºå…·é«”çš„æ§‹æˆè¦ä»¶ã€‚',
        'application': 'ç¾åœ¨é€²è¡Œæ¶µæ”ï¼ˆApplicationï¼‰ã€‚è«‹å°‡æœ¬æ¡ˆäº‹å¯¦å¡«å…¥ä¸Šè¿°è¦ä»¶ä¸­ï¼Œä¸¦è«–è­‰ç‚ºä½•ç¬¦åˆï¼ˆæˆ–ä¸ç¬¦åˆï¼‰ã€‚',
        'conclusion': 'æœ€å¾Œï¼Œè«‹æ ¹æ“šä¸Šè¿°æ¨è«–ï¼Œçµ¦å‡ºç°¡æ½”çš„æ³•å¾‹çµè«–ï¼ˆConclusionï¼‰ã€‚'
    };

    const chatHistory = document.getElementById('chatHistory');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const caseFacts = document.getElementById('caseFactsText').innerText;

    // æŒ‰ä¸‹ Enter ä¹Ÿèƒ½é€å‡º (Shift+Enter æ›è¡Œ)
    userInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSubmit();
        }
    });

    async function handleSubmit() {
        const text = userInput.value.trim();
        if (!text) return;

        // 1. é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
        appendMessage(text, 'user-message');
        userInput.value = '';
        userInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.textContent = 'æ€è€ƒä¸­...';

        // 2. æº–å‚™é€å¾€ n8n çš„è³‡æ–™
        const payload = {
            student_input: text,
            current_stage: stages[currentStageIndex],
            case_facts: caseFacts
        };

        try {
            // 3. å‘¼å« n8n Webhook
            // æ³¨æ„ï¼šå¦‚æœæ‚¨é‚„æ²’è¨­å®šå¥½ n8nï¼Œé€™å€‹ fetch æœƒå¤±æ•—ã€‚
            // åœ¨èª²å ‚ demo å‰ï¼Œè«‹ç¢ºä¿ n8n Workflow è™•æ–¼ Active ç‹€æ…‹ã€‚
            
            const response = await fetch(N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error('ç¶²è·¯é€£ç·šéŒ¯èª¤æˆ– n8n æœªå›æ‡‰');
            }

            const data = await response.json();
            // é æœŸ n8n å›å‚³æ ¼å¼: { "pass": boolean, "feedback": "string" }

            handleAIResponse(data);

        } catch (error) {
            console.error(error);
            appendMessage("âš ï¸ ç³»çµ±é€£ç·šéŒ¯èª¤ã€‚è«‹æª¢æŸ¥ n8n Webhook URL æ˜¯å¦æ­£ç¢ºï¼Œæˆ– n8n æ˜¯å¦å·²å•Ÿå‹•ã€‚", "ai-message feedback-fail");
            
            // --- æ¸¬è©¦ç”¨ (å¦‚æœæ‚¨é‚„æ²’æ¶å¥½ n8nï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢è¨»è§£ä¾†æ¸¬è©¦ä»‹é¢æ•ˆæœ) ---
            // setTimeout(() => {
            //     const mockData = { pass: false, feedback: "ï¼ˆé€™æ˜¯æ¸¬è©¦å›æ‡‰ï¼‰ä½ çš„çˆ­é»æœ‰é»å¤ªå»£æ³›äº†ï¼Œè«‹èšç„¦åœ¨æ­£ç•¶é˜²è¡›çš„è¦ä»¶ä¸Šã€‚" };
            //     handleAIResponse(mockData);
            // }, 1000);
            // ----------------------------------------------------------------
            
        } finally {
            userInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = 'é€å‡º';
            userInput.focus();
        }
    }

    function handleAIResponse(data) {
        const isPass = data.pass;
        const feedbackClass = isPass ? 'feedback-pass' : 'feedback-fail';
        
        // é¡¯ç¤º AI å›é¥‹
        appendMessage(data.feedback, `ai-message ${feedbackClass}`);

        if (isPass) {
            // å¦‚æœé€šéï¼Œé€²å…¥ä¸‹ä¸€éšæ®µ
            if (currentStageIndex < stages.length - 1) {
                currentStageIndex++;
                updateProgressBar();
                // å»¶é²ä¸€ä¸‹å†é¡¯ç¤ºä¸‹ä¸€é—œçš„é¡Œç›®
                setTimeout(() => {
                    appendMessage(`âœ… éšæ®µå®Œæˆï¼æ¥ä¸‹ä¾†ï¼š<br>${stagePrompts[stages[currentStageIndex]]}`, 'ai-message');
                }, 800);
            } else {
                // å…¨éƒ¨å®Œæˆ
                setTimeout(() => {
                    appendMessage("ğŸ‰ å¤ªæ£’äº†ï¼ä½ å·²ç¶“å®Œæˆäº†å®Œæ•´çš„ IRAC æ³•å¾‹æ¨è«–éç¨‹ã€‚", 'ai-message feedback-pass');
                    // å¯ä»¥åœ¨é€™è£¡åŠ ä¸€å€‹ã€Œé‡æ–°é–‹å§‹ã€çš„æŒ‰éˆ•
                }, 800);
            }
        }
    }

    function appendMessage(htmlText, className) {
        const div = document.createElement('div');
        div.className = `message ${className}`;
        div.innerHTML = htmlText.replace(/\n/g, '<br>');
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight; // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
    }

    function updateProgressBar() {
        // æ›´æ–°ä¸Šæ–¹é€²åº¦æ¢æ¨£å¼
        const allSteps = document.querySelectorAll('.step');
        allSteps.forEach((step, index) => {
            step.classList.remove('active');
            if (index < currentStageIndex) {
                step.classList.add('completed');
            } else if (index === currentStageIndex) {
                step.classList.add('active');
            }
        });
    }
</script>

</body>
</html>