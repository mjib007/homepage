<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤ å¸å„€å°ˆç”¨ - æ¡Œæ¬¡æŸ¥è©¢èˆ‡çµ±è¨ˆåˆ†æ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --primary-light: #34495e;
            --accent: #3498db;
            --accent-light: #5dade2;
            --success: #27ae60;
            --warning: #f39c12;
            --error: #e74c3c;
            --info: #17a2b8;
            --surface: #ecf0f1;
            --surface-dark: #d5dbdb;
            --text: #2c3e50;
            --text-muted: #7f8c8d;
            --border: #bdc3c7;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--surface);
            color: var(--text);
            line-height: 1.6;
        }

        /* é ­éƒ¨å€åŸŸ */
        .header {
            background: white;
            padding: 30px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 2.2rem;
            font-weight: 900;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-light);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            color: var(--accent);
            border: 2px solid var(--accent);
        }

        .btn-outline:hover {
            background: var(--accent);
            color: white;
        }

        /* ä¸»è¦å®¹å™¨ */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        /* çµ±è¨ˆå¡ç‰‡ç¶²æ ¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-left: 4px solid var(--accent);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-card.success { border-left-color: var(--success); }
        .stat-card.warning { border-left-color: var(--warning); }
        .stat-card.error { border-left-color: var(--error); }
        .stat-card.info { border-left-color: var(--info); }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.7;
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 5px;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-number.success { color: var(--success); }
        .stat-number.warning { color: var(--warning); }
        .stat-number.error { color: var(--error); }
        .stat-number.info { color: var(--info); }
        .stat-number.primary { color: var(--accent); }

        .stat-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .stat-change {
            font-size: 0.9rem;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 12px;
            margin-top: 8px;
            display: inline-block;
        }

        .stat-change.positive {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }

        .stat-change.negative {
            background: rgba(231, 76, 60, 0.1);
            color: var(--error);
        }

        /* åœ–è¡¨å€åŸŸ */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .chart-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* æ¡Œæ¬¡åˆ†æ */
        .table-analysis {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 40px;
        }

        .table-grid-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .table-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .table-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .table-card.full {
            border-color: var(--success);
            background: rgba(39, 174, 96, 0.1);
        }

        .table-card.partial {
            border-color: var(--warning);
            background: rgba(243, 156, 18, 0.1);
        }

        .table-card.empty {
            border-color: var(--error);
            background: rgba(231, 76, 60, 0.1);
        }

        .table-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .table-occupancy {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .table-percentage {
            font-size: 1.2rem;
            font-weight: 700;
            margin-top: 5px;
        }

        .table-percentage.full { color: var(--success); }
        .table-percentage.partial { color: var(--warning); }
        .table-percentage.empty { color: var(--error); }

        /* æ¡Œæ¬¡è©³ç´°å±•ç¤ºé¢æ¿ï¼ˆæŠ•å½±è¢å¹•å°ˆç”¨ï¼‰ */
        .table-detail-panel {
            background: white;
            border-radius: 16px;
            margin: 30px 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            overflow: hidden;
            border: 3px solid var(--accent);
        }

        .table-detail-header {
            background: var(--accent);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-detail-header h2 {
            font-size: 2rem;
            font-weight: 900;
            margin: 0;
        }

        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .table-detail-stats {
            display: flex;
            padding: 30px;
            gap: 40px;
            background: var(--surface);
            border-bottom: 2px solid #eee;
        }

        .detail-stat {
            text-align: center;
            flex: 1;
        }

        .detail-stat .stat-number {
            display: block;
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
        }

        .detail-stat .stat-label {
            font-size: 1.1rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .table-detail-list {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .member-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 5px solid var(--border);
            transition: all 0.3s ease;
        }

        .member-card.present {
            border-left-color: var(--success);
            background: rgba(39, 174, 96, 0.05);
        }

        .member-card.absent {
            border-left-color: var(--error);
            background: rgba(231, 76, 60, 0.05);
        }

        .member-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .member-status.present {
            background: var(--success);
        }

        .member-status.absent {
            background: var(--error);
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
        }

        .member-details {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .member-checkin-time {
            font-size: 0.8rem;
            color: var(--success);
            font-family: 'JetBrains Mono', monospace;
            margin-top: 4px;
        }

        /* æ™‚é–“ç·šåˆ†æ */
        .timeline-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 40px;
        }

        .timeline-container {
            position: relative;
            height: 200px;
            margin-top: 20px;
        }

        /* è²´è³“çµ±è¨ˆ */
        .vip-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .vip-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .vip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--surface);
        }

        .vip-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .vip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--surface);
        }

        .vip-item:last-child {
            border-bottom: none;
        }

        .vip-name {
            font-weight: 600;
        }

        .vip-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .vip-status.present {
            background: var(--success);
            color: white;
        }

        .vip-status.absent {
            background: var(--border);
            color: var(--text-muted);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .chart-card {
                padding: 20px;
            }
            
            .table-grid-analysis {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        /* æ‰“å°æ¨£å¼ */
        @media print {
            .header-controls, .btn {
                display: none;
            }
            
            .chart-card, .stat-card {
                break-inside: avoid;
            }
        }

        /* è¼‰å…¥å‹•ç•« */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <header class="header">
        <div class="header-content">
            <h1 class="header-title">ğŸ¤ å¸å„€å°ˆç”¨ - æ¡Œæ¬¡æŸ¥è©¢èˆ‡çµ±è¨ˆ</h1>
            <div class="header-controls">
                <span id="lastUpdate" style="color: var(--text-muted); font-size: 0.9rem;"></span>
                <button class="btn btn-outline" onclick="exportData()">
                    ğŸ“Š åŒ¯å‡ºè³‡æ–™
                </button>
                <button class="btn btn-primary" onclick="refreshAllData()">
                    ğŸ”„ é‡æ–°æ•´ç†
                </button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card success">
                <div class="stat-header">
                    <div class="stat-icon">âœ…</div>
                </div>
                <div class="stat-number success" id="totalCheckedIn">0</div>
                <div class="stat-label">ç¸½å ±åˆ°äººæ•¸</div>
                <div class="stat-change positive" id="checkedInChange">+0</div>
            </div>

            <div class="stat-card info">
                <div class="stat-header">
                    <div class="stat-icon">ğŸ‘¥</div>
                </div>
                <div class="stat-number primary" id="totalAttendees">0</div>
                <div class="stat-label">ç¸½åƒèˆ‡äººæ•¸</div>
            </div>

            <div class="stat-card warning">
                <div class="stat-header">
                    <div class="stat-icon">â³</div>
                </div>
                <div class="stat-number warning" id="pendingCount">0</div>
                <div class="stat-label">æœªå ±åˆ°äººæ•¸</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">ğŸ“Š</div>
                </div>
                <div class="stat-number primary" id="attendanceRate">0%</div>
                <div class="stat-label">æ•´é«”å‡ºå¸­ç‡</div>
            </div>

            <div class="stat-card info">
                <div class="stat-header">
                    <div class="stat-icon">ğŸ‘‘</div>
                </div>
                <div class="stat-number primary" id="vipPresent">0</div>
                <div class="stat-label">è²´è³“å·²å ±åˆ°</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">ğŸ“</div>
                </div>
                <div class="stat-number primary" id="activeTableCount">0</div>
                <div class="stat-label">ä½¿ç”¨æ¡Œæ¬¡</div>
            </div>
        </div>

        <!-- åœ–è¡¨å€åŸŸ -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">
                    ğŸ“ˆ å ±åˆ°è¶¨å‹¢åœ–
                </div>
                <div class="chart-container">
                    <canvas id="checkinTrendChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">
                    ğŸ¥§ å‡ºå¸­ç‹€æ³åˆ†ä½ˆ
                </div>
                <div class="chart-container">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- æ¡Œæ¬¡åˆ†æ -->
        <div class="table-analysis">
            <div class="chart-title">
                ğŸ—‚ï¸ å„æ¡Œå‡ºå¸­åˆ†æ
            </div>
            <div class="table-grid-analysis" id="tableAnalysisGrid">
                <!-- å‹•æ…‹ç”Ÿæˆæ¡Œæ¬¡åˆ†æ -->
            </div>
        </div>

        <!-- æ¡Œæ¬¡è©³ç´°å±•ç¤ºå€åŸŸï¼ˆæŠ•å½±è¢å¹•å°ˆç”¨ï¼‰ -->
        <div class="table-detail-panel" id="tableDetailPanel" style="display: none;">
            <div class="table-detail-header">
                <h2 id="tableDetailTitle">C æ¡Œè©³ç´°åå–®</h2>
                <button class="close-btn" onclick="closeTableDetails()">âœ• é—œé–‰</button>
            </div>
            <div class="table-detail-stats" id="tableDetailStats">
                <div class="detail-stat">
                    <span class="stat-number" id="tableDetailPresent">0</span>
                    <span class="stat-label">å·²å ±åˆ°</span>
                </div>
                <div class="detail-stat">
                    <span class="stat-number" id="tableDetailTotal">0</span>
                    <span class="stat-label">ç¸½äººæ•¸</span>
                </div>
                <div class="detail-stat">
                    <span class="stat-number" id="tableDetailPercent">0%</span>
                    <span class="stat-label">å‡ºå¸­ç‡</span>
                </div>
            </div>
            <div class="table-detail-list" id="tableDetailList">
                <!-- å‹•æ…‹ç”Ÿæˆè©²æ¡Œæ¬¡çš„è©³ç´°æˆå“¡åå–® -->
            </div>
        </div>

        <!-- æ™‚é–“ç·šåˆ†æ -->
        <div class="timeline-card">
            <div class="chart-title">
                â° å ±åˆ°æ™‚é–“åˆ†ä½ˆ
            </div>
            <div class="chart-container">
                <canvas id="timelineChart"></canvas>
            </div>
        </div>

        <!-- è²´è³“çµ±è¨ˆ -->
        <div class="vip-stats">
            <div class="vip-card">
                <div class="vip-header">
                    <div class="chart-title">ğŸ‘‘ å·²å ±åˆ°è²´è³“</div>
                    <span id="vipPresentCount" style="background: var(--success); color: white; padding: 6px 12px; border-radius: 12px; font-size: 0.9rem;"></span>
                </div>
                <div class="vip-list" id="vipPresentList">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <div class="vip-card">
                <div class="vip-header">
                    <div class="chart-title">â³ æœªå ±åˆ°è²´è³“</div>
                    <span id="vipAbsentCount" style="background: var(--error); color: white; padding: 6px 12px; border-radius: 12px; font-size: 0.9rem;"></span>
                </div>
                <div class="vip-list" id="vipAbsentList">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®šå€¼
        const API_BASE_URL = 'https://mjib007.zeabur.app/webhook';
        const REFRESH_INTERVAL = 15000; // 15ç§’è‡ªå‹•é‡æ–°æ•´ç†
        
        let allData = [];
        let chartInstances = {};
        let refreshTimer;
        let lastDataCount = 0;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            refreshAllData();
            startAutoRefresh();
        });

        // é‡æ–°æ•´ç†æ‰€æœ‰è³‡æ–™
        async function refreshAllData() {
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE_URL}/get-all-attendees`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                allData = data.attendees || [];
                
                updateAllStats();
                updateCharts();
                updateTableAnalysis();
                updateVipLists();
                
                // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
                document.getElementById('lastUpdate').textContent = 
                    `æœ€å¾Œæ›´æ–°ï¼š${new Date().toLocaleTimeString('zh-TW')}`;
                
            } catch (error) {
                console.error('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—:', error);
                alert('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
            } finally {
                showLoading(false);
            }
        }

        // é¡¯ç¤º/éš±è—è¼‰å…¥å‹•ç•«
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        // æ›´æ–°æ‰€æœ‰çµ±è¨ˆæ•¸æ“š
        function updateAllStats() {
            const total = allData.length;
            const checkedIn = allData.filter(p => p.å ±åˆ°ç‹€æ…‹ === 'OK').length;
            const pending = total - checkedIn;
            const attendanceRate = total > 0 ? Math.round((checkedIn / total) * 100) : 0;
            
            const vipData = allData.filter(p => p.è²´è³“åå–® === 'TRUE');
            const vipPresent = vipData.filter(p => p.å ±åˆ°ç‹€æ…‹ === 'OK').length;
            
            const activeTables = new Set(allData.map(p => p.æ¡Œæ¬¡)).size;
            
            // æ›´æ–°çµ±è¨ˆå¡ç‰‡
            document.getElementById('totalCheckedIn').textContent = checkedIn;
            document.getElementById('totalAttendees').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('attendanceRate').textContent = `${attendanceRate}%`;
            document.getElementById('vipPresent').textContent = vipPresent;
            document.getElementById('activeTableCount').textContent = activeTables;
            
            // æ›´æ–°è®ŠåŒ–é‡
            const change = checkedIn - lastDataCount;
            const changeElement = document.getElementById('checkedInChange');
            if (change > 0) {
                changeElement.textContent = `+${change}`;
                changeElement.className = 'stat-change positive';
            } else if (change < 0) {
                changeElement.textContent = change;
                changeElement.className = 'stat-change negative';
            } else {
                changeElement.textContent = 'ç„¡è®ŠåŒ–';
                changeElement.className = 'stat-change';
            }
            
            lastDataCount = checkedIn;
        }

        // æ›´æ–°åœ–è¡¨
        function updateCharts() {
            updateCheckinTrendChart();
            updateAttendanceChart();
            updateTimelineChart();
        }

        // æ›´æ–°å ±åˆ°è¶¨å‹¢åœ–
        function updateCheckinTrendChart() {
            const ctx = document.getElementById('checkinTrendChart').getContext('2d');
            
            // æ¸…é™¤èˆŠåœ–è¡¨
            if (chartInstances.trend) {
                chartInstances.trend.destroy();
            }
            
            // æŒ‰å°æ™‚åˆ†çµ„çµ±è¨ˆå ±åˆ°æ•¸æ“š
            const hourlyData = {};
            const now = new Date();
            
            // åˆå§‹åŒ–24å°æ™‚æ•¸æ“š
            for (let i = 0; i < 24; i++) {
                hourlyData[i] = 0;
            }
            
            allData.forEach(person => {
                if (person.å ±åˆ°æ™‚é–“) {
                    const checkinTime = new Date(person.å ±åˆ°æ™‚é–“);
                    const hour = checkinTime.getHours();
                    hourlyData[hour]++;
                }
            });
            
            const labels = Object.keys(hourlyData).map(h => `${h}:00`);
            const data = Object.values(hourlyData);
            
            chartInstances.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å ±åˆ°äººæ•¸',
                        data: data,
                        borderColor: 'rgb(52, 152, 219)',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°å‡ºå¸­ç‹€æ³åœ“é¤…åœ–
        function updateAttendanceChart() {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            
            if (chartInstances.attendance) {
                chartInstances.attendance.destroy();
            }
            
            const total = allData.length;
            const checkedIn = allData.filter(p => p.å ±åˆ°ç‹€æ…‹ === 'OK').length;
            const pending = total - checkedIn;
            
            chartInstances.attendance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['å·²å ±åˆ°', 'æœªå ±åˆ°'],
                    datasets: [{
                        data: [checkedIn, pending],
                        backgroundColor: [
                            'rgb(39, 174, 96)',
                            'rgb(231, 76, 60)'
                        ],
                        borderWidth: 2,
                        borderColor: 'white'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°æ™‚é–“ç·šåœ–
        function updateTimelineChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (chartInstances.timeline) {
                chartInstances.timeline.destroy();
            }
            
            // æŒ‰å°æ™‚çµ±è¨ˆç´¯ç©å ±åˆ°æ•¸
            const hourlyData = {};
            for (let i = 0; i < 24; i++) {
                hourlyData[i] = 0;
            }
            
            allData.forEach(person => {
                if (person.å ±åˆ°æ™‚é–“) {
                    const checkinTime = new Date(person.å ±åˆ°æ™‚é–“);
                    const hour = checkinTime.getHours();
                    
                    // ç´¯ç©åˆ°è©²å°æ™‚ç‚ºæ­¢çš„å ±åˆ°æ•¸
                    for (let h = hour; h < 24; h++) {
                        hourlyData[h]++;
                    }
                }
            });
            
            const labels = Object.keys(hourlyData).map(h => `${h}:00`);
            const data = Object.values(hourlyData);
            
            chartInstances.timeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ç´¯ç©å ±åˆ°æ•¸',
                        data: data,
                        backgroundColor: 'rgba(23, 162, 184, 0.8)',
                        borderColor: 'rgb(23, 162, 184)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°æ¡Œæ¬¡åˆ†æ
        function updateTableAnalysis() {
            const tableAnalysisGrid = document.getElementById('tableAnalysisGrid');
            
            // çµ±è¨ˆå„æ¡Œæ•¸æ“š
            const tableData = {};
            allData.forEach(person => {
                const table = person.æ¡Œæ¬¡;
                if (!tableData[table]) {
                    tableData[table] = { total: 0, present: 0 };
                }
                tableData[table].total++;
                if (person.å ±åˆ°ç‹€æ…‹ === 'OK') {
                    tableData[table].present++;
                }
            });
            
            // æŒ‰æ¡Œæ¬¡æ’åº
            const sortedTables = Object.keys(tableData).sort();
            
            tableAnalysisGrid.innerHTML = sortedTables.map(table => {
                const data = tableData[table];
                const percentage = Math.round((data.present / data.total) * 100);
                
                let statusClass = 'empty';
                if (percentage === 100) statusClass = 'full';
                else if (percentage > 0) statusClass = 'partial';
                
                return `
                    <div class="table-card ${statusClass}" onclick="showTableDetails('${table}')">
                        <div class="table-name">${table} æ¡Œ</div>
                        <div class="table-occupancy">${data.present}/${data.total}</div>
                        <div class="table-percentage ${statusClass}">${percentage}%</div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°è²´è³“åˆ—è¡¨
        function updateVipLists() {
            const vipData = allData.filter(p => p.è²´è³“åå–® === 'TRUE');
            const vipPresent = vipData.filter(p => p.å ±åˆ°ç‹€æ…‹ === 'OK');
            const vipAbsent = vipData.filter(p => p.å ±åˆ°ç‹€æ…‹ !== 'OK');
            
            // æ›´æ–°è¨ˆæ•¸
            document.getElementById('vipPresentCount').textContent = vipPresent.length;
            document.getElementById('vipAbsentCount').textContent = vipAbsent.length;
            
            // æ›´æ–°å·²å ±åˆ°è²´è³“åˆ—è¡¨
            const presentList = document.getElementById('vipPresentList');
            if (vipPresent.length === 0) {
                presentList.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">æš«ç„¡å·²å ±åˆ°è²´è³“</div>';
            } else {
                presentList.innerHTML = vipPresent.map(person => `
                    <div class="vip-item">
                        <div>
                            <div class="vip-name">${person.å§“å}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${person.æ¡Œæ¬¡}æ¡Œ â€¢ ${person.å–®ä½}</div>
                        </div>
                        <div class="vip-status present">å·²å ±åˆ°</div>
                    </div>
                `).join('');
            }
            
            // æ›´æ–°æœªå ±åˆ°è²´è³“åˆ—è¡¨
            const absentList = document.getElementById('vipAbsentList');
            if (vipAbsent.length === 0) {
                absentList.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">æ‰€æœ‰è²´è³“çš†å·²å ±åˆ°</div>';
            } else {
                absentList.innerHTML = vipAbsent.map(person => `
                    <div class="vip-item">
                        <div>
                            <div class="vip-name">${person.å§“å}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${person.æ¡Œæ¬¡}æ¡Œ â€¢ ${person.å–®ä½}</div>
                        </div>
                        <div class="vip-status absent">æœªå ±åˆ°</div>
                    </div>
                `).join('');
            }
        }

        // åŒ¯å‡ºè³‡æ–™
        function exportData() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "ç·¨è™Ÿ,æ¡Œæ¬¡,å§“å,å–®ä½,è·ç¨±,è²´è³“åå–®,å ±åˆ°ç‹€æ…‹,å ±åˆ°æ™‚é–“\n" +
                allData.map(person => 
                    `${person.ç·¨è™Ÿ},${person.æ¡Œæ¬¡},${person.å§“å},${person.å–®ä½ || ''},${person.è·ç¨± || ''},${person.è²´è³“åå–® || 'FALSE'},${person.å ±åˆ°ç‹€æ…‹ || 'NONE'},${person.å ±åˆ°æ™‚é–“ || ''}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `æ´»å‹•çµ±è¨ˆ_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // é–‹å§‹è‡ªå‹•é‡æ–°æ•´ç†
        function startAutoRefresh() {
            refreshTimer = setInterval(refreshAllData, REFRESH_INTERVAL);
        }

        // åœæ­¢è‡ªå‹•é‡æ–°æ•´ç†
        function stopAutoRefresh() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
        }

        // é é¢å¯è¦‹æ€§è®ŠåŒ–è™•ç†
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                refreshAllData();
                startAutoRefresh();
            }
        });

        // é é¢é—œé–‰æ™‚æ¸…ç†
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
            Object.values(chartInstances).forEach(chart => {
                if (chart) chart.destroy();
            });
        });

        // é¡¯ç¤ºæ¡Œæ¬¡è©³ç´°è³‡è¨Šï¼ˆæŠ•å½±è¢å¹•å°ˆç”¨ï¼‰
        function showTableDetails(tableName) {
            const tableData = allData.filter(person => person.æ¡Œæ¬¡ === tableName);
            const presentCount = tableData.filter(person => person.å ±åˆ°ç‹€æ…‹ === 'OK').length;
            const totalCount = tableData.length;
            const percentage = totalCount > 0 ? Math.round((presentCount / totalCount) * 100) : 0;
            
            // æ›´æ–°æ¨™é¡Œå’Œçµ±è¨ˆ
            document.getElementById('tableDetailTitle').textContent = `${tableName} æ¡Œè©³ç´°åå–®`;
            document.getElementById('tableDetailPresent').textContent = presentCount;
            document.getElementById('tableDetailTotal').textContent = totalCount;
            document.getElementById('tableDetailPercent').textContent = `${percentage}%`;
            
            // ç”Ÿæˆæˆå“¡åˆ—è¡¨
            const memberList = tableData
                .sort((a, b) => {
                    // å·²å ±åˆ°çš„æ’åœ¨å‰é¢
                    if (a.å ±åˆ°ç‹€æ…‹ === 'OK' && b.å ±åˆ°ç‹€æ…‹ !== 'OK') return -1;
                    if (a.å ±åˆ°ç‹€æ…‹ !== 'OK' && b.å ±åˆ°ç‹€æ…‹ === 'OK') return 1;
                    return a.ç·¨è™Ÿ.localeCompare(b.ç·¨è™Ÿ);
                })
                .map(person => {
                    const isPresent = person.å ±åˆ°ç‹€æ…‹ === 'OK';
                    const checkinTime = person.å ±åˆ°æ™‚é–“ ? 
                        `âœ“ å ±åˆ°æ™‚é–“ï¼š${new Date(person.å ±åˆ°æ™‚é–“).toLocaleString('zh-TW')}` : '';
                    
                    return `
                        <div class="member-card ${isPresent ? 'present' : 'absent'}">
                            <div class="member-status ${isPresent ? 'present' : 'absent'}"></div>
                            <div class="member-info">
                                <div class="member-name">${person.å§“å}</div>
                                <div class="member-details">
                                    ç·¨è™Ÿï¼š${person.ç·¨è™Ÿ} | 
                                    ${person.è·ç¨± || 'æœªæä¾›'} | 
                                    ${person.å–®ä½ || 'æœªæä¾›'}
                                    ${person.è²´è³“åå–® === 'TRUE' ? ' | ğŸ‘‘ è²´è³“' : ''}
                                </div>
                                ${isPresent ? `<div class="member-checkin-time">${checkinTime}</div>` : 
                                    '<div style="color: var(--error); font-size: 0.9rem; margin-top: 4px;">æœªå ±åˆ°</div>'}
                            </div>
                        </div>
                    `;
                }).join('');
            
            document.getElementById('tableDetailList').innerHTML = memberList;
            
            // é¡¯ç¤ºé¢æ¿
            document.getElementById('tableDetailPanel').style.display = 'block';
            
            // æ»¾å‹•åˆ°è©³ç´°é¢æ¿
            document.getElementById('tableDetailPanel').scrollIntoView({ behavior: 'smooth' });
        }

        // é—œé–‰æ¡Œæ¬¡è©³ç´°è³‡è¨Š
        function closeTableDetails() {
            document.getElementById('tableDetailPanel').style.display = 'none';
        }
    </script>
</body>
</html>
