<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•å ±åˆ°ç³»çµ± - QR Code æƒæ</title>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 600px;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 16px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }

        .status-offline {
            background-color: #dc3545;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }
        
        #reader {
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 3px solid #667eea;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        #startBtn {
            background: #667eea;
            color: white;
        }
        
        #startBtn:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        #stopBtn {
            background: #dc3545;
            color: white;
            display: none;
        }
        
        #stopBtn:hover:not(:disabled) {
            background: #c82333;
        }

        .manual-entry {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        #manualInput {
            flex-grow: 1;
            padding: 15px;
            font-size: 16px;
            border-radius: 10px;
            border: 2px solid #ddd;
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            transition: border-color 0.3s;
        }

        #manualInput:focus {
            border-color: #667eea;
            outline: none;
        }

        #manualBtn {
            flex-shrink: 0;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: #28a745;
            color: white;
        }
        #manualBtn:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
        }

        .result {
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.5s;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result.success {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        
        .result.error {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }
        
        .result.duplicate {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }
        
        .result-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .result.success .result-title {
            color: #155724;
        }
        
        .result.error .result-title {
            color: #721c24;
        }
        
        .result.duplicate .result-title {
            color: #856404;
        }
        
        .result-detail {
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result.success .result-detail {
            color: #155724;
        }
        
        .result.error .result-detail {
            color: #721c24;
        }
        
        .result.duplicate .result-detail {
            color: #856404;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .connection-status {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }

        .retry-section {
            display: none;
            text-align: center;
            margin-top: 15px;
        }

        .retry-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .retry-btn:hover {
            background: #138496;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ« æ´»å‹•å ±åˆ°ç³»çµ±</h1>
            <p class="subtitle">è«‹æƒæåƒåŠ è€…çš„ QR Code</p>
        </div>

        <div id="connectionStatus" class="connection-status">
            <span class="status-indicator status-online"></span>
            ç³»çµ±é€£ç·šæ­£å¸¸
        </div>
        
        <div id="reader"></div>
        
        <div class="controls">
            <button id="startBtn" onclick="startScanning()">ğŸ“· é–‹å§‹æƒæ</button>
            <button id="stopBtn" onclick="stopScanning()">â¹ï¸ åœæ­¢æƒæ</button>
        </div>

        <div class="manual-entry">
            <input type="text" id="manualInput" placeholder="è«‹è¼¸å…¥å ±åˆ°ç·¨è™Ÿ" maxlength="50">
            <button id="manualBtn" onclick="manualCheckIn()">æ‰‹å‹•å ±åˆ°</button>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
        </div>
        
        <div id="result" class="result"></div>

        <div class="retry-section" id="retrySection">
            <button class="retry-btn" onclick="retryLastOperation()">é‡è©¦</button>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="successCount">0</div>
                <div class="stat-label">æˆåŠŸå ±åˆ°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="errorCount">0</div>
                <div class="stat-label">å¤±æ•—æ¬¡æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="duplicateCount">0</div>
                <div class="stat-label">é‡è¤‡å ±åˆ°</div>
            </div>
        </div>
    </div>

    <script>
        // âš™ï¸ è¨­å®šå€¼ - è«‹ä¿®æ”¹é€™è£¡
        const N8N_WEBHOOK_URL = 'https://kf0630.zeabur.app/webhook/qr-checkin';
        
        let html5QrCode;
        let isScanning = false;
        let stats = {
            success: 0,
            error: 0,
            duplicate: 0
        };
        let lastOperationData = null; // å„²å­˜æœ€å¾Œä¸€æ¬¡æ“ä½œè³‡æ–™ç”¨æ–¼é‡è©¦
        let connectionStatus = true;

        // æª¢æŸ¥é€£ç·šç‹€æ…‹
        async function checkConnection() {
            try {
                const response = await fetch(N8N_WEBHOOK_URL.replace('qr-checkin', 'health-check'), {
                    method: 'GET',
                    timeout: 5000
                });
                updateConnectionStatus(true);
            } catch (error) {
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(isOnline) {
            connectionStatus = isOnline;
            const statusEl = document.getElementById('connectionStatus');
            const indicator = statusEl.querySelector('.status-indicator');
            
            if (isOnline) {
                statusEl.innerHTML = '<span class="status-indicator status-online"></span>ç³»çµ±é€£ç·šæ­£å¸¸';
                statusEl.style.backgroundColor = '#d4edda';
                statusEl.style.color = '#155724';
            } else {
                statusEl.innerHTML = '<span class="status-indicator status-offline"></span>ç³»çµ±é€£ç·šç•°å¸¸';
                statusEl.style.backgroundColor = '#f8d7da';
                statusEl.style.color = '#721c24';
            }
        }

        // é˜²æŠ–è™•ç†
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function startScanning() {
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrCode = new Html5Qrcode("reader");
            
            document.getElementById('startBtn').disabled = true;
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanError
            ).then(() => {
                isScanning = true;
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'block';
            }).catch(err => {
                document.getElementById('startBtn').disabled = false;
                showResult('error', 'ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ', 'è«‹ç¢ºèªå·²æˆæ¬Šç›¸æ©Ÿæ¬Šé™ä¸¦é‡æ–°æ•´ç†é é¢');
                console.error('ç›¸æ©Ÿå•Ÿå‹•éŒ¯èª¤:', err);
            });
        }

        function stopScanning() {
            if (html5QrCode && isScanning) {
                document.getElementById('stopBtn').disabled = true;
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    document.getElementById('startBtn').style.display = 'block';
                    document.getElementById('stopBtn').style.display = 'none';
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = false;
                }).catch(err => {
                    document.getElementById('stopBtn').disabled = false;
                    console.error('åœæ­¢æƒæéŒ¯èª¤:', err);
                });
            }
        }

        const debouncedScanSuccess = debounce(async (decodedText) => {
            let qrData;
            try {
                // è§£æ QR Code è³‡æ–™
                qrData = JSON.parse(decodedText);
            } catch {
                // å¦‚æœä¸æ˜¯ JSONï¼Œå‡è¨­æ˜¯å ±åˆ°ç·¨è™Ÿ
                qrData = { å ±åˆ°ç·¨è™Ÿ: decodedText };
            }

            lastOperationData = qrData;
            await processCheckIn(qrData);

            // 3 ç§’å¾Œè‡ªå‹•ç¹¼çºŒæƒæ
            setTimeout(() => {
                if (html5QrCode && isScanning) {
                    html5QrCode.resume();
                }
            }, 3000);
        }, 1000);

        async function onScanSuccess(decodedText) {
            // æš«åœæƒæï¼Œé¿å…é‡è¤‡
            if (html5QrCode && isScanning) {
                await html5QrCode.pause();
            }

            debouncedScanSuccess(decodedText);
        }

        // æ‰‹å‹•å ±åˆ°å‡½æ•¸
        async function manualCheckIn() {
            const inputValue = document.getElementById('manualInput').value;

            if (!inputValue || inputValue.trim() === '') {
                showResult('error', 'è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥å ±åˆ°ç·¨è™Ÿ');
                playSound('error');
                return;
            }

            // é˜²æ­¢é‡è¤‡æäº¤
            document.getElementById('manualBtn').disabled = true;

            // æ‰‹å‹•è¼¸å…¥çš„è³‡æ–™
            const postData = { å ±åˆ°ç·¨è™Ÿ: inputValue.trim() };
            lastOperationData = postData;
            
            await processCheckIn(postData);

            // æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦é‡æ–°å•Ÿç”¨æŒ‰éˆ•
            document.getElementById('manualInput').value = '';
            document.getElementById('manualBtn').disabled = false;
        }

        // é‡è©¦åŠŸèƒ½
        async function retryLastOperation() {
            if (lastOperationData) {
                await processCheckIn(lastOperationData);
            }
        }

        // å…±ç”¨è™•ç†å‡½æ•¸
        async function processCheckIn(postData) {
            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';
            document.getElementById('retrySection').style.display = 'none';

            try {
                console.log('æ­£åœ¨ç™¼é€è³‡æ–™:', postData);
                console.log('ç›®æ¨™ URL:', N8N_WEBHOOK_URL);
                
                // è¨­å®šè«‹æ±‚è¶…æ™‚
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ™‚

                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(postData),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                }

                const result = await response.json();
                
                console.log('===== æ”¶åˆ°å®Œæ•´å›æ‡‰ =====');
                console.log('å®Œæ•´ result ç‰©ä»¶:', result);
                console.log('========================');

                // éš±è—è¼‰å…¥å‹•ç•«
                document.getElementById('loading').style.display = 'none';
                updateConnectionStatus(true);

                // é¡¯ç¤ºçµæœ
                if (result.status === 'success') {
                    stats.success++;
                    showResult(
                        'success',
                        'âœ… å ±åˆ°æˆåŠŸï¼',
                        `ç·¨è™Ÿï¼š${result.å ±åˆ°ç·¨è™Ÿ || result.å ±åˆ°ç·¨è™Ÿ || 'N/A'}\n` +
                        `å§“åï¼š${result.å§“å || 'æœªæä¾›'}\n` +
                        `å–®ä½ï¼š${result.å–®ä½ || 'æœªæä¾›'}\n` +
                        `æ™‚é–“ï¼š${result.å ±åˆ°æ™‚é–“ || new Date().toLocaleString('zh-TW')}`
                    );
                    playSound('success');
                } else if (result.status === 'duplicate') {
                    stats.duplicate++;
                    showResult(
                        'duplicate',
                        'âš ï¸ é‡è¤‡å ±åˆ°',
                        `ç·¨è™Ÿï¼š${result.å ±åˆ°ç·¨è™Ÿ || result.å ±åˆ°ç·¨è™Ÿ || 'N/A'}\n` +
                        `å§“åï¼š${result.å§“å || 'æœªæä¾›'}\n` +
                        `å–®ä½ï¼š${result.å–®ä½ || 'æœªæä¾›'}\n` +
                        `ä¸Šæ¬¡å ±åˆ°ï¼š${result.å ±åˆ°æ™‚é–“ || 'æœªè¨˜éŒ„'}`
                    );
                    playSound('duplicate');
                } else {
                    stats.error++;
                    showResult(
                        'error',
                        'âŒ å ±åˆ°å¤±æ•—',
                        result.message || 'æŸ¥ç„¡æ­¤å ±åˆ°è³‡æ–™ï¼Œè«‹ç¢ºèªè³‡æ–™æ˜¯å¦æ­£ç¢º'
                    );
                    playSound('error');
                    document.getElementById('retrySection').style.display = 'block';
                }

                updateStats();

            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                stats.error++;
                
                let errorMessage = 'ç³»çµ±æš«æ™‚ç„¡æ³•ä½¿ç”¨';
                if (error.name === 'AbortError') {
                    errorMessage = 'è«‹æ±‚è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯';
                    updateConnectionStatus(false);
                } else {
                    errorMessage = `ç³»çµ±éŒ¯èª¤: ${error.message}`;
                }
                
                showResult('error', 'âŒ ç³»çµ±éŒ¯èª¤', errorMessage);
                updateStats();
                playSound('error');
                document.getElementById('retrySection').style.display = 'block';
                console.error('è«‹æ±‚éŒ¯èª¤:', error);
            }
        }

        function onScanError(errorMessage) {
            // æƒæéŒ¯èª¤ï¼ˆä¸€èˆ¬å¯å¿½ç•¥ï¼‰
        }

        function showResult(type, title, detail) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `
                <div class="result-title">${title}</div>
                <div class="result-detail">${detail.replace(/\n/g, '<br>')}</div>
            `;
            resultDiv.style.display = 'block';

            // è‡ªå‹•éš±è—çµæœï¼ˆé™¤äº†éŒ¯èª¤ï¼‰
            if (type !== 'error') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 5000);
            }
        }

        function updateStats() {
            document.getElementById('successCount').textContent = stats.success;
            document.getElementById('errorCount').textContent = stats.error;
            document.getElementById('duplicateCount').textContent = stats.duplicate;
        }

        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                if (type === 'success') {
                    oscillator.frequency.value = 800;
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                } else if (type === 'duplicate') {
                    oscillator.frequency.value = 600;
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                } else {
                    oscillator.frequency.value = 400;
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                }

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (error) {
                console.log('ç„¡æ³•æ’­æ”¾éŸ³æ•ˆ:', error);
            }
        }

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && document.getElementById('manualInput') === document.activeElement) {
                manualCheckIn();
            }
        });

        // é é¢é—œé–‰æ™‚åœæ­¢æƒæ
        window.addEventListener('beforeunload', () => {
            if (html5QrCode && isScanning) {
                html5QrCode.stop();
            }
        });

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥é€£ç·š
        window.addEventListener('load', () => {
            checkConnection();
            // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡é€£ç·šç‹€æ…‹
            setInterval(checkConnection, 60000);
        });

        // é é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚çš„è™•ç†
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // é é¢éš±è—æ™‚æš«åœæƒæ
                if (html5QrCode && isScanning) {
                    html5QrCode.pause();
                }
            } else {
                // é é¢æ¢å¾©æ™‚ç¹¼çºŒæƒæ
                if (html5QrCode && isScanning) {
                    html5QrCode.resume();
                }
                checkConnection();
            }
        });
    </script>
</body>
</html>