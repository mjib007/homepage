<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Â†±Âà∞Á≥ªÁµ±Ê∏¨Ë©¶Áâà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 40px;
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .test-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        #testInput {
            flex: 1;
            padding: 15px 20px;
            font-size: 1.1rem;
            background: white;
            border: 2px solid #ddd;
            border-radius: 12px;
            color: #333;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 1px;
            text-transform: uppercase;
            text-align: center;
        }
        
        #testInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .test-btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #667eea;
            color: white;
        }
        
        .test-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .test-btn:active {
            transform: translateY(0);
        }
        
        .result-area {
            margin-top: 30px;
            min-height: 100px;
        }
        
        .result {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid;
            text-align: left;
        }
        
        .result.success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        
        .result.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        
        .result-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .result-detail {
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .test-examples {
            background: #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .example-title {
            font-weight: 700;
            margin-bottom: 15px;
            color: #495057;
        }
        
        .example-codes {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .example-code {
            background: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .example-code:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }
        
        .debug-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: #6c757d;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .api-test {
            background: #fff3cd;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-testing { background: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Â†±Âà∞Á≥ªÁµ±Ê∏¨Ë©¶</h1>
        <p class="subtitle">Ê∏¨Ë©¶Âü∫Êú¨ÂäüËÉΩÂíå API ÈÄ£Á∑ö</p>
        
        <!-- API ÈÄ£Á∑öÊ∏¨Ë©¶ -->
        <div class="api-test">
            <div class="api-status">
                <div class="status-dot status-testing" id="statusDot"></div>
                <span id="statusText">Ê≠£Âú®Ê™¢Ê∏¨ API ÈÄ£Á∑ö...</span>
            </div>
            <div style="font-size: 0.9rem; color: #856404;" id="apiUrl">
                Ê∏¨Ë©¶ URL: https://kf0630.zeabur.app/webhook/checkin
            </div>
        </div>
        
        <!-- ÊâãÂãïËº∏ÂÖ•Ê∏¨Ë©¶ -->
        <div class="test-section">
            <h3 class="test-title">üìù ÊâãÂãïËº∏ÂÖ•Ê∏¨Ë©¶</h3>
            
            <div class="input-group">
                <input 
                    type="text" 
                    id="testInput" 
                    placeholder="A001" 
                    maxlength="4"
                >
                <button class="test-btn" onclick="testManualInput()">
                    Ê∏¨Ë©¶Â†±Âà∞
                </button>
            </div>
            
            <div class="test-examples">
                <div class="example-title">ÈªûÊìäÂø´ÈÄüÊ∏¨Ë©¶Ôºö</div>
                <div class="example-codes">
                    <span class="example-code" onclick="fillInput('A001')">A001</span>
                    <span class="example-code" onclick="fillInput('A002')">A002</span>
                    <span class="example-code" onclick="fillInput('B001')">B001</span>
                    <span class="example-code" onclick="fillInput('C001')">C001</span>
                    <span class="example-code" onclick="fillInput('TEST')">TEST</span>
                </div>
            </div>
        </div>
        
        <!-- ÁµêÊûúÈ°ØÁ§∫ÂçÄ -->
        <div class="result-area" id="resultArea">
            <div class="result info">
                <div class="result-title">üîç Á≥ªÁµ±ÁãÄÊÖã</div>
                <div class="result-detail">Á≠âÂæÖÊ∏¨Ë©¶Ëº∏ÂÖ•...</div>
            </div>
        </div>
        
        <!-- ÂÅµÈåØË≥áË®ä -->
        <div class="debug-info" id="debugInfo">
            <strong>ÂÅµÈåØÊó•Ë™åÔºö</strong><br>
            [Á≥ªÁµ±] Ê∏¨Ë©¶ÁâàÊú¨Â∑≤ËºâÂÖ•
        </div>
    </div>

    <script>
        // Ê∏¨Ë©¶Áî®ÁöÑ API URL
        const TEST_API_URL = 'https://kf0630.zeabur.app/webhook/checkin';
        
        // ÂÅµÈåØÊó•Ë™åÂáΩÊï∏
        function addDebugLog(message) {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            debugInfo.innerHTML += `<br>[${timestamp}] ${message}`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
        
        // Â°´ÂÖ•Ê∏¨Ë©¶Ë≥áÊñô
        function fillInput(value) {
            document.getElementById('testInput').value = value;
            addDebugLog(`Â°´ÂÖ•Ê∏¨Ë©¶Ë≥áÊñô: ${value}`);
        }
        
        // È©óË≠âÁ∑®ËôüÊ†ºÂºè
        function validateInput(input) {
            if (!input || input.length === 0) {
                return { valid: false, message: 'Ë´ãËº∏ÂÖ•Á∑®Ëôü' };
            }
            
            if (input.length < 4) {
                return { valid: false, message: 'Á∑®ËôüÈï∑Â∫¶‰∏çË∂≥' };
            }
            
            const pattern = /^[A-Z][0-9]{3}$/;
            if (!pattern.test(input)) {
                return { valid: false, message: 'Ê†ºÂºèÈåØË™§ÔºåÊáâÁÇ∫ A001 Ê†ºÂºè' };
            }
            
            return { valid: true, message: 'Ê†ºÂºèÊ≠£Á¢∫' };
        }
        
        // Ê∏¨Ë©¶ÊâãÂãïËº∏ÂÖ•
        async function testManualInput() {
            const input = document.getElementById('testInput').value.trim().toUpperCase();
            const resultArea = document.getElementById('resultArea');
            
            addDebugLog(`ÈñãÂßãÊ∏¨Ë©¶Ëº∏ÂÖ•: "${input}"`);
            
            // È©óË≠âÊ†ºÂºè
            const validation = validateInput(input);
            if (!validation.valid) {
                showResult('error', '‚ùå Ëº∏ÂÖ•È©óË≠âÂ§±Êïó', validation.message);
                addDebugLog(`È©óË≠âÂ§±Êïó: ${validation.message}`);
                return;
            }
            
            addDebugLog('Ê†ºÂºèÈ©óË≠âÈÄöÈÅéÔºåÊ∫ñÂÇôÁôºÈÄÅË´ãÊ±Ç');
            
            // È°ØÁ§∫ËºâÂÖ•ÁãÄÊÖã
            showResult('info', '‚è≥ ËôïÁêÜ‰∏≠...', 'Ê≠£Âú®ÁôºÈÄÅË´ãÊ±ÇÂà∞ API');
            
            try {
                const requestData = {
                    Á∑®Ëôü: input,
                    timestamp: new Date().toISOString(),
                    source: 'test-page'
                };
                
                addDebugLog(`Ë´ãÊ±ÇË≥áÊñô: ${JSON.stringify(requestData)}`);
                
                const startTime = Date.now();
                
                const response = await fetch(TEST_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                    signal: AbortSignal.timeout(15000) // 15ÁßíË∂ÖÊôÇ
                });
                
                const responseTime = Date.now() - startTime;
                addDebugLog(`Ë´ãÊ±ÇÂÆåÊàêÔºåËÄóÊôÇ: ${responseTime}ms`);
                addDebugLog(`HTTP ÁãÄÊÖã: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    addDebugLog(`ÈåØË™§ÂõûÊáâ: ${errorText}`);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                addDebugLog(`API ÂõûÊáâ: ${JSON.stringify(result, null, 2)}`);
                
                // ËôïÁêÜÂõûÊáâ
                if (result.status === 'success') {
                    showResult('success', '‚úÖ Â†±Âà∞ÊàêÂäüÔºÅ', 
                        `Á∑®ËôüÔºö${result.Á∑®Ëôü}\n` +
                        `ÂßìÂêçÔºö${result.ÂßìÂêç || 'Êú™Êèê‰æõ'}\n` +
                        `Ê°åÊ¨°Ôºö${result.Ê°åÊ¨° || 'Êú™Êèê‰æõ'}Ê°å\n` +
                        `ÊôÇÈñìÔºö${result.Â†±Âà∞ÊôÇÈñì || 'Êú™Ë®òÈåÑ'}`
                    );
                } else if (result.status === 'duplicate') {
                    showResult('info', '‚ö†Ô∏è ÈáçË§áÂ†±Âà∞', 
                        `Á∑®ËôüÔºö${result.Á∑®Ëôü}\n` +
                        `ÂßìÂêçÔºö${result.ÂßìÂêç || 'Êú™Êèê‰æõ'}\n` +
                        `‰∏äÊ¨°Â†±Âà∞Ôºö${result.Â†±Âà∞ÊôÇÈñì || 'Êú™Ë®òÈåÑ'}`
                    );
                } else {
                    showResult('error', '‚ùå Â†±Âà∞Â§±Êïó', 
                        result.message || 'Êü•ÁÑ°Ê≠§Á∑®ËôüË≥áÊñô'
                    );
                }
                
                updateApiStatus(true);
                
            } catch (error) {
                addDebugLog(`Ë´ãÊ±ÇÂ§±Êïó: ${error.message}`);
                
                let errorMessage = 'Êú™Áü•ÈåØË™§';
                if (error.name === 'TimeoutError') {
                    errorMessage = 'Ë´ãÊ±ÇË∂ÖÊôÇÔºà15ÁßíÔºâÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'ÁÑ°Ê≥ïÈÄ£Êé•Âà∞‰º∫ÊúçÂô®ÔºåË´ãÊ™¢Êü• API ÊòØÂê¶ÈÅãË°å';
                } else {
                    errorMessage = error.message;
                }
                
                showResult('error', 'üîå ÈÄ£Á∑öÈåØË™§', errorMessage);
                updateApiStatus(false);
            }
        }
        
        // È°ØÁ§∫ÁµêÊûú
        function showResult(type, title, detail) {
            const resultArea = document.getElementById('resultArea');
            resultArea.innerHTML = `
                <div class="result ${type}">
                    <div class="result-title">${title}</div>
                    <div class="result-detail">${detail.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        }
        
        // Êõ¥Êñ∞ API ÁãÄÊÖã
        function updateApiStatus(isOnline) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (isOnline) {
                statusDot.className = 'status-dot status-online';
                statusText.textContent = 'API ÈÄ£Á∑öÊ≠£Â∏∏';
            } else {
                statusDot.className = 'status-dot status-offline';
                statusText.textContent = 'API ÈÄ£Á∑öÁï∞Â∏∏';
            }
        }
        
        // Ê∏¨Ë©¶ API ÈÄ£Á∑ö
        async function testApiConnection() {
            addDebugLog('ÈñãÂßãÊ∏¨Ë©¶ API ÈÄ£Á∑ö');
            
            try {
                const response = await fetch(TEST_API_URL.replace('/checkin', '/health'), {
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                
                updateApiStatus(true);
                addDebugLog('API ÈÄ£Á∑öÊ∏¨Ë©¶ÊàêÂäü');
                
            } catch (error) {
                updateApiStatus(false);
                addDebugLog(`API ÈÄ£Á∑öÊ∏¨Ë©¶Â§±Êïó: ${error.message}`);
            }
        }
        
        // Ëº∏ÂÖ•Ê†ºÂºèÂåñ
        document.getElementById('testInput').addEventListener('input', function(e) {
            let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            
            // ÈôêÂà∂Ê†ºÂºèÔºöÁ¨¨‰∏ÄÂÄãÂ≠óÁ¨¶ÂøÖÈ†àÊòØÂ≠óÊØçÔºåÂæå‰∏âÂÄãÊòØÊï∏Â≠ó
            if (value.length > 0) {
                const firstChar = value.charAt(0);
                const restChars = value.slice(1).replace(/[^0-9]/g, '');
                value = firstChar + restChars;
            }
            
            if (value.length > 4) {
                value = value.slice(0, 4);
            }
            
            e.target.value = value;
            
            // Âç≥ÊôÇÈ©óË≠â
            if (value.length > 0) {
                const validation = validateInput(value);
                if (validation.valid) {
                    e.target.style.borderColor = '#28a745';
                } else {
                    e.target.style.borderColor = '#dc3545';
                }
            } else {
                e.target.style.borderColor = '#ddd';
            }
        });
        
        // Enter ÈçµÊ∏¨Ë©¶
        document.getElementById('testInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                testManualInput();
            }
        });
        
        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂàùÂßãÂåñ
        window.addEventListener('load', function() {
            addDebugLog('Ê∏¨Ë©¶È†ÅÈù¢ËºâÂÖ•ÂÆåÊàê');
            testApiConnection();
            
            // Ëá™ÂãïÂ°´ÂÖ•ÁØÑ‰æã
            setTimeout(() => {
                fillInput('A001');
            }, 1000);
        });
        
        // ÊØè30ÁßíÊ∏¨Ë©¶‰∏ÄÊ¨°ÈÄ£Á∑ö
        setInterval(testApiConnection, 30000);
    </script>
</body>
</html>