<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRAC æ³•å¾‹æ€ç¶­å°èˆªå„€</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #c0392b;
            --success-color: #27ae60;
            --info-color: #3498db;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
        }

        body {
            font-family: "Helvetica Neue", Arial, "PingFang TC", "Heiti TC", sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h1 { margin: 0; font-size: 1.5rem; }
        .subtitle { font-size: 0.9rem; opacity: 0.8; }

        /* Main Layout */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Left Panel: Case Facts */
        .left-panel {
            width: 35%;
            background-color: #eef2f5;
            padding: 2rem;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }

        .case-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            line-height: 1.8;
        }

        .case-title {
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--accent-color);
            display: inline-block;
            padding-bottom: 5px;
        }

        /* åƒè€ƒç¯„ä¾‹æŒ‰éˆ•æ¨£å¼ */
        .example-button {
            background: var(--info-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95rem;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .example-button:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .example-content {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 8px;
            border-left: 4px solid var(--info-color);
        }

        .example-content h4 {
            color: var(--primary-color);
            margin-top: 0;
        }

        .example-text {
            color: #27ae60;
            font-style: italic;
            line-height: 1.8;
            font-size: 0.9rem;
        }

        /* ç·´ç¿’æ¨¡å¼æ¨™ç¤º */
        .practice-mode-indicator {
            display: none;
            background: #f39c12;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin: 10px 0;
            text-align: center;
        }

        /* Right Panel: Interaction */
        .right-panel {
            width: 65%;
            display: flex;
            flex-direction: column;
            padding: 0;
            background: white;
        }

        /* Progress Bar */
        .progress-bar {
            display: flex;
            justify-content: space-around;
            padding: 1.5rem;
            background: #fff;
            border-bottom: 1px solid #eee;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.4;
            transition: all 0.3s;
            position: relative;
            flex: 1;
        }

        .step.active { opacity: 1; font-weight: bold; color: var(--primary-color); }
        .step.completed { opacity: 1; color: var(--success-color); }
        
        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #ccc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .step.active .step-circle { background: var(--primary-color); transform: scale(1.1); }
        .step.completed .step-circle { background: var(--success-color); }

        /* Chat Area */
        .chat-history {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            max-width: 80%;
            padding: 1rem;
            border-radius: 12px;
            line-height: 1.6;
            position: relative;
        }

        .ai-message {
            align-self: flex-start;
            background-color: #f0f4f8;
            color: #2c3e50;
            border-left: 4px solid var(--primary-color);
        }
        
        .ai-message.feedback-fail {
            background-color: #fff5f5;
            border-left-color: var(--accent-color);
        }

        .ai-message.feedback-pass {
            background-color: #e8f8f5;
            border-left-color: var(--success-color);
        }

        .ai-message.hint {
            background-color: #fff9e6;
            border-left-color: #f39c12;
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
        }

        /* Input Area */
        .input-area {
            padding: 2rem;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        textarea {
            flex: 1;
            padding: 1rem;
            border: 2px solid #eee;
            border-radius: 8px;
            resize: none;
            font-size: 1rem;
            height: 60px;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        button {
            padding: 0 2rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover { background-color: #34495e; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* ç·´ç¿’æ¨¡å¼æŒ‰éˆ• */
        .practice-button {
            background: #f39c12;
            padding: 0 1.5rem;
        }

        .practice-button:hover {
            background: #e67e22;
        }

        /* Loading dots */
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

    </style>
</head>
<body>

<header>
    <div>
        <h1>IRAC æ³•å¾‹æ€ç¶­å°èˆªå„€</h1>
        <span class="subtitle">AI-Powered Legal Reasoning Trainer</span>
    </div>
    <div style="font-size: 0.9rem;">èª²ç¨‹ï¼šæ³•å¾‹èˆ‡äººå·¥æ™ºæ…§</div>
</header>

<div class="container">
    <div class="left-panel">
        <div class="case-card">
            <div class="case-title">æ¡ˆä¾‹äº‹å¯¦ (Case Facts)</div>
            <p id="caseFactsText">
                ç”²ï¼ˆç”·ï¼Œ30æ­²ï¼‰èˆ‡ä¹™ï¼ˆç”·ï¼Œ28æ­²ï¼‰ç‚ºé„°å±…ï¼Œç´ æœ‰ç©æ€¨ã€‚æŸæ—¥æ™šé–“ï¼Œå…©äººåœ¨ç¤¾å€é–€å£ç›¸é‡ï¼Œç™¼ç”Ÿæ¿€çƒˆå£è§’ã€‚ä¹™çªç„¶å¾å£è¢‹æ‹¿å‡ºæŠ˜ç–Šåˆ€ï¼Œå°ç”²å«å›‚ï¼šã€Œä¿¡ä¸ä¿¡æˆ‘æ…æ­»ä½ ï¼ã€ä¸¦å‘ç”²é€¼è¿‘ã€‚
                <br><br>
                ç”²è¦‹ç‹€é©šæï¼Œéš¨æ‰‹æ‹¿èµ·è·¯é‚Šçš„ç£šé ­ä¸Ÿå‘ä¹™ã€‚ç£šé ­æ“Šä¸­ä¹™çš„é ­éƒ¨ï¼Œä¹™ç•¶å ´å€’åœ°ï¼Œé€é†«å¾Œå› é¡±å…§å‡ºè¡€ä¸æ²»æ­»äº¡ã€‚
                <br><br>
                è«‹ä¾æ“šä¸Šè¿°äº‹å¯¦ï¼Œåˆ†æç”²çš„åˆ‘äº‹è²¬ä»»ã€‚
            </p>
        </div>
        
        <!-- æ–°å¢ï¼šåƒè€ƒç¯„ä¾‹æŒ‰éˆ• -->
        <button class="example-button" onclick="toggleExample()">
            ğŸ“– æŸ¥çœ‹åƒè€ƒç¯„ä¾‹
        </button>
        
        <div id="exampleContent" class="example-content">
            <h4>ğŸ“ å„éšæ®µç­”é¡Œç¯„ä¾‹ï¼š</h4>
            
            <div style="margin-bottom: 15px;">
                <strong>Issue (çˆ­é»)ï¼š</strong>
                <p class="example-text">
                    ç”²çš„è¡Œç‚ºæ˜¯å¦ç¬¦åˆåˆ‘æ³•ç¬¬23æ¢ä¹‹æ­£ç•¶é˜²è¡›ï¼Ÿ
                </p>
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong>Rule (è¦å‰‡)ï¼š</strong>
                <p class="example-text">
                    åˆ‘æ³•ç¬¬277æ¢å‚·å®³ç½ªï¼šæ•…æ„å‚·å®³ä»–äººèº«é«”<br>
                    åˆ‘æ³•ç¬¬276æ¢éå¤±è‡´æ­»ç½ªï¼šéå¤±è‡´äººæ–¼æ­»<br>
                    åˆ‘æ³•ç¬¬23æ¢æ­£ç•¶é˜²è¡›ï¼šç¾åœ¨ä¸æ³•ä¾µå®³ã€é˜²è¡›è¡Œç‚ºã€å¿…è¦æ€§
                </p>
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong>Application (æ¶µæ”)ï¼š</strong>
                <p class="example-text">
                    å› ç‚ºã€ç”²åœ¨ä¹™æŒåˆ€å¨è„…ç”Ÿå‘½çš„ç·Šæ€¥ç‹€æ³ä¸‹ï¼Œå‡ºæ–¼ä¿è­·è‡ªå·±è€Œä¸Ÿæ“²ç£šé ­ã€‘ï¼Œ<br>
                    ç¬¦åˆã€æ­£ç•¶é˜²è¡›çš„é˜²è¡›æ„åœ–è¦ä»¶ã€‘ï¼Œ<br>
                    æ‰€ä»¥ã€ç”²ä¸»è§€ä¸Šå…·æœ‰é˜²è¡›æ„åœ–è€Œéå‚·å®³æ•…æ„ã€‘ã€‚<br><br>
                    
                    å› ç‚ºã€ä¹™æŒåˆ€é€¼è¿‘æ§‹æˆç¾åœ¨é€²è¡Œä¸­çš„ä¸æ³•ä¾µå®³ã€‘ï¼Œ<br>
                    ç¬¦åˆã€åˆ‘æ³•ç¬¬23æ¢æ­£ç•¶é˜²è¡›çš„æ™‚é–“è¦ä»¶ã€‘ï¼Œ<br>
                    æ‰€ä»¥ã€ç”²çš„é˜²è¡›è¡Œç‚ºæ™‚æ©Ÿæ­£ç•¶ã€‘ã€‚
                </p>
            </div>
            
            <div>
                <strong>Conclusion (çµè«–)ï¼š</strong>
                <p class="example-text">
                    ç”²çš„è¡Œç‚ºç¬¦åˆæ­£ç•¶é˜²è¡›ï¼Œé˜»å»é•æ³•ï¼Œä¸æ§‹æˆçŠ¯ç½ªã€‚
                </p>
            </div>
        </div>
        
        <div style="margin-top: 20px; color: #666; font-size: 0.85rem;">
            <p><strong>ğŸ’¡ è€å¸«çš„å°æç¤ºï¼š</strong></p>
            <ul>
                <li>è«‹ä¸è¦æ€¥è‘—åˆ¤æ–·æœ‰ç½ªç„¡ç½ªã€‚</li>
                <li>ä¾ç…§å³å´çš„å°èˆªï¼Œä¸€æ­¥ä¸€æ­¥å»ºç«‹è«–è­‰ã€‚</li>
                <li>AI å°‡æ“”ä»»ä½ çš„ã€Œè˜‡æ ¼æ‹‰åº•å°å¸«ã€ã€‚</li>
                <li>å¡é—œæ™‚å¯ä»¥é»æ“Šã€Œç·´ç¿’æ¨¡å¼ã€ç²å¾—æ›´å¤šæç¤ºã€‚</li>
            </ul>
        </div>
    </div>

    <div class="right-panel">
        <div class="progress-bar">
            <div class="step active" id="step-issue">
                <div class="step-circle">I</div>
                <span>çˆ­é» (Issue)</span>
            </div>
            <div class="step" id="step-rule">
                <div class="step-circle">R</div>
                <span>è¦å‰‡ (Rule)</span>
            </div>
            <div class="step" id="step-application">
                <div class="step-circle">A</div>
                <span>æ¶µæ” (Application)</span>
            </div>
            <div class="step" id="step-conclusion">
                <div class="step-circle">C</div>
                <span>çµè«– (Conclusion)</span>
            </div>
        </div>

        <!-- ç·´ç¿’æ¨¡å¼æŒ‡ç¤ºå™¨ -->
        <div id="practiceModeIndicator" class="practice-mode-indicator">
            ğŸ¯ ç·´ç¿’æ¨¡å¼é–‹å•Ÿä¸­ - AIæœƒæä¾›æ›´å¤šå¼•å°
        </div>

        <div class="chat-history" id="chatHistory">
            <div class="message ai-message">
                æ­¡è¿ä¾†åˆ°æ€ç¶­è¨“ç·´ã€‚æˆ‘å€‘å¾ç¬¬ä¸€æ­¥é–‹å§‹ï¼š<br><br>
                <strong>è«‹æŒ‡å‡ºæœ¬æ¡ˆæœ€æ ¸å¿ƒçš„æ³•å¾‹çˆ­é»ï¼ˆIssueï¼‰æ˜¯ä»€éº¼ï¼Ÿ</strong><br>
                ï¼ˆè«‹è©¦è‘—ç”¨å•å¥å½¢å¼æå‡ºï¼Œä¾‹å¦‚ï¼šç”²çš„è¡Œç‚ºæ˜¯å¦æ§‹æˆ...ï¼Ÿï¼‰
            </div>
        </div>

        <div class="input-area">
            <textarea id="userInput" placeholder="åœ¨æ­¤è¼¸å…¥ä½ çš„æƒ³æ³•..."></textarea>
            <button id="sendBtn" onclick="handleSubmit()">é€å‡º</button>
            <button class="practice-button" onclick="togglePracticeMode()">
                ğŸ¯ ç·´ç¿’æ¨¡å¼
            </button>
        </div>
    </div>
</div>

<script>
    // =================CONFIG=================
    const N8N_WEBHOOK_URL = "https://kf0630.zeabur.app/webhook/irac-tutor"; 
    // ========================================

    const stages = ['issue', 'rule', 'application', 'conclusion'];
    let currentStageIndex = 0;
    let attemptCount = 0;  // è¨˜éŒ„å˜—è©¦æ¬¡æ•¸
    let practiceMode = false;  // ç·´ç¿’æ¨¡å¼ç‹€æ…‹
    
    // éšæ®µæç¤ºèª
    const stagePrompts = {
        'issue': 'è«‹æŒ‡å‡ºæœ¬æ¡ˆæœ€æ ¸å¿ƒçš„æ³•å¾‹çˆ­é»ï¼ˆIssueï¼‰æ˜¯ä»€éº¼ï¼Ÿ',
        'rule': 'é‡å°ä½ æå‡ºçš„çˆ­é»ï¼Œæ³•å¾‹è¦ç¯„ï¼ˆRuleï¼‰æ˜¯ä»€éº¼ï¼Ÿè«‹åˆ—å‡ºå…·é«”çš„æ§‹æˆè¦ä»¶ã€‚',
        'application': 'ç¾åœ¨é€²è¡Œæ¶µæ”ï¼ˆApplicationï¼‰ã€‚è«‹å°‡æœ¬æ¡ˆäº‹å¯¦å¡«å…¥ä¸Šè¿°è¦ä»¶ä¸­ï¼Œä¸¦è«–è­‰ç‚ºä½•ç¬¦åˆï¼ˆæˆ–ä¸ç¬¦åˆï¼‰ã€‚',
        'conclusion': 'æœ€å¾Œï¼Œè«‹æ ¹æ“šä¸Šè¿°æ¨è«–ï¼Œçµ¦å‡ºç°¡æ½”çš„æ³•å¾‹çµè«–ï¼ˆConclusionï¼‰ã€‚'
    };

    // ç·´ç¿’æ¨¡å¼æç¤º
    const practiceHints = {
        'issue': [
            'æç¤ºï¼šæƒ³æƒ³ç”²çš„è¡Œç‚ºæ€§è³ªæ˜¯ä»€éº¼ï¼Ÿæ˜¯æ”»æ“Šé‚„æ˜¯é˜²è¡›ï¼Ÿ',
            'æç¤ºï¼šå¯ä»¥å•ã€Œç”²çš„è¡Œç‚ºæ˜¯å¦ç¬¦åˆæ­£ç•¶é˜²è¡›ï¼Ÿã€',
            'æç¤ºï¼šæˆ–å•ã€Œç”²æ˜¯å¦æ§‹æˆå‚·å®³è‡´æ­»ç½ªï¼Ÿã€'
        ],
        'rule': [
            'æç¤ºï¼šæƒ³æƒ³æœ‰å“ªäº›ç›¸é—œæ³•æ¢ï¼Ÿåˆ‘æ³•ç¬¬277æ¢ï¼Ÿç¬¬23æ¢ï¼Ÿ',
            'æç¤ºï¼šæ­£ç•¶é˜²è¡›çš„è¦ä»¶æ˜¯ä»€éº¼ï¼Ÿ',
            'æç¤ºï¼šåˆ—å‡ºã€Œç¾åœ¨ä¸æ³•ä¾µå®³ã€ã€Œé˜²è¡›è¡Œç‚ºã€ã€Œå¿…è¦æ€§ã€'
        ],
        'application': [
            'æç¤ºï¼šè¨˜å¾—ä½¿ç”¨ã€Œå› ç‚º...ç¬¦åˆ...æ‰€ä»¥ã€çš„å¥å‹',
            'æç¤ºï¼šå…ˆèªªæ˜ç”²çš„ä¸»è§€æ„åœ–ï¼ˆé˜²è¡›é‚„æ˜¯å‚·å®³ï¼Ÿï¼‰',
            'æç¤ºï¼šå†èªªæ˜å®¢è§€ä¸Šæ˜¯å¦ç¬¦åˆæ­£ç•¶é˜²è¡›çš„è¦ä»¶'
        ],
        'conclusion': [
            'æç¤ºï¼šæ ¹æ“šå‰é¢çš„åˆ†æï¼Œçµ¦å‡ºæ˜ç¢ºçµè«–',
            'æç¤ºï¼šç”²çš„è¡Œç‚ºæ˜¯å¦æ§‹æˆçŠ¯ç½ªï¼Ÿ',
            'æç¤ºï¼šå¦‚æœæ˜¯æ­£ç•¶é˜²è¡›ï¼Œçµè«–æ‡‰è©²æ˜¯ã€Œä¸æ§‹æˆçŠ¯ç½ªã€'
        ]
    };

    const chatHistory = document.getElementById('chatHistory');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const caseFacts = document.getElementById('caseFactsText').innerText;

    // Enter é€å‡º
    userInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSubmit();
        }
    });

    // åˆ‡æ›åƒè€ƒç¯„ä¾‹é¡¯ç¤º
    function toggleExample() {
        const example = document.getElementById('exampleContent');
        const button = document.querySelector('.example-button');
        
        if (example.style.display === 'none' || !example.style.display) {
            example.style.display = 'block';
            button.textContent = 'ğŸ“– éš±è—åƒè€ƒç¯„ä¾‹';
        } else {
            example.style.display = 'none';
            button.textContent = 'ğŸ“– æŸ¥çœ‹åƒè€ƒç¯„ä¾‹';
        }
    }

    // åˆ‡æ›ç·´ç¿’æ¨¡å¼
    function togglePracticeMode() {
        practiceMode = !practiceMode;
        const indicator = document.getElementById('practiceModeIndicator');
        const button = document.querySelector('.practice-button');
        
        if (practiceMode) {
            indicator.style.display = 'block';
            button.style.background = '#e67e22';
            appendMessage('ğŸ¯ ç·´ç¿’æ¨¡å¼å·²é–‹å•Ÿï¼æˆ‘æœƒæä¾›æ›´å¤šæç¤ºå¹«åŠ©ä½ å­¸ç¿’ã€‚', 'ai-message hint');
            
            // ç«‹å³çµ¦ä¸€å€‹æç¤º
            const hints = practiceHints[stages[currentStageIndex]];
            if (hints && hints[0]) {
                setTimeout(() => {
                    appendMessage(hints[0], 'ai-message hint');
                }, 500);
            }
        } else {
            indicator.style.display = 'none';
            button.style.background = '#f39c12';
            appendMessage('ç·´ç¿’æ¨¡å¼å·²é—œé–‰ã€‚', 'ai-message');
        }
    }

    async function handleSubmit() {
        const text = userInput.value.trim();
        if (!text) return;

        appendMessage(text, 'user-message');
        userInput.value = '';
        userInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.textContent = 'æ€è€ƒä¸­...';

        const payload = {
            student_input: text,
            current_stage: stages[currentStageIndex],
            case_facts: caseFacts,
            practice_mode: practiceMode  // å‚³é€ç·´ç¿’æ¨¡å¼ç‹€æ…‹
        };

        try {
            const response = await fetch(N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error('ç¶²è·¯é€£ç·šéŒ¯èª¤æˆ– n8n æœªå›æ‡‰');
            }

            const data = await response.json();
            handleAIResponse(data);

        } catch (error) {
            console.error(error);
            appendMessage("âš ï¸ ç³»çµ±é€£ç·šéŒ¯èª¤ã€‚è«‹æª¢æŸ¥ n8n Webhook URL æ˜¯å¦æ­£ç¢ºã€‚", "ai-message feedback-fail");
        } finally {
            userInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = 'é€å‡º';
            userInput.focus();
        }
    }

    function handleAIResponse(data) {
        const isPass = data.pass;
        const feedbackClass = isPass ? 'feedback-pass' : 'feedback-fail';
        
        appendMessage(data.feedback, `ai-message ${feedbackClass}`);

        // è™•ç†å¤±æ•—æƒ…æ³
        if (!isPass) {
            attemptCount++;
            
            // Application éšæ®µçš„é¡å¤–æç¤º
            if (currentStageIndex === 2 && attemptCount >= 2) {
                appendMessage(
                    `ğŸ’¡ <strong>é¡å¤–æç¤ºï¼š</strong><br>
                    è©¦è‘—é€™æ¨£çµ„ç¹”ä½ çš„ç­”æ¡ˆï¼š<br>
                    1. å…ˆèªªæ˜ç”²çš„ä¸»è§€å¿ƒæ…‹ï¼ˆé˜²è¡›æ„åœ–ï¼‰<br>
                    2. å†èªªæ˜ä¹™çš„è¡Œç‚ºï¼ˆç¾åœ¨ä¸æ³•ä¾µå®³ï¼‰<br>
                    3. æœ€å¾Œèªªæ˜é˜²è¡›æ‰‹æ®µæ˜¯å¦é©ç•¶<br>
                    <br>è¨˜å¾—ç”¨ã€Œå› ç‚º...ç¬¦åˆ...æ‰€ä»¥ã€çš„å¥å‹ï¼`, 
                    'ai-message hint'
                );
            }
            
            // ç·´ç¿’æ¨¡å¼ä¸‹çµ¦æ›´å¤šæç¤º
            if (practiceMode && attemptCount >= 1) {
                const hints = practiceHints[stages[currentStageIndex]];
                const hintIndex = Math.min(attemptCount, hints.length - 1);
                setTimeout(() => {
                    appendMessage(hints[hintIndex], 'ai-message hint');
                }, 1000);
            }
            
            // å¤±æ•—å¤ªå¤šæ¬¡è‡ªå‹•é€šéï¼ˆçµ¦å­¸ç”Ÿä¿¡å¿ƒï¼‰
            if (attemptCount >= 4) {
                setTimeout(() => {
                    appendMessage(
                        'ğŸ’ª çœ‹å¾—å‡ºä¾†ä½ å¾ˆåŠªåŠ›ï¼è®“æˆ‘å€‘å…ˆé€²å…¥ä¸‹ä¸€éšæ®µï¼Œä¹‹å¾Œå¯ä»¥å†å›ä¾†ç·´ç¿’ã€‚', 
                        'ai-message feedback-pass'
                    );
                    proceedToNextStage();
                }, 2000);
            }
        } else {
            // é€šéï¼é€²å…¥ä¸‹ä¸€éšæ®µ
            proceedToNextStage();
        }
    }

    function proceedToNextStage() {
        attemptCount = 0;  // é‡ç½®å˜—è©¦æ¬¡æ•¸
        
        if (currentStageIndex < stages.length - 1) {
            currentStageIndex++;
            updateProgressBar();
            
            setTimeout(() => {
                appendMessage(`âœ… éšæ®µå®Œæˆï¼æ¥ä¸‹ä¾†ï¼š<br>${stagePrompts[stages[currentStageIndex]]}`, 'ai-message');
                
                // ç·´ç¿’æ¨¡å¼ä¸‹è‡ªå‹•çµ¦æç¤º
                if (practiceMode) {
                    const hints = practiceHints[stages[currentStageIndex]];
                    if (hints && hints[0]) {
                        setTimeout(() => {
                            appendMessage(hints[0], 'ai-message hint');
                        }, 1000);
                    }
                }
            }, 800);
        } else {
            // å…¨éƒ¨å®Œæˆ
            setTimeout(() => {
                appendMessage("ğŸ‰ å¤ªæ£’äº†ï¼ä½ å·²ç¶“å®Œæˆäº†å®Œæ•´çš„ IRAC æ³•å¾‹æ¨è«–éç¨‹ã€‚", 'ai-message feedback-pass');
                
                // åŠ å…¥é‡æ–°é–‹å§‹æŒ‰éˆ•
                const resetBtn = document.createElement('button');
                resetBtn.textContent = 'ğŸ”„ é‡æ–°é–‹å§‹æ–°æ¡ˆä¾‹';
                resetBtn.style.marginTop = '20px';
                resetBtn.onclick = resetTraining;
                chatHistory.appendChild(resetBtn);
            }, 800);
        }
    }

    function appendMessage(htmlText, className) {
        const div = document.createElement('div');
        div.className = `message ${className}`;
        div.innerHTML = htmlText.replace(/\n/g, '<br>');
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function updateProgressBar() {
        const allSteps = document.querySelectorAll('.step');
        allSteps.forEach((step, index) => {
            step.classList.remove('active');
            if (index < currentStageIndex) {
                step.classList.add('completed');
            } else if (index === currentStageIndex) {
                step.classList.add('active');
            }
        });
    }

    // é‡æ–°é–‹å§‹è¨“ç·´
    function resetTraining() {
        currentStageIndex = 0;
        attemptCount = 0;
        chatHistory.innerHTML = '';
        updateProgressBar();
        
        appendMessage(
            'æ­¡è¿ä¾†åˆ°æ€ç¶­è¨“ç·´ã€‚æˆ‘å€‘å¾ç¬¬ä¸€æ­¥é–‹å§‹ï¼š<br><br>' +
            '<strong>è«‹æŒ‡å‡ºæœ¬æ¡ˆæœ€æ ¸å¿ƒçš„æ³•å¾‹çˆ­é»ï¼ˆIssueï¼‰æ˜¯ä»€éº¼ï¼Ÿ</strong><br>' +
            'ï¼ˆè«‹è©¦è‘—ç”¨å•å¥å½¢å¼æå‡ºï¼Œä¾‹å¦‚ï¼šç”²çš„è¡Œç‚ºæ˜¯å¦æ§‹æˆ...ï¼Ÿï¼‰',
            'ai-message'
        );
    }
</script>

</body>
</html>