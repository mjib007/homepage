<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>LinguaExpertç¬¬ä¸ƒä»£ç¿»è­¯æ©Ÿå™¨äºº - å«æœå°‹æ‘˜è¦åŠŸèƒ½</title>
  <style>
    body{font-family:'Microsoft JhengHei',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;margin:0}
    .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}
    .header{background:#2c3e50;color:#fff;padding:30px;text-align:center}
    .session-info{background:#34495e;color:#fff;padding:15px 30px;display:flex;justify-content:space-between;align-items:center}
    .notes-section{background:#f39c12;color:#fff;padding:15px 30px;display:flex;align-items:center;gap:15px}
    .notes-input{flex:1;padding:10px;border:none;border-radius:5px;font-size:16px}
    .notes-clear-btn{background:#e67e22;color:#fff;border:none;padding:10px 15px;border-radius:5px;cursor:pointer;font-size:14px;transition:background .3s}
    .notes-clear-btn:hover{background:#d35400}
    .control-panel{padding:30px;text-align:center;border-bottom:1px solid #eee}
    .button-group{display:flex;gap:20px;justify-content:center;align-items:center;flex-wrap:wrap}
    .btn{border:none;border-radius:10px;padding:15px 25px;font-size:16px;cursor:pointer;transition:all .3s;font-weight:bold}
    .btn-new-session{background:#27ae60;color:#fff}
    .record-btn{background:#e74c3c;color:#fff;border:none;border-radius:50px;width:120px;height:120px;font-size:16px;cursor:pointer;transition:all .3s}
    .record-btn.recording{background:#c0392b;animation:pulse 1.5s infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    .btn-generate{background:#8e44ad;color:#fff}
    .btn-generate:disabled{background:#bdc3c7;cursor:not-allowed}
    .status{margin-top:20px;font-size:18px;color:#666}
    .content-area{display:grid;grid-template-columns:1fr 1fr;gap:20px;padding:30px}
    .search-section{grid-column:1/-1;background:#f8f9fa;border-radius:15px;padding:20px;margin-bottom:20px}
    .search-controls{display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto auto;gap:15px;margin-bottom:15px;align-items:end}
    .search-input,.search-select{padding:10px;border:1px solid #ddd;border-radius:5px}
    .btn-search{background:#3498db;color:#fff;padding:10px 20px;border:none;border-radius:5px;cursor:pointer}
    .btn-search:hover{background:#2980b9}
    .btn-summarize{background:#e67e22;color:#fff;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-weight:bold}
    .btn-summarize:hover{background:#d35400}
    .btn-summarize:disabled{background:#bdc3c7;cursor:not-allowed}
    .section{background:#f8f9fa;border-radius:15px;padding:20px;min-height:400px}
    .section-title{font-size:18px;font-weight:bold;margin-bottom:15px;color:#2c3e50;border-bottom:2px solid #3498db;padding-bottom:5px}
    .translation-item{background:#fff;padding:15px;margin-bottom:15px;border-radius:10px;border-left:4px solid #3498db}
    .notes-display{background:#fff3cd;color:#856404;padding:8px 12px;border-radius:5px;margin-bottom:8px;font-size:14px;border:1px solid #ffeaa7}
    .search-result-item{background:#fff;padding:15px;margin-bottom:10px;border-radius:5px;border-left:3px solid #3498db}
    .search-summary-section{background:#e8f5e8;border:2px solid #27ae60;border-radius:10px;padding:20px;margin-top:20px;display:none}
    .search-summary-title{font-size:18px;font-weight:bold;color:#27ae60;margin-bottom:15px;display:flex;align-items:center;gap:10px}
    .search-summary-content{background:#fff;padding:15px;border-radius:8px;white-space:pre-wrap;line-height:1.6;border:1px solid #27ae60}
    .search-stats{background:#fff;padding:10px 15px;border-radius:5px;margin-bottom:15px;border:1px solid #ddd;font-size:14px;color:#666}
    .empty-state{text-align:center;color:#7f8c8d;padding:40px 20px;font-style:italic}
    .loading{display:none;text-align:center;padding:20px}
    .error{color:#e74c3c;background:#fdf2f2;padding:15px;border-radius:5px;margin-top:10px;display:none}
    .spinner{border:3px solid #f3f3f3;border-top:3px solid #3498db;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;display:inline-block;margin-right:10px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    @media (max-width:768px){
      .content-area{grid-template-columns:1fr}
      .search-controls{display:flex;flex-direction:column;gap:10px;align-items:stretch}
      .search-input,.search-select,.btn-search,.btn-summarize{width:100%;box-sizing:border-box}
      .btn-search,.btn-summarize{padding:15px 20px;font-size:18px}
      .session-info{flex-direction:column;text-align:center;gap:10px}
      .notes-section{flex-direction:column;gap:10px}
      .button-group{flex-direction:column;align-items:center}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>LinguaExpertç¬¬ä¸ƒä»£ç¿»è­¯æ©Ÿå™¨äºº</h1>
      <p>å³æ™‚èªéŸ³ç¿»è­¯ ï¼† æ™ºèƒ½åˆ†æç³»çµ± - æœå°‹å…§å®¹ä¸€éµæ‘˜è¦0919</p>
    </div>

    <div class="session-info">
      <div>ç•¶å‰æœƒè©±ï¼š<span id="currentSession">ç­‰å¾…åˆå§‹åŒ–</span></div>
      <div>è¨˜éŒ„æ•¸ï¼š<span id="recordCount">0</span></div>
    </div>

    <div class="notes-section">
      <div style="font-weight:bold;">ğŸ“ éŒ„éŸ³è¨»è¨˜ï¼š</div>
      <input type="text" id="notesInput" class="notes-input" placeholder="è¼¸å…¥éŒ„éŸ³è¨»è¨˜ï¼ˆä¾‹å¦‚ï¼šå ±å‘ŠäººéŒ¢ä¸–å‚‘ï¼‰" maxlength="100"/>
      <button id="clearNotesBtn" class="notes-clear-btn">æ¸…ç©º</button>
    </div>

    <div class="control-panel">
      <div class="button-group">
        <button id="newSessionBtn" class="btn btn-new-session">æ–°å ±å‘Šäºº</button>
        <button id="recordBtn" class="record-btn"><div>é–‹å§‹éŒ„éŸ³</div></button>
        <button id="generateBtn" class="btn btn-generate" disabled>é‡é»æ‘˜è¦&æå•å»ºè­°</button>
      </div>
      <div id="status" class="status">æº–å‚™å°±ç·’</div>
      <div id="error" class="error"></div>
      <div class="loading" id="loading">è™•ç†ä¸­...</div>
    </div>

    <div class="search-section">
      <div class="section-title">ğŸ” æ­·å²è¨˜éŒ„æœå°‹</div>
      <div class="search-controls">
        <input type="text" id="searchKeyword" class="search-input" placeholder="è¼¸å…¥æœå°‹é—œéµå­—..."/>
        <select id="searchType" class="search-select">
          <option value="all">å…¨æ–‡æœå°‹</option>
          <option value="english">åƒ…è‹±æ–‡</option>
          <option value="chinese">åƒ…ä¸­æ–‡</option>
          <option value="notes">åƒ…è¨»è¨˜</option>
          <option value="session">æœƒè©±ID</option>
        </select>
        <input type="date" id="searchStartDate" class="search-select"/>
        <input type="date" id="searchEndDate" class="search-select"/>
        <button id="searchBtn" class="btn-search">æœå°‹</button>
        <button id="summarizeBtn" class="btn-summarize" disabled>ç”Ÿæˆæ‘˜è¦</button>
      </div>

      <div id="searchStats" class="search-stats" style="display:none;"></div>

      <div id="searchSummarySection" class="search-summary-section">
        <div class="search-summary-title">ğŸ“Š æœå°‹å…§å®¹æ‘˜è¦</div>
        <div id="searchSummaryContent" class="search-summary-content"></div>
      </div>

      <div id="searchResults"><div class="empty-state">è¼¸å…¥é—œéµå­—é–‹å§‹æœå°‹</div></div>
    </div>

    <div class="content-area">
      <div class="section">
        <div class="section-title">ğŸ“ ç¿»è­¯è¨˜éŒ„</div>
        <div id="translationsList"><div class="empty-state">å°šç„¡ç¿»è­¯è¨˜éŒ„<br>é»æ“ŠéŒ„éŸ³æŒ‰éˆ•é–‹å§‹ä½¿ç”¨</div></div>
      </div>
      <div class="section">
        <div class="section-title">ğŸ’¡ æ™ºèƒ½åˆ†æ</div>
        <div id="questionsArea"><div class="empty-state">éœ€è¦è‡³å°‘2ç­†ç¿»è­¯è¨˜éŒ„<br>æ‰èƒ½ç”Ÿæˆåˆ†æå»ºè­°</div></div>
      </div>
    </div>
  </div>

  <script>
    let isRecording=false, mediaRecorder=null, audioChunks=[];
    let currentSession="", translations=[], recordCount=0, isProcessing=false;
    let lastSearchResults=[];
    const API_BASE="https://mjib007.zeabur.app/webhook";

    const elements={
      currentSession:document.getElementById("currentSession"),
      recordCount:document.getElementById("recordCount"),
      newSessionBtn:document.getElementById("newSessionBtn"),
      recordBtn:document.getElementById("recordBtn"),
      generateBtn:document.getElementById("generateBtn"),
      status:document.getElementById("status"),
      error:document.getElementById("error"),
      loading:document.getElementById("loading"),
      translationsList:document.getElementById("translationsList"),
      questionsArea:document.getElementById("questionsArea"),
      searchKeyword:document.getElementById("searchKeyword"),
      searchType:document.getElementById("searchType"),
      searchBtn:document.getElementById("searchBtn"),
      searchResults:document.getElementById("searchResults"),
      searchStartDate:document.getElementById("searchStartDate"),
      searchEndDate:document.getElementById("searchEndDate"),
      notesInput:document.getElementById("notesInput"),
      clearNotesBtn:document.getElementById("clearNotesBtn"),
      summarizeBtn:document.getElementById("summarizeBtn"),
      searchStats:document.getElementById("searchStats"),
      searchSummarySection:document.getElementById("searchSummarySection"),
      searchSummaryContent:document.getElementById("searchSummaryContent"),
    };

    function generateSessionId(){
      const now=new Date();
      const y=now.getFullYear();
      const m=String(now.getMonth()+1).padStart(2,"0");
      const d=String(now.getDate()).padStart(2,"0");
      const hh=String(now.getHours()).padStart(2,"0");
      const mm=String(now.getMinutes()).padStart(2,"0");
      return "Session_"+y+m+d+"_"+hh+mm;
    }

    function startNewSession(){
      currentSession=generateSessionId();
      translations=[]; recordCount=0;
      elements.currentSession.textContent=currentSession;
      elements.recordCount.textContent=recordCount;
      updateTranslationsList();
      updateQuestionsArea();
      updateGenerateButton();
      updateStatus("æ–°æœƒè©±å·²é–‹å§‹");
    }

    function updateStatus(msg){ elements.status.textContent=msg; elements.error.style.display="none"; }
    function showError(msg){ elements.error.textContent=msg; elements.error.style.display="block"; }

    function setProcessing(p){
      isProcessing=p;
      elements.loading.style.display=p?"block":"none";
      updateGenerateButton();
      elements.summarizeBtn.disabled=p || lastSearchResults.length===0;
    }

    function updateGenerateButton(){ elements.generateBtn.disabled = (recordCount<2 || isProcessing); }

    function updateTranslationsList(){
      if(translations.length===0){
        elements.translationsList.innerHTML='<div class="empty-state">å°šç„¡ç¿»è­¯è¨˜éŒ„<br>é»æ“ŠéŒ„éŸ³æŒ‰éˆ•é–‹å§‹ä½¿ç”¨</div>';
        return;
      }
      let html="";
      for(const t of translations){
        html+='<div class="translation-item">';
        if(t.notes && t.notes.trim()!==''){ html+='<div class="notes-display">ğŸ“ '+t.notes+'</div>'; }
        html+='<div style="font-size:12px;color:#666;margin-bottom:10px;">'+t.timestamp+'</div>';
        html+='<div style="background:#ebf3fd;padding:10px;border-radius:5px;margin-bottom:10px;"><strong>è‹±æ–‡ï¼š</strong><br>'+t.english+'</div>';
        html+='<div style="background:#e8f5e8;padding:10px;border-radius:5px;"><strong>ä¸­æ–‡ï¼š</strong><br>'+t.chinese+'</div>';
        html+='</div>';
      }
      elements.translationsList.innerHTML=html;
    }

    function updateQuestionsArea(){
      elements.questionsArea.innerHTML='<div class="empty-state">éœ€è¦è‡³å°‘2ç­†ç¿»è­¯è¨˜éŒ„<br>æ‰èƒ½ç”Ÿæˆåˆ†æå»ºè­°</div>';
    }
    function displayQuestions(q){
      elements.questionsArea.innerHTML='<div style="background:#fff;padding:15px;border-radius:10px;white-space:pre-wrap;line-height:1.6;">'+q+'</div>';
    }

    function clearNotes(){ elements.notesInput.value=''; updateStatus("è¨»è¨˜å·²æ¸…ç©º"); }

    async function toggleRecording(){ if(!isRecording){await startRecording();} else {stopRecording();} }

    async function startRecording(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder = new MediaRecorder(stream); audioChunks=[];
        mediaRecorder.ondataavailable = e=>{ audioChunks.push(e.data); };
        mediaRecorder.onstop = ()=>{ processAudio(); };
        mediaRecorder.start(); isRecording=true;
        elements.recordBtn.classList.add("recording"); elements.recordBtn.innerHTML="<div>åœæ­¢éŒ„éŸ³</div>";
        const note=elements.notesInput.value.trim();
        updateStatus(note?("éŒ„éŸ³ä¸­... (è¨»è¨˜: "+note+")"):"éŒ„éŸ³ä¸­...");
      }catch(err){ showError("éŒ„éŸ³å•Ÿå‹•å¤±æ•—: "+err.message); }
    }

    function stopRecording(){
      if(mediaRecorder && mediaRecorder.state!=="inactive"){ mediaRecorder.stop(); }
      isRecording=false;
      elements.recordBtn.classList.remove("recording"); elements.recordBtn.innerHTML="<div>é–‹å§‹éŒ„éŸ³</div>";
      updateStatus("è™•ç†ä¸­...");
    }

    async function processAudio(){
      try{
        setProcessing(true);
        const audioBlob=new Blob(audioChunks,{type:"audio/webm"});
        const formData=new FormData();
        formData.append("audio_file",audioBlob,"recording.webm");
        const resp=await fetch(API_BASE+"/quick-translate",{method:"POST",body:formData});
        if(!resp.ok) throw new Error("ç¿»è­¯è«‹æ±‚å¤±æ•—");
        const result=await resp.json();
        await handleTranslationResult(result);
      }catch(err){ showError("è™•ç†å¤±æ•—: "+err.message); }
      finally{
        setProcessing(false);
        if(mediaRecorder && mediaRecorder.stream){ mediaRecorder.stream.getTracks().forEach(t=>t.stop()); }
      }
    }

    async function handleTranslationResult(result){
      if(result.english && result.chinese){
        const note=elements.notesInput.value.trim();
        const translation={ id:Date.now(), timestamp:result.timestamp||new Date().toLocaleString("zh-TW"), english:result.english, chinese:result.chinese, notes:note };
        translations.push(translation); updateTranslationsList();
        const ok=await saveToDatabase(translation);
        updateStatus(ok ? (note? "ç¿»è­¯å®Œæˆä¸¦å·²å„²å­˜ (å«è¨»è¨˜: "+note+")":"ç¿»è­¯å®Œæˆä¸¦å·²å„²å­˜") : "ç¿»è­¯å®Œæˆï¼Œä½†å„²å­˜å¤±æ•—");
      }else{
        showError("ç¿»è­¯çµæœæ ¼å¼éŒ¯èª¤");
      }
    }

    async function saveToDatabase(t){
      try{
        const now=new Date(); const iso=now.toISOString();
        const saveData={ Session_ID:currentSession, Timestamp:iso, English_Text:t.english, Chinese_Text:t.chinese, Notes:t.notes||'', Created_Date: iso.split('T')[0] };
        const resp=await fetch(API_BASE+"/save-record",{method:"POST",headers:{ "Content-Type":"application/json","Accept":"application/json"}, body:JSON.stringify(saveData)});
        if(resp.ok){ recordCount++; elements.recordCount.textContent=recordCount; updateGenerateButton(); return true; }
        return false;
      }catch{ return false; }
    }

    async function generateQuestions(){
      if(recordCount<2){ showError("éœ€è¦è‡³å°‘2ç­†ç¿»è­¯è¨˜éŒ„æ‰èƒ½ç”Ÿæˆåˆ†æå»ºè­°"); return; }
      try{
        setProcessing(true);
        const resp=await fetch(API_BASE+"/generate-questions",{method:"POST",headers:{ "Content-Type":"application/json","Accept":"application/json"}, body:JSON.stringify({session_id:currentSession})});
        if(!resp.ok) throw new Error("ç”Ÿæˆåˆ†æå¤±æ•—");
        const result=await resp.json();
        const q = result.ai_response || result.questions || "ç„¡æ³•è§£æåˆ†æå…§å®¹";
        displayQuestions(q);
        updateStatus("åˆ†æå»ºè­°å·²ç”Ÿæˆ");
      }catch(err){ showError("ç”Ÿæˆåˆ†æå¤±æ•—: "+err.message); }
      finally{ setProcessing(false); }
    }

    async function performSearch(){
      const keyword=elements.searchKeyword.value.trim();
      const searchType=elements.searchType.value;
      const startDate=elements.searchStartDate?elements.searchStartDate.value:"";
      const endDate=elements.searchEndDate?elements.searchEndDate.value:"";

      if(!keyword){ showError("è«‹è¼¸å…¥æœå°‹é—œéµå­—"); return; }
      if(startDate && endDate && startDate>endDate){ showError("é–‹å§‹æ—¥æœŸä¸å¯æ™šæ–¼çµæŸæ—¥æœŸ"); return; }

      try{
        setProcessing(true);
        const data={ keyword, searchType };
        if(startDate||endDate){ data.dateRange={}; if(startDate) data.dateRange.start=startDate; if(endDate) data.dateRange.end=endDate; }

        const resp=await fetch(API_BASE+"/search-records",{method:"POST",headers:{ "Content-Type":"application/json"}, body:JSON.stringify(data)});
        if(!resp.ok) throw new Error("æœå°‹å¤±æ•—");
        const result=await resp.json();
        displaySearchResults(result);
      }catch(err){
        showError("æœå°‹å¤±æ•—: "+err.message);
        elements.searchResults.innerHTML='<div class="empty-state">æœå°‹éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤</div>';
        lastSearchResults=[]; elements.summarizeBtn.disabled=true;
      }finally{ setProcessing(false); }
    }

    function displaySearchResults(result){
      const results = Array.isArray(result.results)? result.results : [];
      lastSearchResults = results;
      elements.summarizeBtn.disabled = (results.length===0 || isProcessing);

      if(result.stats){
        elements.searchStats.style.display="block";
        elements.searchStats.innerHTML = `
          æœå°‹é—œéµå­—: <strong>${result.stats.search_keyword}</strong> |
          æœå°‹é¡å‹: <strong>${getSearchTypeText(result.stats.search_type)}</strong> |
          æ‰¾åˆ°è¨˜éŒ„: <strong>${result.stats.total_found}</strong> ç­† |
          æ¶µè“‹æœƒè©±: <strong>${result.sessions_count || 0}</strong> å€‹
        `;
      } else {
        elements.searchStats.style.display="none";
      }

      // è‹¥å¾Œç«¯æœ¬æ¬¡å°±æœ‰å› summaryï¼Œç›´æ¥é¡¯ç¤º
      if(result.summary){
        elements.searchSummarySection.style.display="block";
        elements.searchSummaryContent.textContent = result.summary;
      }else{
        elements.searchSummarySection.style.display="none";
        elements.searchSummaryContent.textContent = '';
      }

      if(results.length===0){
        elements.searchResults.innerHTML = '<div class="empty-state">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</div>';
        return;
      }

      let html="";
      results.forEach(item=>{
        html+='<div class="search-result-item">';
        html+='<div style="font-size:12px;color:#666;margin-bottom:5px;">æœƒè©±: '+item.session_id+' | æ™‚é–“: '+new Date(item.timestamp).toLocaleString()+'</div>';
        if(item.notes && item.notes.trim()!==''){ html+='<div class="notes-display">ğŸ“ '+item.notes+'</div>'; }
        html+='<div style="background:#f0f8ff;padding:8px;margin-bottom:5px;border-radius:3px;"><strong>è‹±æ–‡:</strong> '+(item.highlight?.english || item.english)+'</div>';
        html+='<div style="background:#f0fff0;padding:8px;border-radius:3px;"><strong>ä¸­æ–‡:</strong> '+(item.highlight?.chinese || item.chinese)+'</div>';
        html+='</div>';
      });
      elements.searchResults.innerHTML=html;
      updateStatus("æ‰¾åˆ° "+results.length+" ç­†è¨˜éŒ„");
    }

    function getSearchTypeText(t){
      const map={all:'å…¨æ–‡æœå°‹',english:'åƒ…è‹±æ–‡',chinese:'åƒ…ä¸­æ–‡',notes:'åƒ…è¨»è¨˜',session:'æœƒè©±ID'};
      return map[t]||t;
    }

// ç”Ÿæˆæ‘˜è¦ï¼šé‡é€ä¸€æ¬¡ /search-recordsï¼Œä½†åŠ  summarize:true
async function generateSearchSummary(){
  console.log("=== é–‹å§‹ç”Ÿæˆæ‘˜è¦ ===");
  console.log("lastSearchResults.length:", lastSearchResults.length);
  
  if(lastSearchResults.length===0){ 
    console.log("éŒ¯èª¤ï¼šæ²’æœ‰æœå°‹çµæœ");
    showError("æ²’æœ‰å¯ç”¨çš„æœå°‹çµæœé€²è¡Œæ‘˜è¦"); 
    return; 
  }
  
  try{
    console.log("è¨­å®šè™•ç†ç‹€æ…‹...");
    setProcessing(true);
    updateStatus("æ­£åœ¨ç”Ÿæˆæœå°‹å…§å®¹æ‘˜è¦...");
    
    const keyword=elements.searchKeyword.value.trim();
    const searchType=elements.searchType.value;
    const startDate=elements.searchStartDate?elements.searchStartDate.value:"";
    const endDate=elements.searchEndDate?elements.searchEndDate.value:"";
    
    const data={ keyword, searchType, summarize:true };
    if(startDate||endDate){ 
      data.dateRange={}; 
      if(startDate) data.dateRange.start=startDate; 
      if(endDate) data.dateRange.end=endDate; 
    }
    
    console.log("æº–å‚™ç™¼é€è«‹æ±‚ï¼Œè³‡æ–™:", data);
    console.log("API_BASE:", API_BASE);
    
    const resp=await fetch(API_BASE+"/search-records",{
      method:"POST",
      headers:{ "Content-Type":"application/json"}, 
      body:JSON.stringify(data)
    });
    
    console.log("æ”¶åˆ°å›æ‡‰ï¼Œç‹€æ…‹:", resp.status, resp.statusText);
    
    if(!resp.ok) {
      console.log("å›æ‡‰ä¸æ­£å¸¸");
      throw new Error("æ‘˜è¦è«‹æ±‚å¤±æ•—");
    }
    
    console.log("æ­£åœ¨è§£æ JSON...");
    const result=await resp.json();
    console.log("å®Œæ•´çš„ API å›æ‡‰:", result);
    console.log("result.summary:", result.summary);
    console.log("result.message:", result.message);
    console.log("result.content:", result.content);
    
    // ä¿®æ­£ï¼šæª¢æŸ¥å¤šç¨®å¯èƒ½çš„æ‘˜è¦æ ¼å¼
    let summaryContent = '';
    
    if(result.summary && typeof result.summary === 'string'){
      console.log("æ‰¾åˆ° result.summary");
      summaryContent = result.summary;
    } else if(result.message && result.message.content){
      console.log("æ‰¾åˆ° result.message.content");
      summaryContent = result.message.content;
    } else if(result.content){
      console.log("æ‰¾åˆ° result.content");
      summaryContent = result.content;
    }
    
    console.log("æœ€çµ‚çš„æ‘˜è¦å…§å®¹:", summaryContent);
    
    if(summaryContent && summaryContent.trim() !== ''){
      console.log("é¡¯ç¤ºæ‘˜è¦å…§å®¹");
      elements.searchSummarySection.style.display="block";
      elements.searchSummaryContent.textContent=summaryContent;
      updateStatus("æ‘˜è¦å®Œæˆ");
    }else{
      console.log("æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ‘˜è¦å…§å®¹");
      elements.searchSummarySection.style.display="none";
      elements.searchSummaryContent.textContent='';
      updateStatus("æœ¬æ¬¡ç„¡æ³•ç”Ÿæˆæ‘˜è¦ï¼ˆçµæœå¤ªå°‘æˆ–æ ¼å¼ä¸ç¬¦ï¼‰");
    }
    
  }catch(err){ 
    console.log("ç™¼ç”ŸéŒ¯èª¤:", err);
    showError("æ‘˜è¦å¤±æ•—: "+err.message); 
  }
  finally{ 
    console.log("çµæŸè™•ç†");
    setProcessing(false); 
  }
}

    // äº‹ä»¶
    elements.newSessionBtn.addEventListener("click", startNewSession);
    elements.recordBtn.addEventListener("click", toggleRecording);
    elements.generateBtn.addEventListener("click", generateQuestions);
    elements.clearNotesBtn.addEventListener("click", clearNotes);
    elements.searchBtn.addEventListener("click", performSearch);
    elements.summarizeBtn.addEventListener("click", generateSearchSummary);
    elements.searchKeyword.addEventListener("keypress", e=>{ if(e.key==="Enter") performSearch(); });

    // åˆå§‹åŒ–
    document.addEventListener("DOMContentLoaded", ()=>{
      startNewSession();
      const s=elements.searchStartDate, e=elements.searchEndDate;
      if(s&&e){
        const now=new Date(); const yyyy=now.getFullYear();
        const mm=String(now.getMonth()+1).padStart(2,"0");
        const dd=String(now.getDate()).padStart(2,"0");
        s.value=`${yyyy}-${mm}-01`; e.value=`${yyyy}-${mm}-${dd}`;
      }
    });
  </script>
</body>
</html>
