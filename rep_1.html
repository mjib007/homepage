<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPå”å®šæ™ºèƒ½å”èª¿å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
            border: none;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            min-height: 600px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: inline-block;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .status-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .metric-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .metric-label {
            color: #666;
            margin-top: 5px;
        }
        
        .participant-list {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .participant-item:last-child {
            border-bottom: none;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .hidden {
            display: none;
        }
        
        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .two-columns {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– REPå”å®šæ™ºèƒ½å”èª¿å¹³å°</h1>
            <p>è®“AIå¹«åŠ©ç¾¤é«”åšå‡ºæ›´å¥½çš„æ±ºç­–</p>

        </div>
        
        <!-- æ¨™ç±¤é  -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('host')">ğŸ¯ ä¸»æŒäººç•Œé¢</button>
            <button class="tab" onclick="showTab('participant')">ğŸ‘¥ åƒèˆ‡è€…ç•Œé¢</button>
            <button class="tab" onclick="showTab('results')">ğŸ“Š çµæœæŸ¥çœ‹</button>
        </div>
        
        <div class="tab-content">
            <!-- ä¸»æŒäººç•Œé¢ -->
            <div id="host" class="tab-panel active">
                <h2>ğŸ¯ ä¸»æŒäººæ§åˆ¶å°</h2>
                
                <!-- å‰µå»ºæœƒè©± -->
                <div class="status-card">
                    <h3>â• å‰µå»ºæ–°çš„å”èª¿æœƒè©±</h3>
                    <div class="two-columns">
                        <div>
                            <div class="form-group">
                                <label>ä¸»æŒäººå§“å</label>
                                <input type="text" id="hostName" value="ä¸»æŒäºº" />
                            </div>
                            <div class="form-group">
                                <label>æœƒè©±æ¨™é¡Œ</label>
                                <input type="text" id="sessionTitle" value="ç¾¤é«”æ±ºç­–å”èª¿" />
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label>å•é¡Œæ¨¡æ¿</label>
                                <select id="questionTemplate" onchange="updateQuestion()">
                                    <option value="èšæœƒå®‰æ’">èšæœƒå®‰æ’</option>
                                    <option value="æœƒè­°æ™‚é–“">æœƒè­°æ™‚é–“</option>
                                    <option value="é …ç›®è³‡æº">é …ç›®è³‡æº</option>
                                    <option value="è‡ªå®šç¾©">è‡ªå®šç¾©</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å”èª¿å•é¡Œ</label>
                        <textarea id="sessionQuestion" rows="3">æˆ‘å€‘è¦å®‰æ’ä¸€æ¬¡èšæœƒæ´»å‹•ï¼Œè«‹èªªæ˜æ‚¨çš„æ™‚é–“ã€åœ°é»ã€é ç®—åå¥½ï¼Œä»¥åŠå¦‚æœå…¶ä»–æ¢ä»¶æ”¹è®Šæ‚¨æœƒå¦‚ä½•èª¿æ•´ï¼Ÿ</textarea>
                    </div>
                    <button class="btn btn-primary" onclick="createSession()">ğŸš€ å‰µå»ºæœƒè©±</button>
                </div>
                
                <!-- æœƒè©±ç›£æ§ -->
                <div id="sessionMonitor" class="hidden">
                    <h3>ğŸ“Š æœƒè©±ç›£æ§</h3>
                    <div class="status-grid">
                        <div class="metric-card">
                            <div class="metric-number" id="totalParticipants">0</div>
                            <div class="metric-label">ç¸½åƒèˆ‡è€…</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-number" id="completedResponses">0</div>
                            <div class="metric-label">å·²å®Œæˆå›æ‡‰</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-number" id="pendingResponses">0</div>
                            <div class="metric-label">å¾…å›æ‡‰</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-number" id="sessionStatus">ç­‰å¾…ä¸­</div>
                            <div class="metric-label">æœƒè©±ç‹€æ…‹</div>
                        </div>
                    </div>
                    
                    <div class="status-card">
                        <h4>ğŸ“‹ æœƒè©±è³‡è¨Š</h4>
                        <p><strong>æœƒè©±IDï¼š</strong><span id="currentSessionId"></span></p>
                        <p><strong>åˆ†äº«çµ¦åƒèˆ‡è€…ï¼š</strong>è«‹å°‡æœƒè©±IDæä¾›çµ¦æ‰€æœ‰åƒèˆ‡è€…</p>
                    </div>
                    
                    <div class="participant-list">
                        <h4>ğŸ‘¥ åƒèˆ‡è€…ç‹€æ…‹</h4>
                        <div id="participantsList">
                            <p>é‚„æ²’æœ‰åƒèˆ‡è€…åŠ å…¥...</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" id="analyzeBtn" onclick="startAnalysis()" disabled>ğŸ¤– é–‹å§‹REPå”å®šåˆ†æ</button>
                        <button class="btn btn-warning" onclick="refreshStatus()" style="margin-left: 10px;">ğŸ”„ é‡æ–°æ•´ç†</button>
                    </div>
                </div>
            </div>
            
            <!-- åƒèˆ‡è€…ç•Œé¢ -->
            <div id="participant" class="tab-panel">
                <h2>ğŸ‘¥ åƒèˆ‡è€…ç•Œé¢</h2>
                
                <!-- åŠ å…¥æœƒè©± -->
                <div class="status-card">
                    <h3>ğŸš€ åŠ å…¥å”èª¿æœƒè©±</h3>
                    <div class="two-columns">
                        <div class="form-group">
                            <label>æœƒè©±ID</label>
                            <input type="text" id="joinSessionId" placeholder="è¼¸å…¥ä¸»æŒäººæä¾›çš„æœƒè©±ID" />
                        </div>
                        <div class="form-group">
                            <label>æ‚¨çš„å§“å</label>
                            <input type="text" id="participantName" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" />
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="joinSession()">ğŸ“ åŠ å…¥æœƒè©±</button>
                </div>
                
                <!-- å›æ‡‰è¡¨å–® -->
                <div id="responseForm" class="hidden">
                    <div class="status-card">
                        <h3 id="sessionQuestionDisplay"></h3>
                        
                        <div class="form-group">
                            <label>ğŸ¯ æ‚¨çš„ç†æƒ³åå¥½</label>
                            <textarea id="userPreference" rows="3" placeholder="è«‹æè¿°æ‚¨å¸Œæœ›çš„ç†æƒ³å®‰æ’..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>ğŸ”„ æ•æ„Ÿæ€§ä¿¡è™Ÿ</label>
                            <textarea id="userSensitivity" rows="4" placeholder="å¦‚æœå…¶ä»–æ¢ä»¶æ”¹è®Šï¼ˆæ™‚é–“/é ç®—/åœ°é»ç­‰ï¼‰ï¼Œæ‚¨æœƒå¦‚ä½•èª¿æ•´ï¼Ÿè«‹ç”¨ã€Œå¦‚æœ...é‚£éº¼...ã€çš„æ–¹å¼æè¿°"></textarea>
                        </div>
                        
                        <div class="two-columns">
                            <div class="form-group">
                                <label>ğŸš« çµ•å°åº•ç·š</label>
                                <input type="text" id="userConstraints" placeholder="ä»€éº¼æ˜¯æ‚¨çµ•å°ä¸èƒ½æ¥å—çš„ï¼Ÿ" />
                            </div>
                            <div class="form-group">
                                <label>ğŸ¤ å½ˆæ€§åº¦ (1-10)</label>
                                <input type="range" id="userFlexibility" min="1" max="10" value="5" oninput="updateFlexibilityDisplay()" />
                                <div style="text-align: center; margin-top: 5px;">
                                    <span id="flexibilityDisplay">5</span> - <span id="flexibilityLabel">ä¸­ç­‰å½ˆæ€§</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>ğŸ’­ é¡å¤–å‚™è¨»</label>
                            <input type="text" id="userNotes" placeholder="å…¶ä»–æƒ³èªªçš„è©±..." />
                        </div>
                        
                        <button class="btn btn-primary" onclick="submitResponse()">ğŸ“¤ æäº¤å›æ‡‰</button>
                    </div>
                </div>
            </div>
            
            <!-- çµæœæŸ¥çœ‹ -->
            <div id="results" class="tab-panel">
                <h2>ğŸ“Š å”èª¿çµæœ</h2>
                
                <div class="status-card">
                    <div class="form-group">
                        <label>è¼¸å…¥æœƒè©±IDæŸ¥çœ‹çµæœ</label>
                        <input type="text" id="resultSessionId" placeholder="è¼¸å…¥æœƒè©±ID" />
                    </div>
                    <button class="btn btn-primary" onclick="viewResults()">ğŸ” æŸ¥çœ‹çµæœ</button>
                </div>
                
                <div id="resultsDisplay" class="hidden">
                    <!-- çµæœå°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // N8N Webhook URL
        const N8N_WEBHOOK_URL = 'https://kf0630.zeabur.app/webhook/rep-coordination';
        
        // æœ¬åœ°è³‡æ–™å„²å­˜
        let sessions = JSON.parse(localStorage.getItem('rep_sessions') || '{}');
        let currentSession = null;
        
        // é é¢è¼‰å…¥æ™‚æ¢å¾©è³‡æ–™
        window.onload = function() {
            // æ¢å¾©æœƒè©±è³‡æ–™
            const savedSessions = localStorage.getItem('rep_sessions');
            if (savedSessions) {
                sessions = JSON.parse(savedSessions);
            }
            
            // æ¢å¾©ç•¶å‰æœƒè©±
            const savedCurrentSession = localStorage.getItem('currentSession');
            if (savedCurrentSession && sessions[savedCurrentSession]) {
                currentSession = savedCurrentSession;
                document.getElementById('currentSessionId').textContent = currentSession;
                document.getElementById('sessionMonitor').classList.remove('hidden');
                updateSessionStatus();
            }
        };
        
        // æ¨™ç±¤é åˆ‡æ›
        function showTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤é 
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸å®šçš„æ¨™ç±¤é 
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        // æ›´æ–°å•é¡Œæ¨¡æ¿
        function updateQuestion() {
            const templates = {
                'èšæœƒå®‰æ’': 'æˆ‘å€‘è¦å®‰æ’ä¸€æ¬¡èšæœƒæ´»å‹•ï¼Œè«‹èªªæ˜æ‚¨çš„æ™‚é–“ã€åœ°é»ã€é ç®—åå¥½ï¼Œä»¥åŠå¦‚æœå…¶ä»–æ¢ä»¶æ”¹è®Šæ‚¨æœƒå¦‚ä½•èª¿æ•´ï¼Ÿ',
                'æœƒè­°æ™‚é–“': 'æˆ‘å€‘éœ€è¦å®‰æ’é‡è¦æœƒè­°æ™‚é–“ï¼Œè«‹èªªæ˜æ‚¨çš„å¯ç”¨æ™‚é–“å’Œé™åˆ¶æ¢ä»¶ï¼Œä»¥åŠæ‚¨çš„å½ˆæ€§ç©ºé–“ï¼Ÿ',
                'é …ç›®è³‡æº': 'é …ç›®è³‡æºåˆ†é…æ±ºç­–ï¼Œè«‹èªªæ˜æ‚¨èªç‚ºçš„å„ªå…ˆé †åºå’Œè³‡æºéœ€æ±‚ï¼Œä»¥åŠå¯æ¥å—çš„èª¿æ•´ç¯„åœï¼Ÿ',
                'è‡ªå®šç¾©': ''
            };
            
            const selected = document.getElementById('questionTemplate').value;
            document.getElementById('sessionQuestion').value = templates[selected] || '';
        }
        
        // å‰µå»ºæœƒè©±
        function createSession() {
            const hostName = document.getElementById('hostName').value;
            const title = document.getElementById('sessionTitle').value;
            const question = document.getElementById('sessionQuestion').value;
            
            if (!hostName || !title || !question) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦è³‡è¨Š');
                return;
            }
            
            // ç”Ÿæˆæœƒè©±ID
            const sessionId = Math.random().toString(36).substr(2, 8).toUpperCase();
            
            // å‰µå»ºæœƒè©±è³‡æ–™
            sessions[sessionId] = {
                hostName,
                title,
                question,
                createdTime: new Date().toISOString(),
                participants: {},
                responses: [],
                status: 'collecting'
            };
            
            currentSession = sessionId;
            
            // å„²å­˜åˆ°localStorage
            localStorage.setItem('rep_sessions', JSON.stringify(sessions));
            localStorage.setItem('currentSession', sessionId);
            
            // æ›´æ–°UI
            document.getElementById('currentSessionId').textContent = sessionId;
            document.getElementById('sessionMonitor').classList.remove('hidden');
            updateSessionStatus();
            
            showAlert('success', `âœ… æœƒè©±å‰µå»ºæˆåŠŸï¼æœƒè©±IDï¼š${sessionId}`);
        }
        
        // æ›´æ–°æœƒè©±ç‹€æ…‹
        function updateSessionStatus() {
            if (!currentSession || !sessions[currentSession]) return;
            
            const session = sessions[currentSession];
            const participantCount = Object.keys(session.participants).length;
            const responseCount = session.responses.length;
            const pendingCount = participantCount - responseCount;
            
            document.getElementById('totalParticipants').textContent = participantCount;
            document.getElementById('completedResponses').textContent = responseCount;
            document.getElementById('pendingResponses').textContent = pendingCount;
            document.getElementById('sessionStatus').textContent = session.status === 'collecting' ? 'æ”¶é›†ä¸­' : session.status;
            
            // æ›´æ–°åƒèˆ‡è€…åˆ—è¡¨
            updateParticipantsList();
            
            // æ›´æ–°åˆ†ææŒ‰éˆ•
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = responseCount === 0;
        }
        
        // æ›´æ–°åƒèˆ‡è€…åˆ—è¡¨
        function updateParticipantsList() {
            if (!currentSession || !sessions[currentSession]) return;
            
            const session = sessions[currentSession];
            const listDiv = document.getElementById('participantsList');
            
            if (Object.keys(session.participants).length === 0) {
                listDiv.innerHTML = '<p>é‚„æ²’æœ‰åƒèˆ‡è€…åŠ å…¥...</p>';
                return;
            }
            
            let html = '';
            Object.keys(session.participants).forEach(name => {
                const hasResponse = session.responses.some(r => r.name === name);
                const statusClass = hasResponse ? 'status-completed' : 'status-pending';
                const statusText = hasResponse ? 'å·²å®Œæˆ' : 'å¾…å®Œæˆ';
                
                html += `
                    <div class="participant-item">
                        <span>${name}</span>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }
        
        // åŠ å…¥æœƒè©±
        function joinSession() {
            const sessionId = document.getElementById('joinSessionId').value.trim().toUpperCase();
            const participantName = document.getElementById('participantName').value.trim();
            
            if (!sessionId || !participantName) {
                alert('è«‹è¼¸å…¥æœƒè©±IDå’Œæ‚¨çš„å§“å');
                return;
            }
            
            if (!sessions[sessionId]) {
                alert('æœƒè©±ä¸å­˜åœ¨ï¼Œè«‹æª¢æŸ¥IDæ˜¯å¦æ­£ç¢º');
                return;
            }
            
            // åŠ å…¥åƒèˆ‡è€…
            sessions[sessionId].participants[participantName] = {
                joinedTime: new Date().toISOString()
            };
            
            // é¡¯ç¤ºå›æ‡‰è¡¨å–®
            document.getElementById('sessionQuestionDisplay').textContent = `ğŸ“ ${sessions[sessionId].title}`;
            document.getElementById('sessionQuestionDisplay').innerHTML += `<br><small style="color: #666;">å•é¡Œï¼š${sessions[sessionId].question}</small>`;
            document.getElementById('responseForm').classList.remove('hidden');
            
            // å„²å­˜ç•¶å‰åƒèˆ‡è³‡è¨Š
            sessionStorage.setItem('currentParticipantSession', sessionId);
            sessionStorage.setItem('currentParticipantName', participantName);
            
            showAlert('success', 'âœ… æˆåŠŸåŠ å…¥æœƒè©±ï¼è«‹å¡«å¯«æ‚¨çš„æƒ³æ³•');
        }
        
        // æ›´æ–°å½ˆæ€§åº¦é¡¯ç¤º
        function updateFlexibilityDisplay() {
            const value = document.getElementById('userFlexibility').value;
            document.getElementById('flexibilityDisplay').textContent = value;
            
            const labels = {
                1: 'å®Œå…¨ä¸å¦¥å”', 2: 'å¾ˆå°‘å¦¥å”', 3: 'è¼ƒå°‘å¦¥å”', 4: 'æœ‰é»å¦¥å”',
                5: 'ä¸­ç­‰å½ˆæ€§', 6: 'è¼ƒæœ‰å½ˆæ€§', 7: 'å¾ˆæœ‰å½ˆæ€§', 8: 'é«˜åº¦å½ˆæ€§',
                9: 'æ¥µåº¦å½ˆæ€§', 10: 'å®Œå…¨å½ˆæ€§'
            };
            
            document.getElementById('flexibilityLabel').textContent = labels[value];
        }
        
        // æäº¤å›æ‡‰
        function submitResponse() {
            const sessionId = sessionStorage.getItem('currentParticipantSession');
            const participantName = sessionStorage.getItem('currentParticipantName');
            
            const preference = document.getElementById('userPreference').value.trim();
            const sensitivity = document.getElementById('userSensitivity').value.trim();
            const constraints = document.getElementById('userConstraints').value.trim();
            const flexibility = document.getElementById('userFlexibility').value;
            const notes = document.getElementById('userNotes').value.trim();
            
            if (!preference || !sensitivity || !constraints) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                return;
            }
            
            // ç§»é™¤èˆŠå›æ‡‰
            sessions[sessionId].responses = sessions[sessionId].responses.filter(r => r.name !== participantName);
            
            // åŠ å…¥æ–°å›æ‡‰
            sessions[sessionId].responses.push({
                name: participantName,
                preference,
                sensitivity,
                constraints,
                flexibility: parseInt(flexibility),
                notes,
                submitTime: new Date().toISOString()
            });
            
            // å„²å­˜åˆ°localStorage
            localStorage.setItem('rep_sessions', JSON.stringify(sessions));
            
            showAlert('success', 'âœ… å›æ‡‰æäº¤æˆåŠŸï¼è«‹ç­‰å¾…ä¸»æŒäººé–‹å§‹åˆ†æ');
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('userPreference').value = '';
            document.getElementById('userSensitivity').value = '';
            document.getElementById('userConstraints').value = '';
            document.getElementById('userFlexibility').value = '5';
            document.getElementById('userNotes').value = '';
            updateFlexibilityDisplay();
        }
        
        // é‡æ–°æ•´ç†ç‹€æ…‹
        function refreshStatus() {
            updateSessionStatus();
            showAlert('success', 'âœ… ç‹€æ…‹å·²æ›´æ–°');
        }
        
        // é–‹å§‹åˆ†æ - é€£æ¥åˆ°N8Nå¾Œç«¯
        async function startAnalysis() {
            if (!currentSession || !sessions[currentSession]) return;
            
            const session = sessions[currentSession];
            if (session.responses.length === 0) {
                alert('é‚„æ²’æœ‰ä»»ä½•å›æ‡‰ï¼Œç„¡æ³•é€²è¡Œåˆ†æ');
                return;
            }
            
            // æ›´æ–°ç‹€æ…‹
            session.status = 'analyzing';
            updateSessionStatus();
            
            showAlert('warning', 'ğŸ¤– æ­£åœ¨ç™¼é€è³‡æ–™åˆ°N8Né€²è¡ŒREPå”å®šåˆ†æ...');
            
            try {
                // æº–å‚™ç™¼é€çµ¦N8Nçš„è³‡æ–™æ ¼å¼
                const requestData = {
                    session_id: currentSession,
                    sheet_id: '1tIsurF3wPtHqmvw2BHB7gX1-LCVPR43SzhEwxxystRs', // æ‚¨çš„å¯¦éš›Google Sheets ID
                    question: session.question,
                    participants_data: session.responses.map(response => ({
                        å§“å: response.name,
                        åå¥½æè¿°: response.preference,
                        æ•æ„Ÿæ€§ä¿¡è™Ÿ: response.sensitivity,
                        åº•ç·šé™åˆ¶: response.constraints,
                        'å½ˆæ€§åº¦(1-10)': response.flexibility,
                        å‚™è¨»: response.notes
                    }))
                };
                
                showAlert('info', 'ğŸ“¡ æ­£åœ¨èª¿ç”¨N8N APIï¼šhttps://kf0630.zeabur.app/webhook/rep-coordination');
                
                // å‘¼å«æ‚¨çš„N8N Webhook
                const response = await fetch('https://kf0630.zeabur.app/webhook/rep-coordination', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (response.ok) {
                    const result = await response.text();
                    console.log('N8Nå›æ‡‰:', result);
                    
                    showAlert('success', 'âœ… REPåˆ†æè«‹æ±‚å·²æˆåŠŸç™¼é€åˆ°N8Nï¼');
                    showAlert('info', 'â³ N8Næ­£åœ¨è™•ç†åˆ†æï¼Œé€™éœ€è¦2-3åˆ†é˜æ™‚é–“...');
                    
                    // ç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œæä¾›æ¨¡æ“¬çµæœï¼ˆå› ç‚ºN8Næ˜¯ç•°æ­¥è™•ç†ï¼‰
                    setTimeout(() => {
                        showAlert('warning', 'ğŸ’¡ N8Næ­£åœ¨å¾Œå°è™•ç†çœŸå¯¦åˆ†æï¼Œé€™è£¡å…ˆæä¾›æ¨¡æ“¬çµæœé è¦½');
                        session.status = 'completed';
                        session.results = generateMockResults(session);
                        session.n8nProcessed = true;
                        session.n8nTimestamp = new Date().toISOString();
                        updateSessionStatus();
                        showAlert('success', 'âœ… å·²æä¾›æ¨¡æ“¬çµæœï¼çœŸå¯¦N8Nåˆ†æçµæœè«‹æŸ¥çœ‹Google Sheetsæˆ–N8Næ—¥èªŒ');
                    }, 5000);
                    
                } else {
                    throw new Error(`N8Nå›æ‡‰éŒ¯èª¤: HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('N8N APIèª¿ç”¨å¤±æ•—:', error);
                showAlert('error', `âŒ N8Né€£æ¥å¤±æ•—: ${error.message}`);
                
                // é™ç´šåˆ°æ¨¡æ“¬åˆ†æ
                showAlert('warning', 'ğŸ”„ æ”¹ç”¨æœ¬åœ°æ¨¡æ“¬åˆ†ææ¨¡å¼...');
                setTimeout(() => {
                    session.status = 'completed';
                    session.results = generateMockResults(session);
                    updateSessionStatus();
                    showAlert('success', 'âœ… æ¨¡æ“¬åˆ†æå®Œæˆï¼è«‹åˆ°ã€ŒçµæœæŸ¥çœ‹ã€æ¨™ç±¤æŸ¥çœ‹å”èª¿çµæœ');
                }, 3000);
            }
        }
        
        // ç”Ÿæˆæ¨¡æ“¬çµæœ
        function generateMockResults(session) {
            return {
                sessionSummary: {
                    question: session.question,
                    totalParticipants: session.responses.length,
                    analysisTime: new Date().toISOString()
                },
                recommendedSolution: {
                    finalDecision: "é€±å…­ä¸‹åˆ2-5é»èšæœƒï¼Œé ç®—æ§åˆ¶åœ¨æ¯äºº400å…ƒä»¥å…§ï¼Œé¸æ“‡å¸‚ä¸­å¿ƒäº¤é€šä¾¿åˆ©çš„é¤å»³",
                    rationale: "æ ¹æ“šå¤šæ•¸æ±ºåˆ†æï¼Œé€™å€‹å®‰æ’èƒ½æ»¿è¶³70%åƒèˆ‡è€…çš„ä¸»è¦éœ€æ±‚ï¼Œä¸¦å°‡ä¸ä¾¿é™åˆ°æœ€ä½",
                    implementationSteps: [
                        "ç¢ºèªæœ€çµ‚åƒèˆ‡äººæ•¸",
                        "é è¨‚ç¬¦åˆé ç®—çš„é¤å»³", 
                        "é€šçŸ¥æ‰€æœ‰äººæœ€çµ‚å®‰æ’",
                        "å»ºç«‹ç¾¤çµ„æŒçºŒæºé€š"
                    ]
                },
                satisfactionReport: {
                    highSatisfaction: session.responses.slice(0, Math.ceil(session.responses.length * 0.7)).map(r => r.name),
                    mediumSatisfaction: session.responses.slice(Math.ceil(session.responses.length * 0.7), Math.ceil(session.responses.length * 0.9)).map(r => r.name),
                    requiresCompromise: session.responses.slice(Math.ceil(session.responses.length * 0.9)).map(r => ({
                        name: r.name,
                        compromiseDetails: "æ™‚é–“å®‰æ’éœ€è¦èª¿æ•´å€‹äººè¨ˆåŠƒ",
                        severity: "medium"
                    }))
                },
                repInsights: {
                    coordinationEffectiveness: "é«˜æ•ˆ - é¿å…äº†å†—é•·è¨è«–ï¼Œå¿«é€Ÿé”æˆå…±è­˜",
                    keyTradeOffs: "æ™‚é–“ vs é ç®—çš„å¹³è¡¡ï¼Œå€‹äººä¾¿åˆ© vs ç¾¤é«”æœ€ä½³",
                    alternativeSolutions: "å¦‚æœé ç®—å¯ä»¥æé«˜åˆ°500å…ƒï¼Œå‰‡æœ‰æ›´å¤šæ™‚é–“é¸æ“‡"
                }
            };
        }
        
        // æŸ¥çœ‹çµæœ
        function viewResults() {
            const sessionId = document.getElementById('resultSessionId').value.trim().toUpperCase();
            
            if (!sessionId) {
                alert('è«‹è¼¸å…¥æœƒè©±ID');
                return;
            }
            
            if (!sessions[sessionId]) {
                alert('æœƒè©±ä¸å­˜åœ¨');
                return;
            }
            
            const session = sessions[sessionId];
            
            if (session.status !== 'completed' || !session.results) {
                alert('è©²æœƒè©±é‚„æœªå®Œæˆåˆ†æ');
                return;
            }
            
            displayResults(session.results);
        }
        
        // é¡¯ç¤ºçµæœ
        function displayResults(results) {
            const displayDiv = document.getElementById('resultsDisplay');
            
            const html = `
                <div class="status-card">
                    <h3>ğŸ“‹ æœƒè©±æ¦‚è¦</h3>
                    <p><strong>åƒèˆ‡äººæ•¸ï¼š</strong>${results.sessionSummary.totalParticipants}</p>
                    <p><strong>å•é¡Œï¼š</strong>${results.sessionSummary.question}</p>
                    <p><strong>åˆ†æå®Œæˆï¼š</strong>${new Date(results.sessionSummary.analysisTime).toLocaleString()}</p>
                </div>
                
                <div class="status-card">
                    <h3>ğŸ¯ æœ€çµ‚å”èª¿æ–¹æ¡ˆ</h3>
                    <div class="alert alert-success">
                        <strong>æ±ºå®šï¼š</strong>${results.recommendedSolution.finalDecision}
                    </div>
                    <p><strong>ç†ç”±ï¼š</strong>${results.recommendedSolution.rationale}</p>
                    
                    <h4>ğŸ“‹ å¯¦æ–½æ­¥é©Ÿï¼š</h4>
                    <ol>
                        ${results.recommendedSolution.implementationSteps.map(step => `<li>${step}</li>`).join('')}
                    </ol>
                </div>
                
                <div class="status-card">
                    <h3>ğŸ“ˆ æ»¿è¶³åº¦åˆ†æ</h3>
                    <div class="two-columns">
                        <div>
                            <h4>ğŸ˜Š é«˜æ»¿æ„åº¦</h4>
                            <ul>
                                ${results.satisfactionReport.highSatisfaction.map(name => `<li>${name}</li>`).join('')}
                            </ul>
                        </div>
                        <div>
                            <h4>ğŸ˜ éœ€è¦å¦¥å”</h4>
                            <ul>
                                ${results.satisfactionReport.requiresCompromise.map(person => 
                                    `<li>${person.name}: ${person.compromiseDetails}</li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="status-card">
                    <h3>ğŸ¤– REPå”å®šåˆ†æ</h3>
                    <p><strong>å”èª¿æ•ˆæœï¼š</strong>${results.repInsights.coordinationEffectiveness}</p>
                    <p><strong>ä¸»è¦æ¬Šè¡¡ï¼š</strong>${results.repInsights.keyTradeOffs}</p>
                    <p><strong>å‚™é¸æ–¹æ¡ˆï¼š</strong>${results.repInsights.alternativeSolutions}</p>
                </div>
            `;
            
            displayDiv.innerHTML = html;
            displayDiv.classList.remove('hidden');
            
            showAlert('success', 'âœ… çµæœè¼‰å…¥å®Œæˆ');
        }
        
        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showAlert(type, message) {
            // ç§»é™¤èˆŠçš„alert
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // å‰µå»ºæ–°çš„alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            // æ’å…¥åˆ°containeré ‚éƒ¨
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateFlexibilityDisplay();
        });
    </script>
</body>
</html>
