
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•å ±åˆ°ç³»çµ± - QR Code æƒæ</title>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 600px;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 16px;
        }
        
        #reader {
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 3px solid #667eea;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #startBtn {
            background: #667eea;
            color: white;
        }
        
        #startBtn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        #stopBtn {
            background: #dc3545;
            color: white;
            display: none;
        }
        
        #stopBtn:hover {
            background: #c82333;
        }

        /* === æ‰‹å‹•è¼¸å…¥çš„ CSS æ¨£å¼ === */
        .manual-entry {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        #manualInput {
            flex-grow: 1;
            padding: 15px;
            font-size: 16px;
            border-radius: 10px;
            border: 2px solid #ddd;
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
        }

        #manualBtn {
            flex-shrink: 0;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: #28a745;
            color: white;
        }
        #manualBtn:hover {
            background: #218838;
        }
        /* === æ¨£å¼çµæŸ === */

        .result {
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.5s;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result.success {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        
        .result.error {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }
        
        .result.duplicate {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }
        
        .result-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .result.success .result-title {
            color: #155724;
        }
        
        .result.error .result-title {
            color: #721c24;
        }
        
        .result.duplicate .result-title {
            color: #856404;
        }
        
        .result-detail {
            font-size: 16px;
            line-height: 1.6;
        }
        
        .result.success .result-detail {
            color: #155724;
        }
        
        .result.error .result-detail {
            color: #721c24;
        }
        
        .result.duplicate .result-detail {
            color: #856404;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ« æ´»å‹•å ±åˆ°ç³»çµ±</h1>
            <p class="subtitle">è«‹æƒæåƒåŠ è€…çš„ QR Code</p>
        </div>
        
        <div id="reader"></div>
        
        <div class="controls">
            <button id="startBtn" onclick="startScanning()">ğŸ“· é–‹å§‹æƒæ</button>
            <button id="stopBtn" onclick="stopScanning()">â¹ï¸ åœæ­¢æƒæ</button>
        </div>

        <div class="manual-entry">
            <input type="text" id="manualInput" placeholder="è«‹è¼¸å…¥å ±åç·¨è™Ÿ">
            <button id="manualBtn" onclick="manualCheckIn()">æ‰‹å‹•å ±åˆ°</button>
        </div>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
        </div>
        
        <div id="result" class="result"></div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="successCount">0</div>
                <div class="stat-label">æˆåŠŸå ±åˆ°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="errorCount">0</div>
                <div class="stat-label">å¤±æ•—æ¬¡æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="duplicateCount">0</div>
                <div class="stat-label">é‡è¤‡å ±åˆ°</div>
            </div>
        </div>
    </div>

    <script>
        // âš™ï¸ è¨­å®šå€ - è«‹ä¿®æ”¹é€™è£¡
        const N8N_WEBHOOK_URL = 'https://yuyu1026.zeabur.app/webhook/qr-checkin';
        
        let html5QrCode;
        let isScanning = false;
        let stats = {
            success: 0,
            error: 0,
            duplicate: 0
        };

        function startScanning() {
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrCode = new Html5Qrcode("reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanError
            ).then(() => {
                isScanning = true;
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'block';
            }).catch(err => {
                showResult('error', 'ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ', 'è«‹ç¢ºèªå·²æˆæ¬Šç›¸æ©Ÿæ¬Šé™');
                console.error(err);
            });
        }

        function stopScanning() {
            if (html5QrCode && isScanning) {
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    document.getElementById('startBtn').style.display = 'block';
                    document.getElementById('stopBtn').style.display = 'none';
                }).catch(err => {
                    console.error(err);
                });
            }
        }

        async function onScanSuccess(decodedText) {
            // æš«åœæƒæï¼Œé¿å…é‡è¤‡
            if (html5QrCode && isScanning) {
                await html5QrCode.pause();
            }

            let qrData;
            try {
                // è§£æ QR Code è³‡æ–™
                qrData = JSON.parse(decodedText);
            } catch {
                // å¦‚æœä¸æ˜¯ JSONï¼Œå‡è¨­æ˜¯å ±åç·¨è™Ÿ
                qrData = { å ±åç·¨è™Ÿ: decodedText };
            }

            // å‘¼å«å…±ç”¨çš„å ±åˆ°è™•ç†å‡½æ•¸
            await processCheckIn(qrData);

            // 3 ç§’å¾Œè‡ªå‹•ç¹¼çºŒæƒæ
            setTimeout(() => {
                if (html5QrCode && isScanning) {
                    html5QrCode.resume();
                }
            }, 3000);
        }

        // === æ‰‹å‹•å ±åˆ°å‡½æ•¸ ===
        async function manualCheckIn() {
            const inputValue = document.getElementById('manualInput').value;

            if (!inputValue || inputValue.trim() === '') {
                showResult('error', 'è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥å ±åç·¨è™Ÿ');
                playSound('error');
                return;
            }

            // æ‰‹å‹•è¼¸å…¥çš„è³‡æ–™
            const postData = { å ±åç·¨è™Ÿ: inputValue.trim() };
            
            // å‘¼å«å…±ç”¨çš„å ±åˆ°è™•ç†å‡½æ•¸
            await processCheckIn(postData);

            // æ‰‹å‹•å ±åˆ°ä¸éœ€è¦é‡æ–°å•Ÿå‹•æƒæ
        }
        // === æ–°å¢çµæŸ ===


        // === å…±ç”¨è™•ç†å‡½æ•¸ ===
        async function processCheckIn(postData) {
            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';

            try {
                console.log('æ­£åœ¨ç™¼é€è³‡æ–™:', postData);
                console.log('ç›®æ¨™ URL:', N8N_WEBHOOK_URL);
                
                // ç™¼é€åˆ° n8n
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(postData)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                const result = await response.json();
                
                console.log('===== æ”¶åˆ°å®Œæ•´å›æ‡‰ =====');
                console.log('å®Œæ•´ result ç‰©ä»¶:', result);
                console.log('result.å ±åˆ°ç·¨è™Ÿ:', result.å ±åˆ°ç·¨è™Ÿ);
                console.log('result.å ±åç·¨è™Ÿ:', result.å ±åç·¨è™Ÿ);
                console.log('result.å§“å:', result.å§“å);
                console.log('result.å–®ä½:', result.å–®ä½);
                console.log('result.å ±åˆ°æ™‚é–“:', result.å ±åˆ°æ™‚é–“);
                console.log('========================');

                // éš±è—è¼‰å…¥å‹•ç•«
                document.getElementById('loading').style.display = 'none';

                // é¡¯ç¤ºçµæœ
                if (result.status === 'success') {
                    stats.success++;
                    showResult(
                        'success',
                        'âœ… å ±åˆ°æˆåŠŸï¼',
                        `ç·¨è™Ÿï¼š${result.å ±åˆ°ç·¨è™Ÿ || result.å ±åç·¨è™Ÿ || 'N/A'}\n` +
                        `å§“åï¼š${result.å§“å || 'æœªæä¾›'}\n` +
                        `å–®ä½ï¼š${result.å–®ä½ || 'æœªæä¾›'}\n` +
                        `æ™‚é–“ï¼š${result.å ±åˆ°æ™‚é–“ || new Date().toLocaleString('zh-TW')}`
                    );
                    playSound('success');
                } else if (result.status === 'duplicate') {
                    stats.duplicate++;
                    showResult(
                        'duplicate',
                        'âš ï¸ é‡è¤‡å ±åˆ°',
                        `ç·¨è™Ÿï¼š${result.å ±åˆ°ç·¨è™Ÿ || result.å ±åç·¨è™Ÿ || 'N/A'}\n` +
                        `å§“åï¼š${result.å§“å || 'æœªæä¾›'}\n` +
                        `å–®ä½ï¼š${result.å–®ä½ || 'æœªæä¾›'}\n` +
                        `ä¸Šæ¬¡å ±åˆ°ï¼š${result.å ±åˆ°æ™‚é–“ || 'æœªè¨˜éŒ„'}`
                    );
                    playSound('duplicate');
                } else {
                    stats.error++;
                    showResult(
                        'error',
                        'âŒ å ±åˆ°å¤±æ•—',
                        result.message || 'æŸ¥ç„¡æ­¤å ±åè³‡æ–™ï¼Œè«‹ç¢ºèªè³‡æ–™æ˜¯å¦æ­£ç¢º'
                    );
                    playSound('error');
                }

                updateStats();

            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                stats.error++;
                showResult('error', 'âŒ ç³»çµ±éŒ¯èª¤', `ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨\n${error.message}`);
                updateStats();
                playSound('error');
Error
            }
        }
        // === æ–°å¢çµæŸ ===


        function onScanError(errorMessage) {
            // æƒæéŒ¯èª¤ï¼ˆä¸€èˆ¬å¯å¿½ç•¥ï¼‰
        }

        function showResult(type, title, detail) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `
                <div class="result-title">${title}</div>
                <div class="result-detail">${detail.replace(/\n/g, '<br>')}</div>
            `;
            resultDiv.style.display = 'block';
        }

        function updateStats() {
            document.getElementById('successCount').textContent = stats.success;
            document.getElementById('errorCount').textContent = stats.error;
            document.getElementById('duplicateCount').textContent = stats.duplicate;
        }

        function playSound(type) {
            // æ’­æ”¾æç¤ºéŸ³ï¼ˆéœ€è¦ç€è¦½å™¨æ”¯æ´ï¼‰
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            if (type === 'success') {
                oscillator.frequency.value = 800;
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            } else if (type === 'duplicate') {
                oscillator.frequency.value = 600;
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            } else {
                oscillator.frequency.value = 400;
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            }

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        // é é¢é—œé–‰æ™‚åœæ­¢æƒæ
        window.addEventListener('beforeunload', () => {
            if (html5QrCode && isScanning) {
                html5QrCode.stop();
            }
        });
    </script>
</body>
</html>