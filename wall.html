<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Êñ∞Âπ¥Á•àÁ¶èÁâÜ üéç</title>

<!-- Google Sign-In -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Zen+Maru+Gothic:wght@400;500;700&family=Shippori+Mincho:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root {
    --vermillion: #D1443A;
    --vermillion-dark: #A8302A;
    --gold: #C8A951;
    --gold-light: #E8D48B;
    --gold-pale: #F5ECD0;
    --wood: #8B6914;
    --wood-dark: #5C4A1E;
    --wood-light: #C49A3C;
    --cream: #FDF8EF;
    --ink: #2C1810;
    --ink-light: #5A3D2B;
    --rope: #D4A843;
    --shrine-red: #BC2B2B;
    --paper: #FBF5E8;
    --shadow: rgba(44, 24, 16, 0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Noto Serif TC', 'Shippori Mincho', serif;
    background: var(--cream);
    color: var(--ink);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ===== Background Pattern ===== */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(circle at 20% 50%, rgba(209,68,58,0.03) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(200,169,81,0.05) 0%, transparent 50%),
      radial-gradient(circle at 50% 80%, rgba(188,43,43,0.02) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  /* Subtle Asanoha pattern overlay */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    opacity: 0.025;
    background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M40 0L80 40L40 80L0 40Z' fill='none' stroke='%23BC2B2B' stroke-width='0.5'/%3E%3Cpath d='M40 0L40 80M0 40L80 40' fill='none' stroke='%23BC2B2B' stroke-width='0.3'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  /* ===== Torii Gate Header ===== */
  .torii-header {
    position: relative;
    text-align: center;
    padding: 40px 20px 30px;
    z-index: 1;
  }

  .torii-gate {
    display: inline-block;
    position: relative;
    padding: 0 60px;
  }

  /* Torii top beam (kasagi) */
  .torii-gate::before {
    content: '';
    position: absolute;
    top: -8px;
    left: -20px;
    right: -20px;
    height: 12px;
    background: var(--vermillion);
    border-radius: 2px;
    box-shadow: 0 2px 8px rgba(209,68,58,0.3);
  }

  /* Torii secondary beam (nuki) */
  .torii-gate::after {
    content: '';
    position: absolute;
    top: 22px;
    left: 10px;
    right: 10px;
    height: 6px;
    background: var(--vermillion);
    border-radius: 1px;
  }

  .torii-pillars {
    position: absolute;
    top: -12px;
    bottom: -10px;
    width: 10px;
    background: var(--vermillion);
    border-radius: 1px;
  }
  .torii-pillars.left { left: 12px; }
  .torii-pillars.right { right: 12px; }

  .header-title {
    font-family: 'Noto Serif TC', serif;
    font-size: clamp(1.8rem, 5vw, 2.8rem);
    font-weight: 900;
    color: var(--ink);
    letter-spacing: 0.15em;
    padding-top: 38px;
    position: relative;
    z-index: 1;
  }

  .header-subtitle {
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: clamp(0.8rem, 2vw, 1rem);
    color: var(--ink-light);
    margin-top: 8px;
    letter-spacing: 0.08em;
    position: relative;
    z-index: 1;
  }

  /* ===== Shimenawa rope decoration ===== */
  .shimenawa {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 10px auto 0;
    max-width: 400px;
    gap: 12px;
    position: relative;
    z-index: 1;
  }

  .shimenawa-line {
    flex: 1;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--rope), transparent);
    border-radius: 2px;
  }

  .shimenawa-tassel {
    font-size: 1.2rem;
    animation: sway 3s ease-in-out infinite;
  }

  @keyframes sway {
    0%, 100% { transform: rotate(-3deg); }
    50% { transform: rotate(3deg); }
  }

  /* ===== Login Section ===== */
  .login-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    position: relative;
    z-index: 1;
  }

  .login-card {
    background: var(--paper);
    border: 1px solid var(--gold-light);
    border-radius: 4px;
    padding: 48px 40px;
    text-align: center;
    max-width: 400px;
    width: 100%;
    box-shadow:
      0 4px 20px var(--shadow),
      inset 0 0 60px rgba(200,169,81,0.05);
    position: relative;
  }

  .login-card::before {
    content: '‚õ©Ô∏è';
    font-size: 2.5rem;
    display: block;
    margin-bottom: 16px;
  }

  .login-card h2 {
    font-family: 'Noto Serif TC', serif;
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--ink);
  }

  .login-card p {
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 0.9rem;
    color: var(--ink-light);
    margin-bottom: 28px;
    line-height: 1.6;
  }

  .google-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 12px 28px;
    background: white;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 1rem;
    font-weight: 500;
    color: #333;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }

  .google-btn:hover {
    border-color: var(--gold);
    box-shadow: 0 2px 8px rgba(200,169,81,0.2);
    transform: translateY(-1px);
  }

  .google-btn svg { width: 20px; height: 20px; }

  /* ===== User Bar ===== */
  .user-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    padding: 12px 20px;
    background: rgba(251,245,232,0.9);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--gold-light);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 0.85rem;
    color: var(--ink-light);
  }

  .user-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid var(--gold-light);
  }

  .btn-sm {
    padding: 6px 16px;
    border: 1px solid var(--gold);
    background: transparent;
    color: var(--ink-light);
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-sm:hover {
    background: var(--gold);
    color: white;
  }

  .btn-sm.danger {
    border-color: var(--vermillion);
    color: var(--vermillion);
  }

  .btn-sm.danger:hover {
    background: var(--vermillion);
    color: white;
  }

  /* ===== Ema Writing Form ===== */
  .ema-form-section {
    display: flex;
    justify-content: center;
    padding: 30px 20px 20px;
    position: relative;
    z-index: 1;
  }

  .ema-form-card {
    position: relative;
    width: 340px;
    min-height: 200px;
    padding: 28px 24px 20px;
    text-align: center;
    /* Wood texture gradient for ema board */
    background:
      linear-gradient(135deg,
        #DEB668 0%, #C8A24A 15%, #DEB668 30%,
        #B8922A 50%, #D4AC5A 70%, #C8A24A 85%, #DEB668 100%);
    border-radius: 6px 6px 6px 6px;
    box-shadow:
      0 6px 20px rgba(92, 74, 30, 0.25),
      inset 0 1px 0 rgba(255,255,255,0.2),
      inset 0 -2px 4px rgba(92, 74, 30, 0.15);
    /* Pentagon-ish ema shape with clip-path */
    clip-path: polygon(0% 15%, 50% 0%, 100% 15%, 100% 100%, 0% 100%);
  }

  .ema-form-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background:
      repeating-linear-gradient(
        90deg,
        transparent,
        transparent 8px,
        rgba(139, 105, 20, 0.06) 8px,
        rgba(139, 105, 20, 0.06) 9px
      );
    pointer-events: none;
    clip-path: polygon(0% 15%, 50% 0%, 100% 15%, 100% 100%, 0% 100%);
  }

  /* Rope hole at top */
  .ema-form-card::after {
    content: '';
    position: absolute;
    top: 18px;
    left: 50%;
    transform: translateX(-50%);
    width: 10px;
    height: 10px;
    background: var(--cream);
    border-radius: 50%;
    border: 2px solid var(--wood-dark);
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
  }

  .ema-form-label {
    font-family: 'Noto Serif TC', serif;
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--wood-dark);
    margin-top: 16px;
    margin-bottom: 12px;
    text-shadow: 0 1px 0 rgba(255,255,255,0.3);
  }

  .ema-textarea {
    width: 100%;
    height: 70px;
    padding: 10px 12px;
    border: none;
    border-radius: 4px;
    background: rgba(255,255,255,0.45);
    font-family: 'Noto Serif TC', serif;
    font-size: 1.05rem;
    color: var(--ink);
    text-align: center;
    resize: none;
    line-height: 1.6;
    outline: none;
    transition: background 0.3s;
  }

  .ema-textarea::placeholder {
    color: rgba(92,74,30,0.4);
    font-size: 0.9rem;
  }

  .ema-textarea:focus {
    background: rgba(255,255,255,0.6);
  }

  .char-count {
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 0.75rem;
    color: var(--wood-dark);
    margin-top: 6px;
    opacity: 0.7;
  }

  .char-count.warn { color: var(--vermillion); opacity: 1; }

  .ema-submit-btn {
    margin-top: 10px;
    padding: 8px 32px;
    background: var(--vermillion);
    color: white;
    border: none;
    border-radius: 4px;
    font-family: 'Noto Serif TC', serif;
    font-size: 0.95rem;
    font-weight: 700;
    cursor: pointer;
    letter-spacing: 0.1em;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(209,68,58,0.3);
  }

  .ema-submit-btn:hover {
    background: var(--vermillion-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(209,68,58,0.35);
  }

  .ema-submit-btn:disabled {
    background: #aaa;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
  }

  /* ===== Blessing Wall ===== */
  .wall-section {
    padding: 10px 20px 60px;
    max-width: 1100px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  .wall-title {
    text-align: center;
    font-family: 'Noto Serif TC', serif;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--ink-light);
    margin-bottom: 24px;
    letter-spacing: 0.1em;
  }

  .wall-title span {
    display: inline-block;
    padding: 0 20px;
    position: relative;
  }

  .wall-title span::before,
  .wall-title span::after {
    content: '‚ú¶';
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gold);
    font-size: 0.7rem;
  }

  .wall-title span::before { left: 0; }
  .wall-title span::after { right: 0; }

  /* Horizontal rope for hanging emas */
  .ema-rope {
    position: relative;
    padding-top: 20px;
    margin-bottom: 40px;
  }

  .ema-rope::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: linear-gradient(180deg, var(--rope), #B8922A);
    border-radius: 3px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .ema-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 24px;
    justify-content: center;
    padding-top: 10px;
  }

  /* ===== Individual Ema Card ===== */
  .ema-card {
    position: relative;
    width: 220px;
    min-height: 160px;
    padding: 24px 16px 16px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    /* Wood ema board */
    background:
      linear-gradient(145deg,
        #E8C96E 0%, #D4B456 20%, #E8C96E 40%,
        #C8A24A 60%, #DEB668 80%, #D4B456 100%);
    border-radius: 4px;
    box-shadow:
      0 4px 12px rgba(92, 74, 30, 0.2),
      inset 0 1px 0 rgba(255,255,255,0.15);
    clip-path: polygon(0% 12%, 50% 0%, 100% 12%, 100% 100%, 0% 100%);
    animation: fadeHang 0.6s ease-out both;
    transition: transform 0.3s;
  }

  .ema-card:hover {
    transform: rotate(-1deg) translateY(-2px);
  }

  /* Wood grain texture */
  .ema-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background:
      repeating-linear-gradient(
        95deg,
        transparent,
        transparent 6px,
        rgba(139, 105, 20, 0.05) 6px,
        rgba(139, 105, 20, 0.05) 7px
      );
    pointer-events: none;
    clip-path: polygon(0% 12%, 50% 0%, 100% 12%, 100% 100%, 0% 100%);
  }

  /* Rope hole */
  .ema-card::after {
    content: '';
    position: absolute;
    top: 14px;
    left: 50%;
    transform: translateX(-50%);
    width: 8px;
    height: 8px;
    background: var(--cream);
    border-radius: 50%;
    border: 1.5px solid var(--wood-dark);
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.15);
  }

  /* Hanging string from rope */
  .ema-card-wrapper {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .ema-string {
    width: 2px;
    height: 20px;
    background: linear-gradient(180deg, var(--rope), var(--wood));
    margin-bottom: -2px;
  }

  .ema-message {
    font-family: 'Noto Serif TC', serif;
    font-size: 1rem;
    font-weight: 700;
    color: var(--ink);
    line-height: 1.6;
    margin-top: 6px;
    word-break: break-word;
    text-shadow: 0 0.5px 0 rgba(255,255,255,0.2);
  }

  .ema-author {
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 0.7rem;
    color: var(--wood-dark);
    margin-top: 10px;
    opacity: 0.7;
  }

  .ema-own-badge {
    position: absolute;
    bottom: 6px;
    right: 8px;
    font-size: 0.55rem;
    color: var(--vermillion);
    font-family: 'Zen Maru Gothic', sans-serif;
    opacity: 0.8;
  }

  @keyframes fadeHang {
    from {
      opacity: 0;
      transform: translateY(-20px) rotate(2deg);
    }
    to {
      opacity: 1;
      transform: translateY(0) rotate(0deg);
    }
  }

  /* Stagger animation */
  .ema-card-wrapper:nth-child(1) .ema-card { animation-delay: 0.05s; }
  .ema-card-wrapper:nth-child(2) .ema-card { animation-delay: 0.1s; }
  .ema-card-wrapper:nth-child(3) .ema-card { animation-delay: 0.15s; }
  .ema-card-wrapper:nth-child(4) .ema-card { animation-delay: 0.2s; }
  .ema-card-wrapper:nth-child(5) .ema-card { animation-delay: 0.25s; }
  .ema-card-wrapper:nth-child(6) .ema-card { animation-delay: 0.3s; }
  .ema-card-wrapper:nth-child(7) .ema-card { animation-delay: 0.35s; }
  .ema-card-wrapper:nth-child(8) .ema-card { animation-delay: 0.4s; }
  .ema-card-wrapper:nth-child(9) .ema-card { animation-delay: 0.45s; }
  .ema-card-wrapper:nth-child(10) .ema-card { animation-delay: 0.5s; }

  /* ===== Empty State ===== */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    font-family: 'Zen Maru Gothic', sans-serif;
    color: var(--ink-light);
    opacity: 0.6;
  }

  .empty-state .empty-icon {
    font-size: 2.5rem;
    margin-bottom: 12px;
  }

  /* ===== Toast / Notification ===== */
  .toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    padding: 12px 28px;
    background: var(--ink);
    color: var(--cream);
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 0.9rem;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    z-index: 1000;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    pointer-events: none;
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* ===== Loading spinner ===== */
  .loading {
    text-align: center;
    padding: 40px;
    z-index: 1;
    position: relative;
  }

  .spinner {
    display: inline-block;
    width: 32px;
    height: 32px;
    border: 3px solid var(--gold-light);
    border-top-color: var(--vermillion);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* ===== Footer ===== */
  .footer {
    text-align: center;
    padding: 20px;
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 0.7rem;
    color: var(--ink-light);
    opacity: 0.4;
    position: relative;
    z-index: 1;
  }

  /* ===== Falling petals (sakura) ===== */
  .petal {
    position: fixed;
    top: -20px;
    width: 12px;
    height: 12px;
    background: radial-gradient(ellipse at center, #FFB7C5 0%, #FF9CAD 60%, transparent 70%);
    border-radius: 50% 0 50% 50%;
    opacity: 0;
    pointer-events: none;
    z-index: 0;
    animation: fall linear infinite;
  }

  @keyframes fall {
    0% {
      opacity: 0;
      transform: translateX(0) rotate(0deg);
    }
    10% { opacity: 0.6; }
    90% { opacity: 0.4; }
    100% {
      opacity: 0;
      transform: translateX(80px) rotate(360deg);
      top: 100vh;
    }
  }

  /* ===== Responsive ===== */
  @media (max-width: 600px) {
    .ema-form-card { width: 280px; }
    .ema-card { width: 180px; min-height: 140px; }
    .ema-grid { gap: 16px; }
    .user-bar { gap: 10px; flex-wrap: wrap; }
    .torii-gate { padding: 0 40px; }
  }

  /* ===== Hidden utility ===== */
  .hidden { display: none !important; }
</style>
</head>

<body>

<!-- ===== Falling Petals ===== -->
<div id="petals-container"></div>

<!-- ===== Toast ===== -->
<div id="toast" class="toast"></div>

<!-- ===== LOGIN SCREEN ===== -->
<div id="screen-login">
  <div class="torii-header">
    <div class="torii-gate">
      <div class="torii-pillars left"></div>
      <div class="torii-pillars right"></div>
      <h1 class="header-title">Êñ∞Âπ¥Á•àÁ¶èÁâÜ</h1>
      <p class="header-subtitle">Êõ∏ÂØ´ÂøÉÈ°ò ¬∑ Áπ´‰∏äÁπ™È¶¨ ¬∑ Á•àÈ°òÊàêÂ∞±</p>
    </div>
    <div class="shimenawa">
      <div class="shimenawa-line"></div>
      <span class="shimenawa-tassel">üéç</span>
      <div class="shimenawa-line"></div>
    </div>
  </div>

  <div class="login-section">
    <div class="login-card">
      <h2>ÁôªÂÖ•‰ª•Ë®±‰∏ãÂøÉÈ°ò</h2>
      <p>‰ΩøÁî® Google Â∏≥ËôüÁôªÂÖ•Ôºå<br>Âú®Á•àÁ¶èÁâÜ‰∏äÁïô‰∏ãÊÇ®ÁöÑÊñ∞Âπ¥Á•ùÁ¶è</p>
      <button class="google-btn" onclick="handleGoogleLogin()">
        <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Google Â∏≥ËôüÁôªÂÖ•
      </button>
    </div>
  </div>
</div>

<!-- ===== MAIN SCREEN ===== -->
<div id="screen-main" class="hidden">
  <!-- User Bar -->
  <div class="user-bar">
    <div class="user-info">
      <img id="user-avatar" class="user-avatar" src="" alt="">
      <span id="user-name"></span>
    </div>
    <button class="btn-sm danger" onclick="handleLogout()">ÁôªÂá∫</button>
  </div>

  <!-- Header -->
  <div class="torii-header">
    <div class="torii-gate">
      <div class="torii-pillars left"></div>
      <div class="torii-pillars right"></div>
      <h1 class="header-title">Êñ∞Âπ¥Á•àÁ¶èÁâÜ</h1>
      <p class="header-subtitle">Êõ∏ÂØ´ÂøÉÈ°ò ¬∑ Áπ´‰∏äÁπ™È¶¨ ¬∑ Á•àÈ°òÊàêÂ∞±</p>
    </div>
    <div class="shimenawa">
      <div class="shimenawa-line"></div>
      <span class="shimenawa-tassel">üéç</span>
      <div class="shimenawa-line"></div>
    </div>
  </div>

  <!-- Ema Writing Form -->
  <div class="ema-form-section">
    <div class="ema-form-card">
      <div class="ema-form-label" id="form-label">ÂØ´‰∏ãÊÇ®ÁöÑÊñ∞Âπ¥Á•ùÁ¶è</div>
      <textarea
        id="blessing-input"
        class="ema-textarea"
        maxlength="30"
        placeholder="Âú®Ê≠§ÂØ´‰∏ãÂøÉÈ°ò..."
        oninput="handleInput()"
      ></textarea>
      <div id="char-count" class="char-count">0 / 30</div>
      <button id="submit-btn" class="ema-submit-btn" onclick="handleSubmit()">
        Áπ´‰∏äÁπ™È¶¨
      </button>
    </div>
  </div>

  <!-- My Blessing Actions -->
  <div id="my-blessing-actions" class="hidden" style="text-align:center; margin-bottom: 10px; position:relative; z-index:1;">
    <button class="btn-sm danger" onclick="handleDelete()">üóë Âèñ‰∏ãÊàëÁöÑÁπ™È¶¨</button>
  </div>

  <!-- Blessing Wall -->
  <div class="wall-section">
    <div class="wall-title"><span>Áπ™È¶¨Á•àÁ¶èÁâÜ</span></div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
    </div>

    <div id="ema-wall" class="hidden">
      <div class="ema-rope">
        <div id="ema-grid" class="ema-grid"></div>
      </div>
    </div>

    <div id="empty-state" class="empty-state hidden">
      <div class="empty-icon">üéê</div>
      <p>Â∞öÁÑ°Á•ùÁ¶èÔºåÊàêÁÇ∫Á¨¨‰∏Ä‰ΩçË®±È°òÁöÑ‰∫∫ÂêßÔºÅ</p>
    </div>
  </div>

  <div class="footer">Êñ∞Âπ¥Á•àÁ¶èÁâÜ ‚Äî È°òÊâÄÊúâÂøÉÈ°òÈÉΩËÉΩÂØ¶Áèæ üå∏</div>
</div>

<script>
// ============================================================
// ‚öôÔ∏è Ë®≠ÂÆöÂçÄ ‚Äî Ë´ã‰øÆÊîπÁÇ∫‰Ω†ÁöÑÂØ¶Èöõ URL
// ============================================================
const CONFIG = {
  // Google OAuth Client IDÔºàË´ãÊõøÊèõÁÇ∫‰Ω†ÁöÑ Google Client IDÔºâ
  GOOGLE_CLIENT_ID: '973721313231-0no4ivldu33he0kts8k51kn4tqd979g7.apps.googleusercontent.com',

  // n8n Webhook URLs
  API_AUTH:      'https://mjib007.zeabur.app/webhook/auth-blessing',
  API_GET:       'https://mjib007.zeabur.app/webhook/blessings-get',
  API_SAVE:      'https://mjib007.zeabur.app/webhook/blessings-save',
  API_DELETE:    'https://mjib007.zeabur.app/webhook/blessings-delete',
};

// ============================================================
// ÂÖ®ÂüüÁãÄÊÖã
// ============================================================
let currentUser = null;   // { googleId, displayName, email, photoUrl }
let myBlessing = null;    // ÁõÆÂâç‰ΩøÁî®ËÄÖÁöÑÁ•ùÁ¶è

// ============================================================
// Google ÁôªÂÖ•
// ============================================================
function initGoogleLogin() {
  if (typeof google === 'undefined' || !google.accounts) {
    // GIS Â∞öÊú™ËºâÂÖ•ÔºåÁ®çÁ≠âÈáçË©¶
    setTimeout(initGoogleLogin, 300);
    return;
  }
  google.accounts.id.initialize({
    client_id: CONFIG.GOOGLE_CLIENT_ID,
    callback: onGoogleCredential,
    auto_select: false,
  });
}

function handleGoogleLogin() {
  if (typeof google === 'undefined' || !google.accounts) {
    showToast('Google ÁôªÂÖ•ÂÖÉ‰ª∂ËºâÂÖ•‰∏≠ÔºåË´ãÁ®çÂæåÂÜçË©¶');
    return;
  }
  google.accounts.id.prompt((notification) => {
    if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
      // One Tap Ë¢´ÊìãÔºåÊîπÁî® popup
      google.accounts.oauth2.initTokenClient({
        client_id: CONFIG.GOOGLE_CLIENT_ID,
        scope: 'profile email',
        callback: async (response) => {
          if (response.access_token) {
            const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
              headers: { Authorization: `Bearer ${response.access_token}` }
            });
            const profile = await res.json();
            loginWithProfile({
              googleId: profile.sub,
              displayName: profile.name,
              email: profile.email,
              photoUrl: profile.picture
            });
          }
        }
      }).requestAccessToken();
    }
  });
}

function onGoogleCredential(response) {
  const payload = parseJwt(response.credential);
  loginWithProfile({
    googleId: payload.sub,
    displayName: payload.name,
    email: payload.email,
    photoUrl: payload.picture
  });
}

function parseJwt(token) {
  const base64 = token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
  return JSON.parse(decodeURIComponent(atob(base64).split('').map(c =>
    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
  ).join('')));
}

async function loginWithProfile(profile) {
  currentUser = profile;

  // ÂêåÊ≠•Âà∞ n8n ÊúÉÂì°Á≥ªÁµ±
  try {
    await fetch(CONFIG.API_AUTH, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        googleId: profile.googleId,
        displayName: profile.displayName,
        email: profile.email
      })
    });
  } catch (e) {
    console.warn('ÊúÉÂì°ÂêåÊ≠•Â§±ÊïóÔºå‰ΩÜ‰∏çÂΩ±Èüø‰ΩøÁî®', e);
  }

  // ÂÑ≤Â≠ò session
  sessionStorage.setItem('user', JSON.stringify(currentUser));

  showMainScreen();
}

function handleLogout() {
  currentUser = null;
  myBlessing = null;
  sessionStorage.removeItem('user');
  document.getElementById('screen-login').classList.remove('hidden');
  document.getElementById('screen-main').classList.add('hidden');
}

// ============================================================
// Áï´Èù¢ÂàáÊèõ
// ============================================================
async function showMainScreen() {
  document.getElementById('screen-login').classList.add('hidden');
  document.getElementById('screen-main').classList.remove('hidden');

  // Ë®≠ÂÆö‰ΩøÁî®ËÄÖË≥áË®ä
  document.getElementById('user-name').textContent = currentUser.displayName;
  const avatar = document.getElementById('user-avatar');
  if (currentUser.photoUrl) {
    avatar.src = currentUser.photoUrl;
    avatar.style.display = '';
  } else {
    avatar.style.display = 'none';
  }

  await loadBlessings();
}

// ============================================================
// ËÆÄÂèñÁ•ùÁ¶è
// ============================================================
async function loadBlessings() {
  const loading = document.getElementById('loading');
  const wall = document.getElementById('ema-wall');
  const empty = document.getElementById('empty-state');
  const grid = document.getElementById('ema-grid');

  loading.classList.remove('hidden');
  wall.classList.add('hidden');
  empty.classList.add('hidden');

  try {
    const res = await fetch(CONFIG.API_GET);
    const data = await res.json();

    loading.classList.add('hidden');

    if (!data.blessings || data.blessings.length === 0) {
      empty.classList.remove('hidden');
      grid.innerHTML = '';
      myBlessing = null;
      updateFormState();
      return;
    }

    // Ê∏≤ÊüìÁπ™È¶¨
    grid.innerHTML = '';
    myBlessing = null;

    data.blessings.forEach((b, i) => {
      const isOwn = b.googleId === currentUser.googleId;
      if (isOwn) myBlessing = b;

      const wrapper = document.createElement('div');
      wrapper.className = 'ema-card-wrapper';
      wrapper.style.animationDelay = `${i * 0.05}s`;

      wrapper.innerHTML = `
        <div class="ema-string"></div>
        <div class="ema-card" style="animation-delay: ${i * 0.08}s">
          <div class="ema-message">${escapeHtml(b.message)}</div>
          <div class="ema-author">‚Äî ${escapeHtml(b.displayName)}</div>
          ${isOwn ? '<div class="ema-own-badge">‚ú¶ ÊàëÁöÑÁπ™È¶¨</div>' : ''}
        </div>
      `;

      grid.appendChild(wrapper);
    });

    wall.classList.remove('hidden');
    updateFormState();

  } catch (e) {
    loading.classList.add('hidden');
    showToast('ËºâÂÖ•Á•àÁ¶èÁâÜÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
    console.error(e);
  }
}

// ============================================================
// Ë°®ÂñÆÁãÄÊÖã
// ============================================================
function updateFormState() {
  const input = document.getElementById('blessing-input');
  const btn = document.getElementById('submit-btn');
  const label = document.getElementById('form-label');
  const actions = document.getElementById('my-blessing-actions');

  if (myBlessing) {
    input.value = myBlessing.message;
    btn.textContent = '‰øÆÊîπÁπ™È¶¨';
    label.textContent = '‰øÆÊîπÊÇ®ÁöÑÁ•ùÁ¶è';
    actions.classList.remove('hidden');
  } else {
    input.value = '';
    btn.textContent = 'Áπ´‰∏äÁπ™È¶¨';
    label.textContent = 'ÂØ´‰∏ãÊÇ®ÁöÑÊñ∞Âπ¥Á•ùÁ¶è';
    actions.classList.add('hidden');
  }
  updateCharCount();
}

function handleInput() {
  const input = document.getElementById('blessing-input');
  // ÈÅéÊøæÊèõË°åÁ¨¶ÔºåÁ•ùÁ¶èË™ûÂè™ÂÖÅË®±ÂñÆË°å
  input.value = input.value.replace(/[\r\n]/g, '');
  updateCharCount();
}

function updateCharCount() {
  const input = document.getElementById('blessing-input');
  const counter = document.getElementById('char-count');
  const len = input.value.length;
  counter.textContent = `${len} / 30`;
  counter.className = len >= 28 ? 'char-count warn' : 'char-count';
}

// ============================================================
// ÂÑ≤Â≠òÁ•ùÁ¶è
// ============================================================
async function handleSubmit() {
  const input = document.getElementById('blessing-input');
  const message = input.value.trim();
  const btn = document.getElementById('submit-btn');

  if (!message) {
    showToast('Ë´ãÂØ´‰∏ãÊÇ®ÁöÑÁ•ùÁ¶è üôè');
    return;
  }
  if (message.length > 30) {
    showToast('Á•ùÁ¶èË™û‰∏çËÉΩË∂ÖÈÅé 30 Â≠ó');
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Á•àÈ°ò‰∏≠...';

  try {
    const res = await fetch(CONFIG.API_SAVE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        googleId: currentUser.googleId,
        displayName: currentUser.displayName,
        message: message
      })
    });

    const data = await res.json();

    if (data.success) {
      showToast(data.action === 'updated' ? 'Áπ™È¶¨Â∑≤Êõ¥Êñ∞ ‚ú®' : 'Áπ™È¶¨Â∑≤Áπ´‰∏ä üéç');
      await loadBlessings();
    } else {
      showToast(data.error || 'Êìç‰ΩúÂ§±Êïó');
    }
  } catch (e) {
    showToast('ÂÑ≤Â≠òÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
    console.error(e);
  }

  btn.disabled = false;
  updateFormState();
}

// ============================================================
// Âà™Èô§Á•ùÁ¶è
// ============================================================
async function handleDelete() {
  if (!confirm('Á¢∫ÂÆöË¶ÅÂèñ‰∏ãÊÇ®ÁöÑÁπ™È¶¨ÂóéÔºü')) return;

  try {
    const res = await fetch(CONFIG.API_DELETE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        googleId: currentUser.googleId
      })
    });

    const data = await res.json();

    if (data.success) {
      showToast('Áπ™È¶¨Â∑≤Âèñ‰∏ã üçÉ');
      myBlessing = null;
      await loadBlessings();
    } else {
      showToast(data.error || 'Âà™Èô§Â§±Êïó');
    }
  } catch (e) {
    showToast('Âà™Èô§Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
    console.error(e);
  }
}

// ============================================================
// Toast ÈÄöÁü•
// ============================================================
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ============================================================
// Â∑•ÂÖ∑
// ============================================================
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ============================================================
// Ê´ªËä±Ëä±Áì£
// ============================================================
function createPetals() {
  const container = document.getElementById('petals-container');
  const count = window.innerWidth < 600 ? 8 : 15;

  for (let i = 0; i < count; i++) {
    const petal = document.createElement('div');
    petal.className = 'petal';
    petal.style.left = Math.random() * 100 + 'vw';
    petal.style.animationDuration = (6 + Math.random() * 8) + 's';
    petal.style.animationDelay = (Math.random() * 10) + 's';
    petal.style.width = (8 + Math.random() * 8) + 'px';
    petal.style.height = petal.style.width;
    container.appendChild(petal);
  }
}

// ============================================================
// ÂàùÂßãÂåñ
// ============================================================
window.addEventListener('DOMContentLoaded', () => {
  createPetals();
  initGoogleLogin();

  // Ê™¢Êü•ÊòØÂê¶Êúâ session
  const saved = sessionStorage.getItem('user');
  if (saved) {
    currentUser = JSON.parse(saved);
    showMainScreen();
  }
});
</script>

</body>
</html>
