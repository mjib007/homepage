<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IRAC æ³•å¾‹æ€ç¶­å°èˆªå„€</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #c0392b;
            --success-color: #27ae60;
            --info-color: #3498db;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Helvetica Neue", Arial, "PingFang TC", "Heiti TC", sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: #333;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0;
            z-index: 20;
        }

        h1 { margin: 0; font-size: 1.5rem; }
        .subtitle { font-size: 0.9rem; opacity: 0.8; }

        /* Case Selector */
        .case-selector {
            background: #ecf0f1;
            padding: 1rem 2rem;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .case-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
            min-width: 200px;
        }

        .case-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .badge-criminal { background: #e74c3c; color: white; }
        .badge-civil { background: #3498db; color: white; }
        .badge-beginner { background: #27ae60; color: white; }
        .badge-intermediate { background: #f39c12; color: white; }

        /* Main Layout */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* æ‰‹æ©Ÿç‰ˆå°ˆç”¨ï¼šåˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
        .mobile-case-toggle {
            display: none;
            background: #ecf0f1;
            color: var(--primary-color);
            padding: 12px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
            font-size: 1rem;
            z-index: 15;
        }
        .mobile-case-toggle:hover { background: #dee2e6; }

        /* Left Panel: Case Facts */
        .left-panel {
            width: 35%;
            background-color: #eef2f5;
            padding: 2rem;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .case-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            line-height: 1.8;
        }

        .case-title {
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--accent-color);
            display: inline-block;
            padding-bottom: 5px;
        }

        /* åƒè€ƒç¯„ä¾‹æŒ‰éˆ•æ¨£å¼ */
        .example-button {
            background: var(--info-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95rem;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .example-button:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .example-content {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 8px;
            border-left: 4px solid var(--info-color);
        }

        .example-content h4 {
            color: var(--primary-color);
            margin-top: 0;
        }

        .example-text {
            color: #27ae60;
            font-style: italic;
            line-height: 1.8;
            font-size: 0.9rem;
        }

        /* ç·´ç¿’æ¨¡å¼æ¨™ç¤º */
        .practice-mode-indicator {
            display: none;
            background: #f39c12;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin: 10px 0;
            text-align: center;
        }

        /* Right Panel: Interaction */
        .right-panel {
            width: 65%;
            display: flex;
            flex-direction: column;
            padding: 0;
            background: white;
        }

        /* Progress Bar */
        .progress-bar {
            display: flex;
            justify-content: space-around;
            padding: 1.5rem;
            background: #fff;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.4;
            transition: all 0.3s;
            position: relative;
            flex: 1;
        }

        .step.active { opacity: 1; font-weight: bold; color: var(--primary-color); }
        .step.completed { opacity: 1; color: var(--success-color); }
        
        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #ccc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .step.active .step-circle { background: var(--primary-color); transform: scale(1.1); }
        .step.completed .step-circle { background: var(--success-color); }

        /* Chat Area */
        .chat-history {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            max-width: 80%;
            padding: 1rem;
            border-radius: 12px;
            line-height: 1.6;
            position: relative;
            word-wrap: break-word;
        }

        .ai-message {
            align-self: flex-start;
            background-color: #f0f4f8;
            color: #2c3e50;
            border-left: 4px solid var(--primary-color);
        }
        
        .ai-message.feedback-fail {
            background-color: #fff5f5;
            border-left-color: var(--accent-color);
        }

        .ai-message.feedback-pass {
            background-color: #e8f8f5;
            border-left-color: var(--success-color);
        }

        .ai-message.hint {
            background-color: #fff9e6;
            border-left-color: #f39c12;
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
        }

        /* Input Area - æ”¹å–„å¾Œçš„æ¨£å¼ */
        .input-area {
            padding: 2rem;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            flex-shrink: 0;
        }

        textarea {
            flex: 1;
            padding: 1rem;
            border: 2px solid #eee;
            border-radius: 8px;
            resize: vertical;
            font-size: 1rem;
            height: 120px;
            min-height: 80px;
            max-height: 250px;
            font-family: inherit;
            line-height: 1.5;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        button {
            padding: 0 2rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
            height: 120px;
        }

        button:hover { background-color: #34495e; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* æ¬¡è¦æ§åˆ¶å€åŸŸ */
        .secondary-controls {
            padding: 1rem 2rem;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-shrink: 0;
        }

        .practice-button {
            background: #f39c12;
            padding: 8px 16px;
            height: auto;
        }

        .practice-button:hover {
            background: #e67e22;
        }

        /* Loading dots */
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼ CSS */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            header { padding: 0.8rem 1rem; }
            h1 { font-size: 1.2rem; }
            .course-info { display: none; }

            .case-selector { padding: 0.8rem 1rem; }
            .case-selector select { min-width: 150px; font-size: 0.8rem; }

            .mobile-case-toggle { display: block; }

            .left-panel {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 50;
                display: none;
                border-right: none;
                padding: 1.5rem;
            }

            .left-panel.show {
                display: block;
                animation: slideDown 0.3s ease-out;
            }

            .right-panel {
                width: 100%;
                height: 100%;
            }

            .progress-bar { padding: 10px 5px; }
            .step span { font-size: 0.7rem; display: none; }
            .step.active span { display: block; }
            .step-circle { width: 25px; height: 25px; font-size: 12px; }

            .chat-history { padding: 1rem; gap: 1rem; }
            .message { max-width: 90%; padding: 0.8rem; font-size: 0.95rem; }

            .input-area { padding: 0.8rem; gap: 0.5rem; }
            textarea { 
                padding: 0.8rem; 
                height: 100px; 
                min-height: 70px; 
                max-height: 180px; 
            }
            button { padding: 0 1rem; height: 100px; font-size: 0.9rem; }
            
            .secondary-controls { padding: 0.8rem 1rem; }
            .practice-button span { display: none; }
            .practice-button::after { content: "ğŸ¯"; }
            .practice-button { font-size: 1.2rem; padding: 8px 12px; }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body>

<header>
    <div>
        <h1>IRAC æ³•å¾‹æ€ç¶­å°èˆªå„€</h1>
        <span class="subtitle">AI-Powered Legal Reasoning Trainer</span>
    </div>
    <div class="course-info" style="font-size: 0.9rem;">èª²ç¨‹ï¼šæ³•å¾‹èˆ‡äººå·¥æ™ºæ…§</div>
</header>

<div class="case-selector">
    <label for="caseSelect"><strong>ğŸ“š é¸æ“‡æ¡ˆä¾‹ï¼š</strong></label>
    <select id="caseSelect" onchange="switchCase()">
        <option value="self_defense">æ­£ç•¶é˜²è¡›æ¡ˆä¾‹</option>
        <option value="theft_basic">ç«Šç›œæ¡ˆä¾‹</option>
        <option value="contract_dispute">å¥‘ç´„å±¥è¡Œçˆ­è­°</option>
    </select>
    <span id="caseType" class="case-badge badge-criminal">åˆ‘æ³•</span>
    <span id="caseDifficulty" class="case-badge badge-beginner">åˆç´š</span>
</div>

<div class="mobile-case-toggle" onclick="toggleMobileCase()">
    ğŸ“„ é»æ“ŠæŸ¥çœ‹/éš±è— æ¡ˆä¾‹äº‹å¯¦
</div>

<div class="container">
    <div class="left-panel" id="leftPanel">
        <div class="case-card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="case-title" style="margin-bottom:0;" id="caseTitle">æ¡ˆä¾‹äº‹å¯¦ (Case Facts)</div>
                <button onclick="toggleMobileCase()" class="mobile-close-btn" style="display:none; width:auto; height:auto; padding:5px 10px; background:none; color:#999; font-size:1.2rem;">âœ•</button>
            </div>
            
            <p id="caseFactsText" style="margin-top: 1rem;">
                <!-- æ¡ˆä¾‹äº‹å¯¦å°‡ç”± JavaScript å‹•æ…‹æ›´æ–° -->
            </p>
            
            <button onclick="toggleMobileCase()" class="mobile-close-btn" style="width:100%; margin-top:15px; height:45px; background:#7f8c8d; display:none;">
                å›åˆ°å°è©±
            </button>
        </div>
        
        <button class="example-button" onclick="toggleExample()">
            ğŸ“– æŸ¥çœ‹åƒè€ƒç¯„ä¾‹
        </button>
        
        <div id="exampleContent" class="example-content">
            <h4>ğŸ“ å„éšæ®µç­”é¡Œç¯„ä¾‹ï¼š</h4>
            <!-- ç¯„ä¾‹å…§å®¹å°‡ç”± JavaScript å‹•æ…‹æ›´æ–° -->
        </div>
        
        <div style="margin-top: 20px; color: #666; font-size: 0.85rem;">
            <p><strong>ğŸ’¡ è€å¸«çš„å°æç¤ºï¼š</strong></p>
            <ul>
                <li>è«‹ä¸è¦æ€¥è‘—åˆ¤æ–·æœ‰ç½ªç„¡ç½ªã€‚</li>
                <li>ä¾ç…§å³å´çš„å°èˆªï¼Œä¸€æ­¥ä¸€æ­¥å»ºç«‹è«–è­‰ã€‚</li>
                <li>AI å°‡æ“”ä»»ä½ çš„ã€Œè˜‡æ ¼æ‹‰åº•å°å¸«ã€ã€‚</li>
                <li>å¡é—œæ™‚å¯ä»¥é»æ“Šã€Œç·´ç¿’æ¨¡å¼ã€ç²å¾—æ›´å¤šæç¤ºã€‚</li>
            </ul>
        </div>
    </div>

    <div class="right-panel">
        <div class="progress-bar">
            <div class="step active" id="step-issue">
                <div class="step-circle">I</div>
                <span>çˆ­é» (Issue)</span>
            </div>
            <div class="step" id="step-rule">
                <div class="step-circle">R</div>
                <span>è¦å‰‡ (Rule)</span>
            </div>
            <div class="step" id="step-application">
                <div class="step-circle">A</div>
                <span>æ¶µæ” (Application)</span>
            </div>
            <div class="step" id="step-conclusion">
                <div class="step-circle">C</div>
                <span>çµè«– (Conclusion)</span>
            </div>
        </div>

        <div id="practiceModeIndicator" class="practice-mode-indicator">
            ğŸ¯ ç·´ç¿’æ¨¡å¼é–‹å•Ÿä¸­ - AIæœƒæä¾›æ›´å¤šå¼•å°
        </div>

        <div class="chat-history" id="chatHistory">
            <div class="message ai-message">
                æ­¡è¿ä¾†åˆ°æ€ç¶­è¨“ç·´ã€‚æˆ‘å€‘å¾ç¬¬ä¸€æ­¥é–‹å§‹ï¼š<br><br>
                <strong>è«‹æŒ‡å‡ºæœ¬æ¡ˆæœ€æ ¸å¿ƒçš„æ³•å¾‹çˆ­é»ï¼ˆIssueï¼‰æ˜¯ä»€éº¼ï¼Ÿ</strong><br>
                ï¼ˆè«‹è©¦è‘—ç”¨å•å¥å½¢å¼æå‡ºï¼Œä¾‹å¦‚ï¼šç”²çš„è¡Œç‚ºæ˜¯å¦æ§‹æˆ...ï¼Ÿï¼‰
            </div>
        </div>

        <div class="input-area">
            <textarea id="userInput" placeholder="åœ¨æ­¤è¼¸å…¥ä½ çš„æƒ³æ³•..."></textarea>
            <button id="sendBtn" onclick="handleSubmit()">é€å‡º</button>
        </div>
        
        <div class="secondary-controls">
            <button class="practice-button" onclick="togglePracticeMode()">
                <span>ğŸ¯ ç·´ç¿’æ¨¡å¼</span>
            </button>
        </div>
    </div>
</div>

<script>
    // =================CONFIG=================
    const N8N_WEBHOOK_URL = "https://kf0630.zeabur.app/webhook/irac-tutor"; 
    
    // æ¡ˆä¾‹è³‡æ–™åº«
    const CASE_DATABASE = {
        "self_defense": {
            id: "self_defense",
            title: "æ­£ç•¶é˜²è¡›æ¡ˆä¾‹",
            type: "åˆ‘æ³•",
            difficulty: "åˆç´š",
            facts: `ç”²ï¼ˆç”·ï¼Œ30æ­²ï¼‰èˆ‡ä¹™ï¼ˆç”·ï¼Œ28æ­²ï¼‰ç‚ºé„°å±…ï¼Œç´ æœ‰ç©æ€¨ã€‚æŸæ—¥æ™šé–“ï¼Œå…©äººåœ¨ç¤¾å€é–€å£ç›¸é‡ï¼Œç™¼ç”Ÿæ¿€çƒˆå£è§’ã€‚ä¹™çªç„¶å¾å£è¢‹æ‹¿å‡ºæŠ˜ç–Šåˆ€ï¼Œå°ç”²å«å›‚ï¼šã€Œä¿¡ä¸ä¿¡æˆ‘æ…æ­»ä½ ï¼ã€ä¸¦å‘ç”²é€¼è¿‘ã€‚

ç”²è¦‹ç‹€é©šæï¼Œéš¨æ‰‹æ‹¿èµ·è·¯é‚Šçš„ç£šé ­ä¸Ÿå‘ä¹™ã€‚ç£šé ­æ“Šä¸­ä¹™çš„é ­éƒ¨ï¼Œä¹™ç•¶å ´å€’åœ°ï¼Œé€é†«å¾Œå› é¡±å…§å‡ºè¡€ä¸æ²»æ­»äº¡ã€‚

è«‹ä¾æ“šä¸Šè¿°äº‹å¯¦ï¼Œåˆ†æç”²çš„åˆ‘äº‹è²¬ä»»ã€‚`,
            examples: {
                issue: "ç”²çš„è¡Œç‚ºæ˜¯å¦ç¬¦åˆåˆ‘æ³•ç¬¬23æ¢ä¹‹æ­£ç•¶é˜²è¡›ï¼Ÿ",
                rule: "åˆ‘æ³•ç¬¬277æ¢å‚·å®³ç½ªï¼šæ•…æ„å‚·å®³ä»–äººèº«é«”<br>åˆ‘æ³•ç¬¬276æ¢éå¤±è‡´æ­»ç½ªï¼šéå¤±è‡´äººæ–¼æ­»<br>åˆ‘æ³•ç¬¬23æ¢æ­£ç•¶é˜²è¡›ï¼šç¾åœ¨ä¸æ³•ä¾µå®³ã€é˜²è¡›è¡Œç‚ºã€å¿…è¦æ€§",
                application: `å› ç‚ºã€Œç”²åœ¨ä¹™æŒåˆ€å¨è„…ç”Ÿå‘½çš„ç·Šæ€¥ç‹€æ³ä¸‹ï¼Œå‡ºæ–¼ä¿è­·è‡ªå·±è€Œä¸Ÿæ“²ç£šé ­ã€ï¼Œ<br>ç¬¦åˆã€Œæ­£ç•¶é˜²è¡›çš„é˜²è¡›æ„åœ–è¦ä»¶ã€ï¼Œ<br>æ‰€ä»¥ã€Œç”²ä¸»è§€ä¸Šå…·æœ‰é˜²è¡›æ„åœ–è€Œéå‚·å®³æ•…æ„ã€ã€‚<br><br>å› ç‚ºã€Œä¹™æŒåˆ€é€¼è¿‘æ§‹æˆç¾åœ¨é€²è¡Œä¸­çš„ä¸æ³•ä¾µå®³ã€ï¼Œ<br>ç¬¦åˆã€Œåˆ‘æ³•ç¬¬23æ¢æ­£ç•¶é˜²è¡›çš„æ™‚é–“è¦ä»¶ã€ï¼Œ<br>æ‰€ä»¥ã€Œç”²çš„é˜²è¡›è¡Œç‚ºæ™‚æ©Ÿæ­£ç•¶ã€ã€‚`,
                conclusion: "ç”²çš„è¡Œç‚ºç¬¦åˆæ­£ç•¶é˜²è¡›ï¼Œé˜»å»é•æ³•ï¼Œä¸æ§‹æˆçŠ¯ç½ªã€‚"
            },
            hints: {
                issue: ["æƒ³æƒ³ç”²çš„è¡Œç‚ºæ€§è³ªæ˜¯ä»€éº¼ï¼Ÿ", "æ˜¯æ”»æ“Šé‚„æ˜¯é˜²è¡›ï¼Ÿ", "å¯ä»¥å•ã€Œç”²çš„è¡Œç‚ºæ˜¯å¦ç¬¦åˆæ­£ç•¶é˜²è¡›ï¼Ÿã€"],
                rule: ["æƒ³æƒ³æœ‰å“ªäº›ç›¸é—œæ³•æ¢ï¼Ÿåˆ‘æ³•ç¬¬277æ¢ï¼Ÿç¬¬23æ¢ï¼Ÿ", "æ­£ç•¶é˜²è¡›çš„è¦ä»¶æ˜¯ä»€éº¼ï¼Ÿ", "åˆ—å‡ºã€Œç¾åœ¨ä¸æ³•ä¾µå®³ã€ã€ã€Œé˜²è¡›è¡Œç‚ºã€ã€ã€Œå¿…è¦æ€§ã€"],
                application: ["è¨˜å¾—ä½¿ç”¨ã€Œå› ç‚º...ç¬¦åˆ...æ‰€ä»¥ã€çš„å¥å‹", "å…ˆèªªæ˜ç”²çš„ä¸»è§€æ„åœ–ï¼ˆé˜²è¡›é‚„æ˜¯å‚·å®³ï¼Ÿï¼‰", "å†èªªæ˜å®¢è§€ä¸Šæ˜¯å¦ç¬¦åˆæ­£ç•¶é˜²è¡›çš„è¦ä»¶"],
                conclusion: ["æ ¹æ“šå‰é¢çš„åˆ†æï¼Œçµ¦å‡ºæ˜ç¢ºçµè«–", "ç”²çš„è¡Œç‚ºæ˜¯å¦æ§‹æˆçŠ¯ç½ªï¼Ÿ", "å¦‚æœæ˜¯æ­£ç•¶é˜²è¡›ï¼Œçµè«–æ‡‰è©²æ˜¯ã€Œä¸æ§‹æˆçŠ¯ç½ªã€"]
            }
        },
        "theft_basic": {
            id: "theft_basic",
            title: "ç«Šç›œæ¡ˆä¾‹",
            type: "åˆ‘æ³•",
            difficulty: "åˆç´š",
            facts: `ç”²ï¼ˆç”·ï¼Œ25æ­²ï¼‰å› å¤±æ¥­ç¼ºéŒ¢ï¼ŒæŸæ—¥æ·±å¤œè¦‹é„°å±…ä¹™å®¶é–€çª—æœªé–ï¼Œé‚æ½›å…¥ä¹™å®¶å®¢å»³ï¼Œç«Šå–æ”¾åœ¨æ¡Œä¸Šçš„ç¾é‡‘æ–°å°å¹£5,000å…ƒåŠæ‰‹æ©Ÿä¸€æ”¯å¾Œé›¢å»ã€‚

éš”æ—¥ä¸Šåˆï¼Œä¹™ç™¼ç¾è²¡ç‰©é­ç«Šï¼ŒæŸ¥çœ‹ç›£è¦–å™¨ç™¼ç¾ç”²çš„èº«å½±ï¼Œéš¨å³å ±è­¦ã€‚è­¦æ–¹å¾ªç·šé€®æ•ç”²ï¼Œç”²å¦æ‰¿çŠ¯è¡Œã€‚

è«‹åˆ†æç”²çš„åˆ‘äº‹è²¬ä»»ã€‚`,
            examples: {
                issue: "ç”²æ˜¯å¦æ§‹æˆåˆ‘æ³•ç¬¬320æ¢ä¹‹ç«Šç›œç½ªï¼Ÿ",
                rule: "åˆ‘æ³•ç¬¬320æ¢ç«Šç›œç½ªï¼šæ„åœ–ç‚ºè‡ªå·±æˆ–ç¬¬ä¸‰äººä¸æ³•ä¹‹æ‰€æœ‰ï¼Œè€Œç«Šå–ä»–äººä¹‹å‹•ç”¢<br>æ§‹æˆè¦ä»¶ï¼šï¼ˆ1ï¼‰å®¢è§€ä¸Šç«Šå–ä»–äººå‹•ç”¢ï¼ˆ2ï¼‰ä¸»è§€ä¸Šå…·ä¸æ³•æ‰€æœ‰æ„åœ–",
                application: `å› ç‚ºã€Œç”²æ½›å…¥ä¹™å®¶æ‹¿å–ç¾é‡‘å’Œæ‰‹æ©Ÿã€ï¼Œ<br>ç¬¦åˆã€Œç«Šå–ä»–äººå‹•ç”¢çš„å®¢è§€è¡Œç‚ºè¦ä»¶ã€ï¼Œ<br>æ‰€ä»¥ã€Œç”²å®¢è§€ä¸Šå¯¦æ–½äº†ç«Šå–è¡Œç‚ºã€ã€‚<br><br>å› ç‚ºã€Œç”²å› ç¼ºéŒ¢è€Œç«Šå–ï¼Œæ„åœ–æ“šç‚ºå·±æœ‰ã€ï¼Œ<br>ç¬¦åˆã€Œä¸æ³•æ‰€æœ‰æ„åœ–çš„ä¸»è§€è¦ä»¶ã€ï¼Œ<br>æ‰€ä»¥ã€Œç”²ä¸»è§€ä¸Šå…·å‚™çŠ¯ç½ªæ•…æ„ã€ã€‚`,
                conclusion: "ç”²çš„è¡Œç‚ºå®Œå…¨ç¬¦åˆç«Šç›œç½ªæ§‹æˆè¦ä»¶ï¼Œæˆç«‹ç«Šç›œç½ªã€‚"
            },
            hints: {
                issue: ["ç”²çš„è¡Œç‚ºæ¶‰åŠä»€éº¼çŠ¯ç½ªï¼Ÿ", "æ˜¯ç«Šç›œé‚„æ˜¯å…¶ä»–ç½ªåï¼Ÿ", "å¯ä»¥å•ã€Œç”²æ˜¯å¦æ§‹æˆç«Šç›œç½ªï¼Ÿã€"],
                rule: ["ç«Šç›œç½ªçš„æ³•æ¢æ˜¯ä»€éº¼ï¼Ÿ", "åˆ‘æ³•ç¬¬320æ¢çš„æ§‹æˆè¦ä»¶", "åˆ—å‡ºã€Œç«Šå–ä»–äººå‹•ç”¢ã€ã€ã€Œä¸æ³•æ‰€æœ‰æ„åœ–ã€ç­‰è¦ä»¶"],
                application: ["ç”²æ˜¯å¦æœ‰ç«Šå–è¡Œç‚ºï¼Ÿ", "ç”²æ˜¯å¦å…·æœ‰ä¸æ³•æ‰€æœ‰æ„åœ–ï¼Ÿ", "å®¢è§€ä¸Šæ˜¯å¦ç¬¦åˆç«Šç›œç½ªæ§‹æˆè¦ä»¶ï¼Ÿ"],
                conclusion: ["ç”²æ˜¯å¦æ§‹æˆç«Šç›œç½ªï¼Ÿ", "æ ¹æ“šåˆ†æçµ¦å‡ºæ˜ç¢ºçµè«–"]
            }
        },
        "contract_dispute": {
            id: "contract_dispute",
            title: "å¥‘ç´„å±¥è¡Œçˆ­è­°",
            type: "æ°‘æ³•",
            difficulty: "ä¸­ç´š",
            facts: `ç”²æ¬²å‡ºå”®å…¶æ‰€æœ‰ä¹‹æˆ¿å±‹ï¼Œèˆ‡ä¹™ç°½è¨‚ä¸å‹•ç”¢è²·è³£å¥‘ç´„ï¼Œç´„å®šåƒ¹é‡‘ç‚ºæ–°å°å¹£1,000è¬å…ƒï¼Œä¹™æ‡‰æ–¼ç°½ç´„å¾Œ30æ—¥å…§ä»˜æ¸…åƒ¹é‡‘ï¼Œç”²å‰‡æ–¼æ”¶åˆ°åƒ¹é‡‘å¾Œè¾¦ç†æ‰€æœ‰æ¬Šç§»è½‰ç™»è¨˜ã€‚

å¥‘ç´„ç°½è¨‚å¾Œç¬¬25æ—¥ï¼Œä¹™è¡¨ç¤ºå› éŠ€è¡Œè²¸æ¬¾æœªé€šéï¼Œç„¡æ³•å¦‚æœŸä»˜æ¬¾ï¼Œè«‹æ±‚å»¶æœŸ30æ—¥ã€‚ç”²ä¸åŒæ„å»¶æœŸï¼Œæ–¼ç¬¬31æ—¥ç™¼å‡½å‚¬å‘Šä¹™æ–¼10æ—¥å…§ä»˜æ¬¾ï¼Œå¦å‰‡è§£é™¤å¥‘ç´„ã€‚ä¹™æœªæ–¼æœŸé™å…§ä»˜æ¬¾ã€‚

ç”²æ¬²è§£é™¤å¥‘ç´„ä¸¦è«‹æ±‚é•ç´„é‡‘ã€‚è«‹åˆ†æç›¸é—œæ³•å¾‹å•é¡Œã€‚`,
            examples: {
                issue: "ç”²æ˜¯å¦å¯ä¾æ°‘æ³•ç¬¬254æ¢è§£é™¤èˆ‡ä¹™ä¹‹è²·è³£å¥‘ç´„ï¼Ÿ",
                rule: "æ°‘æ³•ç¬¬254æ¢ï¼šå¥‘ç´„ç•¶äº‹äººä¹‹ä¸€æ–¹é²å»¶çµ¦ä»˜è€…ï¼Œä»–æ–¹ç•¶äº‹äººå¾—å®šç›¸ç•¶æœŸé™å‚¬å‘Šå…¶å±¥è¡Œï¼Œæ–¼æœŸé™å…§ä¸å±¥è¡Œæ™‚ï¼Œå¾—è§£é™¤å…¶å¥‘ç´„<br>æ§‹æˆè¦ä»¶ï¼šï¼ˆ1ï¼‰å‚µå‹™äººçµ¦ä»˜é²å»¶ï¼ˆ2ï¼‰å‚¬å‘Šç¨‹åºåˆæ³•ï¼ˆ3ï¼‰ç¶“å‚¬å‘Šä»ä¸å±¥è¡Œ",
                application: `å› ç‚ºã€Œä¹™é€¾æœŸç¬¬31æ—¥ä»æœªä»˜æ¬¾ã€ï¼Œ<br>ç¬¦åˆã€Œå‚µå‹™äººçµ¦ä»˜é²å»¶çš„å®¢è§€äº‹å¯¦ã€ï¼Œ<br>æ‰€ä»¥ã€Œä¹™æ§‹æˆçµ¦ä»˜é²å»¶ã€ã€‚<br><br>å› ç‚ºã€Œç”²æ–¼ç¬¬31æ—¥ç™¼å‡½å‚¬å‘Šä¸¦çµ¦äºˆ10æ—¥å¯¬é™æœŸã€ï¼Œ<br>ç¬¦åˆã€Œå®šç›¸ç•¶æœŸé™å‚¬å‘Šå±¥è¡Œçš„æ³•å®šç¨‹åºã€ï¼Œ<br>æ‰€ä»¥ã€Œå‚¬å‘Šç¨‹åºåˆæ³•æœ‰æ•ˆã€ã€‚`,
                conclusion: "ç”²å‚¬å‘Šç¨‹åºåˆæ³•ï¼Œä¹™ç¶“å‚¬å‘Šä»ä¸å±¥è¡Œï¼Œç”²å¾—ä¾æ³•è§£é™¤å¥‘ç´„ã€‚"
            },
            hints: {
                issue: ["å¥‘ç´„æ˜¯å¦æœ‰æ•ˆæˆç«‹ï¼Ÿ", "ä¹™çš„è¡Œç‚ºæ˜¯å¦æ§‹æˆé•ç´„ï¼Ÿ", "ç”²æ˜¯å¦å¯ä»¥è§£é™¤å¥‘ç´„ï¼Ÿ"],
                rule: ["å¥‘ç´„è§£é™¤çš„è¦ä»¶", "å‚µå‹™ä¸å±¥è¡Œçš„é¡å‹", "æ°‘æ³•ç¬¬254æ¢ã€ç¬¬256æ¢ç­‰ç›¸é—œè¦å®š"],
                application: ["ä¹™æ˜¯å¦æ§‹æˆçµ¦ä»˜é²å»¶ï¼Ÿ", "ç”²çš„å‚¬å‘Šç¨‹åºæ˜¯å¦åˆæ³•ï¼Ÿ", "è§£é™¤æ¬Šæ˜¯å¦å·²å…·å‚™è¦ä»¶ï¼Ÿ"],
                conclusion: ["ç”²æ˜¯å¦å¯ä»¥è§£é™¤å¥‘ç´„ï¼Ÿ", "æ˜¯å¦å¯ä»¥è«‹æ±‚é•ç´„é‡‘ï¼Ÿ"]
            }
        }
    };
    
    // ç•¶å‰é¸ä¸­çš„æ¡ˆä¾‹
    let currentCase = CASE_DATABASE.self_defense;
    
    // å­¸ç”Ÿå­¸ç¿’è¨˜éŒ„
    let studentSession = {
        sessionId: Date.now().toString(),
        studentName: "åŒ¿åå­¸ç”Ÿ" + Math.random().toString(36).substr(2, 4),
        startTime: new Date().toISOString(),
        caseId: currentCase.id,
        interactions: [],
        stageProgress: {
            issue: { attempts: 0, completed: false, answers: [] },
            rule: { attempts: 0, completed: false, answers: [] },
            application: { attempts: 0, completed: false, answers: [] },
            conclusion: { attempts: 0, completed: false, answers: [] }
        }
    };
    // ========================================

    const stages = ['issue', 'rule', 'application', 'conclusion'];
    let currentStageIndex = 0;
    let attemptCount = 0;
    let practiceMode = false;
    
    // éšæ®µæç¤ºèª
    const stagePrompts = {
        'issue': 'è«‹æŒ‡å‡ºæœ¬æ¡ˆæœ€æ ¸å¿ƒçš„æ³•å¾‹çˆ­é»ï¼ˆIssueï¼‰æ˜¯ä»€éº¼ï¼Ÿ',
        'rule': 'é‡å°ä½ æå‡ºçš„çˆ­é»ï¼Œæ³•å¾‹è¦ç¯„ï¼ˆRuleï¼‰æ˜¯ä»€éº¼ï¼Ÿè«‹åˆ—å‡ºå…·é«”çš„æ§‹æˆè¦ä»¶ã€‚',
        'application': 'ç¾åœ¨é€²è¡Œæ¶µæ”ï¼ˆApplicationï¼‰ã€‚è«‹å°‡æœ¬æ¡ˆäº‹å¯¦å¡«å…¥ä¸Šè¿°è¦ä»¶ä¸­ï¼Œä¸¦è«–è­‰ç‚ºä½•ç¬¦åˆï¼ˆæˆ–ä¸ç¬¦åˆï¼‰ã€‚',
        'conclusion': 'æœ€å¾Œï¼Œè«‹æ ¹æ“šä¸Šè¿°æ¨è«–ï¼Œçµ¦å‡ºç°¡æ½”çš„æ³•å¾‹çµè«–ï¼ˆConclusionï¼‰ã€‚'
    };

    const chatHistory = document.getElementById('chatHistory');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    // åˆå§‹åŒ–é é¢
    function initializePage() {
        loadCase('self_defense');
    }

    // åˆ‡æ›æ¡ˆä¾‹
    function switchCase() {
        const caseSelect = document.getElementById('caseSelect');
        const selectedCaseId = caseSelect.value;
        
        // é‡ç½®è¨“ç·´ç‹€æ…‹
        resetTraining();
        
        // åŠ è¼‰æ–°æ¡ˆä¾‹
        loadCase(selectedCaseId);
        
        // è¨˜éŒ„æ¡ˆä¾‹åˆ‡æ›
        studentSession.caseId = selectedCaseId;
        studentSession.interactions.push({
            timestamp: new Date().toISOString(),
            action: 'case_switch',
            data: { newCase: selectedCaseId }
        });
    }

    // è¼‰å…¥æ¡ˆä¾‹
    function loadCase(caseId) {
        currentCase = CASE_DATABASE[caseId];
        
        // æ›´æ–°æ¡ˆä¾‹äº‹å¯¦
        document.getElementById('caseFactsText').innerHTML = currentCase.facts;
        document.getElementById('caseTitle').textContent = currentCase.title;
        
        // æ›´æ–°æ¨™ç±¤
        const typeElem = document.getElementById('caseType');
        const difficultyElem = document.getElementById('caseDifficulty');
        
        typeElem.textContent = currentCase.type;
        typeElem.className = `case-badge ${currentCase.type === 'åˆ‘æ³•' ? 'badge-criminal' : 'badge-civil'}`;
        
        difficultyElem.textContent = currentCase.difficulty;
        difficultyElem.className = `case-badge ${currentCase.difficulty === 'åˆç´š' ? 'badge-beginner' : 'badge-intermediate'}`;
        
        // æ›´æ–°ç¯„ä¾‹å…§å®¹
        updateExampleContent();
    }

    // æ›´æ–°ç¯„ä¾‹å…§å®¹
    function updateExampleContent() {
        const exampleContent = document.getElementById('exampleContent');
        exampleContent.innerHTML = `
            <h4>ğŸ“ å„éšæ®µç­”é¡Œç¯„ä¾‹ï¼š</h4>
            
            <div style="margin-bottom: 15px;">
                <strong>Issue (çˆ­é»)ï¼š</strong>
                <p class="example-text">${currentCase.examples.issue}</p>
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong>Rule (è¦å‰‡)ï¼š</strong>
                <p class="example-text">${currentCase.examples.rule}</p>
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong>Application (æ¶µæ”)ï¼š</strong>
                <p class="example-text">${currentCase.examples.application}</p>
            </div>
            
            <div>
                <strong>Conclusion (çµè«–)ï¼š</strong>
                <p class="example-text">${currentCase.examples.conclusion}</p>
            </div>
        `;
    }

    // Enteré€å‡º
    userInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSubmit();
        }
    });

    // æ‰‹æ©Ÿç‰ˆï¼šåˆ‡æ›æ¡ˆä¾‹é¡¯ç¤º
    function toggleMobileCase() {
        const panel = document.getElementById('leftPanel');
        panel.classList.toggle('show');
        
        const closeBtns = document.querySelectorAll('.mobile-close-btn');
        if (window.innerWidth <= 768) {
            closeBtns.forEach(btn => {
                btn.style.display = panel.classList.contains('show') ? 'block' : 'none';
            });
        }
    }

    // åˆ‡æ›åƒè€ƒç¯„ä¾‹é¡¯ç¤º
    function toggleExample() {
        const example = document.getElementById('exampleContent');
        const button = document.querySelector('.example-button');
        
        if (example.style.display === 'none' || !example.style.display) {
            example.style.display = 'block';
            button.textContent = 'ğŸ“– éš±è—åƒè€ƒç¯„ä¾‹';
        } else {
            example.style.display = 'none';
            button.textContent = 'ğŸ“– æŸ¥çœ‹åƒè€ƒç¯„ä¾‹';
        }
    }

    // åˆ‡æ›ç·´ç¿’æ¨¡å¼
    function togglePracticeMode() {
        practiceMode = !practiceMode;
        const indicator = document.getElementById('practiceModeIndicator');
        const button = document.querySelector('.practice-button');
        
        if (practiceMode) {
            indicator.style.display = 'block';
            button.style.background = '#e67e22';
            appendMessage('ğŸ¯ ç·´ç¿’æ¨¡å¼å·²é–‹å•Ÿï¼æˆ‘æœƒæä¾›æ›´å¤šæç¤ºå¹«åŠ©ä½ å­¸ç¿’ã€‚', 'ai-message hint');
            
            // ç«‹å³çµ¦ä¸€å€‹æç¤º
            const hints = currentCase.hints[stages[currentStageIndex]];
            if (hints && hints[0]) {
                setTimeout(() => {
                    appendMessage(hints[0], 'ai-message hint');
                }, 500);
            }
        } else {
            indicator.style.display = 'none';
            button.style.background = '#f39c12';
            appendMessage('ç·´ç¿’æ¨¡å¼å·²é—œé–‰ã€‚', 'ai-message');
        }
        
        // è¨˜éŒ„ç·´ç¿’æ¨¡å¼åˆ‡æ›
        studentSession.interactions.push({
            timestamp: new Date().toISOString(),
            action: 'toggle_practice_mode',
            data: { enabled: practiceMode }
        });
    }

    async function handleSubmit() {
        const text = userInput.value.trim();
        if (!text) return;

        appendMessage(text, 'user-message');
        
        // è¨˜éŒ„å­¸ç”Ÿå›ç­”
        const currentStage = stages[currentStageIndex];
        studentSession.stageProgress[currentStage].attempts++;
        studentSession.stageProgress[currentStage].answers.push({
            attempt: studentSession.stageProgress[currentStage].attempts,
            answer: text,
            timestamp: new Date().toISOString()
        });
        
        studentSession.interactions.push({
            timestamp: new Date().toISOString(),
            action: 'student_answer',
            stage: currentStage,
            data: { answer: text, attempt: studentSession.stageProgress[currentStage].attempts }
        });

        userInput.value = '';
        userInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.textContent = '...';

        // ç”¢ç”Ÿæˆ–å–å¾—å”¯ä¸€çš„å­¸ç¿’æœƒè©± ID
        let sessionId = sessionStorage.getItem('irac_session_id');
        if (!sessionId) {
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            sessionStorage.setItem('irac_session_id', sessionId);
        }

        const payload = {
            student_input: text,
            current_stage: stages[currentStageIndex],
            case_facts: currentCase.facts,
            practice_mode: practiceMode,
            case_id: currentCase.id,
            student_session_id: sessionId  // æ–°å¢é€™ä¸€è¡Œ
        };

        try {
            const response = await fetch(N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error('ç¶²è·¯é€£ç·šéŒ¯èª¤æˆ– n8n æœªå›æ‡‰');
            }

            const data = await response.json();
            handleAIResponse(data);

        } catch (error) {
            console.error(error);
            appendMessage("âš ï¸ ç³»çµ±é€£ç·šéŒ¯èª¤ã€‚è«‹æª¢æŸ¥ n8n Webhook URL æ˜¯å¦æ­£ç¢ºã€‚", "ai-message feedback-fail");
        } finally {
            userInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = 'é€å‡º';
            userInput.focus();
        }
    }

    function handleAIResponse(data) {
        const isPass = data.pass;
        const feedbackClass = isPass ? 'feedback-pass' : 'feedback-fail';
        
        appendMessage(data.feedback, `ai-message ${feedbackClass}`);

        // è¨˜éŒ„AIå›é¥‹
        studentSession.interactions.push({
            timestamp: new Date().toISOString(),
            action: 'ai_feedback',
            stage: stages[currentStageIndex],
            data: { pass: isPass, feedback: data.feedback, attempt: attemptCount + 1 }
        });

        // è™•ç†å¤±æ•—æƒ…æ³
        if (!isPass) {
            attemptCount++;
            
            // Application éšæ®µçš„é¡å¤–æç¤º
            if (currentStageIndex === 2 && attemptCount >= 2) {
                appendMessage(
                    `ğŸ’¡ <strong>é¡å¤–æç¤ºï¼š</strong><br>
                    è©¦è‘—é€™æ¨£çµ„ç¹”ä½ çš„ç­”æ¡ˆï¼š<br>
                    1. å…ˆèªªæ˜ç”²çš„ä¸»è§€å¿ƒæ…‹ï¼ˆé˜²è¡›æ„åœ–ï¼‰<br>
                    2. å†èªªæ˜ä¹™çš„è¡Œç‚ºï¼ˆç¾åœ¨ä¸æ³•ä¾µå®³ï¼‰<br>
                    3. æœ€å¾Œèªªæ˜é˜²è¡›æ‰‹æ®µæ˜¯å¦é©ç•¶<br>
                    <br>è¨˜å¾—ç”¨ã€Œå› ç‚º...ç¬¦åˆ...æ‰€ä»¥ã€çš„å¥å‹ï¼`, 
                    'ai-message hint'
                );
            }
            
            // ç·´ç¿’æ¨¡å¼ä¸‹çµ¦æ›´å¤šæç¤º
            if (practiceMode && attemptCount >= 1) {
                const hints = currentCase.hints[stages[currentStageIndex]];
                const hintIndex = Math.min(attemptCount, hints.length - 1);
                setTimeout(() => {
                    appendMessage(hints[hintIndex], 'ai-message hint');
                }, 1000);
            }
            
            // å¤±æ•—å¤ªå¤šæ¬¡è‡ªå‹•é€šé
            if (attemptCount >= 4) {
                setTimeout(() => {
                    appendMessage(
                        'ğŸ’ª çœ‹å¾—å‡ºä¾†ä½ å¾ˆåŠªåŠ›ï¼è®“æˆ‘å€‘å…ˆé€²å…¥ä¸‹ä¸€éšæ®µï¼Œä¹‹å¾Œå¯ä»¥å†å›ä¾†ç·´ç¿’ã€‚', 
                        'ai-message feedback-pass'
                    );
                    proceedToNextStage();
                }, 2000);
            }
        } else {
            // é€šéï¼é€²å…¥ä¸‹ä¸€éšæ®µ
            proceedToNextStage();
        }
    }

    function proceedToNextStage() {
        // æ¨™è¨˜ç•¶å‰éšæ®µå®Œæˆ
        const currentStage = stages[currentStageIndex];
        studentSession.stageProgress[currentStage].completed = true;
        
        attemptCount = 0;
        
        if (currentStageIndex < stages.length - 1) {
            currentStageIndex++;
            updateProgressBar();
            
            setTimeout(() => {
                appendMessage(`âœ… éšæ®µå®Œæˆï¼æ¥ä¸‹ä¾†ï¼š<br>${stagePrompts[stages[currentStageIndex]]}`, 'ai-message');
                
                // ç·´ç¿’æ¨¡å¼ä¸‹è‡ªå‹•çµ¦æç¤º
                if (practiceMode) {
                    const hints = currentCase.hints[stages[currentStageIndex]];
                    if (hints && hints[0]) {
                        setTimeout(() => {
                            appendMessage(hints[0], 'ai-message hint');
                        }, 1000);
                    }
                }
            }, 800);
        } else {
            // å…¨éƒ¨å®Œæˆ
            studentSession.endTime = new Date().toISOString();
            setTimeout(() => {
                appendMessage("ğŸ‰ å¤ªæ£’äº†ï¼ä½ å·²ç¶“å®Œæˆäº†å®Œæ•´çš„ IRAC æ³•å¾‹æ¨è«–éç¨‹ã€‚", 'ai-message feedback-pass');
                

                // åŠ å…¥é‡æ–°é–‹å§‹æŒ‰éˆ•åˆ°æ¬¡è¦æ§åˆ¶å€
                const secondaryControls = document.querySelector('.secondary-controls');
                const resetBtn = document.createElement('button');
                resetBtn.textContent = 'ğŸ”„ é‡æ–°é–‹å§‹æ–°æ¡ˆä¾‹';
                resetBtn.style.height = 'auto';
                resetBtn.style.padding = '8px 16px';
                resetBtn.style.marginLeft = '10px';
                resetBtn.onclick = resetTraining;
                secondaryControls.appendChild(resetBtn);
            }, 800);
        }
    }

    // å„²å­˜å­¸ç¿’è¨˜éŒ„åˆ° Google Drive
    function appendMessage(htmlText, className) {
        const div = document.createElement('div');
        div.className = `message ${className}`;
        div.innerHTML = htmlText.replace(/\n/g, '<br>');
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function updateProgressBar() {
        const allSteps = document.querySelectorAll('.step');
        allSteps.forEach((step, index) => {
            step.classList.remove('active');
            if (index < currentStageIndex) {
                step.classList.add('completed');
            } else if (index === currentStageIndex) {
                step.classList.add('active');
            }
        });
    }

    // é‡æ–°é–‹å§‹è¨“ç·´
    function resetTraining() {
        currentStageIndex = 0;
        attemptCount = 0;
        chatHistory.innerHTML = '';
        
        // é‡ç½®å­¸ç¿’è¨˜éŒ„
        studentSession = {
            sessionId: Date.now().toString(),
            studentName: "åŒ¿åå­¸ç”Ÿ" + Math.random().toString(36).substr(2, 4),
            startTime: new Date().toISOString(),
            caseId: currentCase.id,
            interactions: [],
            stageProgress: {
                issue: { attempts: 0, completed: false, answers: [] },
                rule: { attempts: 0, completed: false, answers: [] },
                application: { attempts: 0, completed: false, answers: [] },
                conclusion: { attempts: 0, completed: false, answers: [] }
            }
        };
        
        // æ¸…é™¤æ¬¡è¦æ§åˆ¶å€çš„é‡æ–°é–‹å§‹æŒ‰éˆ•
        const secondaryControls = document.querySelector('.secondary-controls');
        const existingResetBtn = secondaryControls.querySelector('button[onclick*="resetTraining"]');
        if (existingResetBtn && existingResetBtn.textContent.includes('é‡æ–°é–‹å§‹')) {
            existingResetBtn.remove();
        }
        
        updateProgressBar();
        
        appendMessage(
            'æ­¡è¿ä¾†åˆ°æ€ç¶­è¨“ç·´ã€‚æˆ‘å€‘å¾ç¬¬ä¸€æ­¥é–‹å§‹ï¼š<br><br>' +
            '<strong>è«‹æŒ‡å‡ºæœ¬æ¡ˆæœ€æ ¸å¿ƒçš„æ³•å¾‹çˆ­é»ï¼ˆIssueï¼‰æ˜¯ä»€éº¼ï¼Ÿ</strong><br>' +
            'ï¼ˆè«‹è©¦è‘—ç”¨å•å¥å½¢å¼æå‡ºï¼Œä¾‹å¦‚ï¼šç”²çš„è¡Œç‚ºæ˜¯å¦æ§‹æˆ...ï¼Ÿï¼‰',
            'ai-message'
        );
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initializePage);
</script>

</body>
</html>