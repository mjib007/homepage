<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”è¨æœƒå³æ™‚èªéŸ³ç¿»è­¯ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            min-height: 500px;
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .record-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: none;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .record-button:not(.recording):not(.processing) {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .record-button:not(.recording):not(.processing):hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .record-button.recording {
            background: linear-gradient(135deg, #ff9999 0%, #ff6b6b 100%);
            animation: pulse 1.5s infinite;
        }

        .record-button.processing {
            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
            cursor: not-allowed;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .status {
            margin-top: 20px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 500;
            min-height: 30px;
        }

        .status.recording {
            color: #ff6b6b;
            animation: blink 1s infinite;
        }

        .status.processing {
            color: #feca57;
        }

        .status.success {
            color: #2ed573;
        }

        .status.error {
            color: #ff4757;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        .timer {
            margin-top: 10px;
            font-size: 1.5em;
            font-weight: bold;
            color: #666;
        }

        .timer.recording {
            color: #ff6b6b;
        }

        .results-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            overflow-y: auto;
            max-height: 600px;
        }

        .result-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #4facfe;
        }

        .result-item:last-child {
            margin-bottom: 0;
        }

        .result-timestamp {
            font-size: 0.9em;
            color: #999;
            margin-bottom: 10px;
        }

        .original-text {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-style: italic;
            color: #1565c0;
            border-left: 3px solid #2196f3;
        }

        .translated-text {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
            color: #2e7d32;
            border-left: 3px solid #4caf50;
            line-height: 1.6;
        }

        .language-info {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-clear {
            background: #ff4757;
            color: white;
        }

        .btn-clear:hover {
            background: #ff3838;
            transform: translateY(-2px);
        }

        .btn-download {
            background: #2ed573;
            color: white;
        }

        .btn-download:hover {
            background: #1dd1a1;
            transform: translateY(-2px);
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #f44336;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .audio-visualizer {
            margin-top: 20px;
            display: none;
        }

        .audio-visualizer.active {
            display: block;
        }

        .visualizer-bars {
            display: flex;
            justify-content: center;
            align-items: end;
            height: 60px;
            gap: 3px;
        }

        .bar {
            width: 4px;
            background: linear-gradient(to top, #ff6b6b, #ff9999);
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }

        .bar:nth-child(odd) {
            animation-delay: 0.1s;
        }

        .bar:nth-child(even) {
            animation-delay: 0.3s;
        }

        @keyframes wave {
            0%, 100% { height: 10px; }
            50% { height: 40px; }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .record-button {
                width: 150px;
                height: 150px;
                font-size: 1em;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ ç ”è¨æœƒå³æ™‚èªéŸ³ç¿»è­¯</h1>
            <p>æ”¯æ´å¤šåœ‹èªè¨€å³æ™‚ç¿»è­¯æˆç¹é«”ä¸­æ–‡</p>
        </div>
        
        <div class="main-content">
            <div class="control-panel">
                <button id="recordButton" class="record-button">
                    <span id="buttonText">é–‹å§‹éŒ„éŸ³</span>
                </button>
                
                <div class="audio-visualizer" id="audioVisualizer">
                    <div class="visualizer-bars">
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                    </div>
                </div>
                
                <div id="status" class="status">æº–å‚™å°±ç·’</div>
                <div id="timer" class="timer">00:00</div>
                
                <div class="controls">
                    <button id="clearButton" class="btn btn-clear">æ¸…é™¤è¨˜éŒ„</button>
                    <button id="downloadButton" class="btn btn-download">ä¸‹è¼‰çµæœ</button>
                </div>
            </div>
            
            <div class="results-panel" id="resultsPanel">
                <div style="text-align: center; color: #999; padding: 50px;">
                    <h3>ğŸ“ ç¿»è­¯çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡</h3>
                    <p>é»æ“Šå·¦å´çš„éŒ„éŸ³æŒ‰éˆ•é–‹å§‹éŒ„è£½è¬›å¸«çš„è²éŸ³</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AudioTranslator {
            constructor() {
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.isRecording = false;
                this.isProcessing = false;
                this.startTime = null;
                this.timerInterval = null;
                this.results = [];
                
                // Webhook URL
                this.webhookUrl = 'https://kf0630.zeabur.app/webhook/audio-translate';
                
                this.initializeElements();
                this.bindEvents();
                this.checkMicrophonePermission();
            }
            
            initializeElements() {
                this.recordButton = document.getElementById('recordButton');
                this.buttonText = document.getElementById('buttonText');
                this.status = document.getElementById('status');
                this.timer = document.getElementById('timer');
                this.resultsPanel = document.getElementById('resultsPanel');
                this.clearButton = document.getElementById('clearButton');
                this.downloadButton = document.getElementById('downloadButton');
                this.audioVisualizer = document.getElementById('audioVisualizer');
            }
            
            bindEvents() {
                this.recordButton.addEventListener('click', () => this.toggleRecording());
                this.clearButton.addEventListener('click', () => this.clearResults());
                this.downloadButton.addEventListener('click', () => this.downloadResults());
            }
            
            async checkMicrophonePermission() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    this.updateStatus('æº–å‚™å°±ç·’', 'ready');
                } catch (error) {
                    this.updateStatus('éœ€è¦éº¥å…‹é¢¨æ¬Šé™', 'error');
                    console.error('éº¥å…‹é¢¨æ¬Šé™éŒ¯èª¤:', error);
                }
            }
            
            async toggleRecording() {
                if (this.isProcessing) return;
                
                if (!this.isRecording) {
                    await this.startRecording();
                } else {
                    await this.stopRecording();
                }
            }
            
            async startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100
                        } 
                    });
                    
                    this.mediaRecorder = new MediaRecorder(stream, {
                        mimeType: MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4'
                    });
                    
                    this.audioChunks = [];
                    this.isRecording = true;
                    this.startTime = Date.now();
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.audioChunks.push(event.data);
                        }
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        this.processAudio();
                    };
                    
                    this.mediaRecorder.start();
                    this.startTimer();
                    
                    this.recordButton.classList.add('recording');
                    this.buttonText.textContent = 'åœæ­¢éŒ„éŸ³';
                    this.updateStatus('ğŸ”´ éŒ„éŸ³ä¸­...', 'recording');
                    this.audioVisualizer.classList.add('active');
                    
                } catch (error) {
                    console.error('é–‹å§‹éŒ„éŸ³éŒ¯èª¤:', error);
                    this.updateStatus('éŒ„éŸ³å¤±æ•—ï¼š' + error.message, 'error');
                }
            }
            
            async stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    
                    this.isRecording = false;
                    this.stopTimer();
                    
                    this.recordButton.classList.remove('recording');
                    this.recordButton.classList.add('processing');
                    this.buttonText.innerHTML = '<span class="loading-spinner"></span>è™•ç†ä¸­...';
                    this.updateStatus('ğŸ”„ è™•ç†éŸ³æª”ä¸­...', 'processing');
                    this.audioVisualizer.classList.remove('active');
                    this.isProcessing = true;
                }
            }
            
            async processAudio() {
                try {
                    const audioBlob = new Blob(this.audioChunks, { 
                        type: this.mediaRecorder.mimeType 
                    });
                    
                    // æª¢æŸ¥éŸ³æª”å¤§å°
                    if (audioBlob.size < 1000) {
                        throw new Error('éŒ„éŸ³æ™‚é–“å¤ªçŸ­æˆ–æ²’æœ‰éŒ„åˆ°è²éŸ³');
                    }
                    
                    console.log(`éŸ³æª”è³‡è¨Š: å¤§å°=${audioBlob.size}bytes, é¡å‹=${audioBlob.type}`);
                    
                    // å»ºç«‹ FormData ä¸¦æ­£ç¢ºè¨­ç½®æª”æ¡ˆ
                    const formData = new FormData();
                    const fileName = `recording_${Date.now()}.${this.getFileExtension(audioBlob.type)}`;
                    formData.append('file', audioBlob, fileName);
                    
                    // æ·»åŠ æ™‚é–“æˆ³ä»¥ä¾¿è¿½è¹¤è™•ç†æ™‚é–“
                    formData.append('timestamp', Date.now().toString());
                    
                    this.updateStatus('ğŸš€ æ­£åœ¨ä¸Šå‚³éŸ³æª”...', 'processing');
                    
                    const response = await fetch(this.webhookUrl, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'Accept': 'application/json'
                            // ä¸è¦è¨­ç½® Content-Typeï¼Œè®“ç€è¦½å™¨è‡ªå‹•è™•ç† multipart/form-data
                        }
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤:', errorText);
                        throw new Error(`ä¼ºæœå™¨éŒ¯èª¤ ${response.status}: ${response.statusText}`);
                    }
                    
                    this.updateStatus('ğŸ”„ æ­£åœ¨è½‰éŒ„å’Œç¿»è­¯...', 'processing');
                    
                    const result = await response.json();
                    console.log('ä¼ºæœå™¨å›æ‡‰:', result);
                    
                    if (result.success) {
                        this.addResult(result.data);
                        this.updateStatus('âœ… ç¿»è­¯å®Œæˆ', 'success');
                    } else {
                        throw new Error(result.error?.message || 'ç¿»è­¯è™•ç†å¤±æ•—');
                    }
                    
                } catch (error) {
                    console.error('è™•ç†éŸ³æª”éŒ¯èª¤:', error);
                    this.updateStatus('âŒ ' + error.message, 'error');
                    this.showErrorMessage(error.message);
                } finally {
                    this.resetButton();
                }
            }
            
            getFileExtension(mimeType) {
                const extensions = {
                    'audio/webm': 'webm',
                    'audio/mp4': 'm4a',
                    'audio/wav': 'wav',
                    'audio/ogg': 'ogg'
                };
                return extensions[mimeType] || 'webm';
            }
            
            addResult(data) {
                this.results.push({
                    timestamp: new Date().toLocaleString('zh-TW'),
                    ...data
                });
                
                this.renderResults();
            }
            
            renderResults() {
                if (this.results.length === 0) {
                    this.resultsPanel.innerHTML = `
                        <div style="text-align: center; color: #999; padding: 50px;">
                            <h3>ğŸ“ ç¿»è­¯çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡</h3>
                            <p>é»æ“Šå·¦å´çš„éŒ„éŸ³æŒ‰éˆ•é–‹å§‹éŒ„è£½è¬›å¸«çš„è²éŸ³</p>
                        </div>
                    `;
                    return;
                }
                
                this.resultsPanel.innerHTML = this.results.map((result, index) => `
                    <div class="result-item">
                        <div class="result-timestamp">
                            #${index + 1} - ${result.timestamp}
                            ${result.language_detected ? `(åµæ¸¬èªè¨€: ${this.getLanguageName(result.language_detected)})` : ''}
                            ${result.audio_duration ? `ãƒ»éŸ³æª”é•·åº¦: ${Math.round(result.audio_duration)}ç§’` : ''}
                        </div>
                        
                        <div class="original-text">
                            <strong>ğŸ¤ åŸæ–‡ï¼š</strong><br>
                            ${this.escapeHtml(result.original_text || 'ç„¡æ³•è­˜åˆ¥èªéŸ³')}
                        </div>
                        
                        <div class="translated-text">
                            <strong>ğŸ‡¹ğŸ‡¼ ä¸­æ–‡ç¿»è­¯ï¼š</strong><br>
                            ${this.escapeHtml(result.translated_text || 'ç¿»è­¯å¤±æ•—')}
                        </div>
                        
                        <div class="language-info">
                            ${result.processing_time ? `è™•ç†æ™‚é–“: ${result.processing_time}` : ''}
                            ${result.word_count ? `ãƒ»åŸæ–‡å­—æ•¸: ${result.word_count}` : ''}
                            ${result.char_count ? `ãƒ»è­¯æ–‡å­—æ•¸: ${result.char_count}` : ''}
                        </div>
                    </div>
                `).join('');
                
                // è‡ªå‹•æ»¾å‹•åˆ°æœ€æ–°çµæœ
                this.resultsPanel.scrollTop = this.resultsPanel.scrollHeight;
            }
            
            getLanguageName(code) {
                const languages = {
                    'en': 'è‹±æ–‡',
                    'ja': 'æ—¥æ–‡',
                    'ko': 'éŸ“æ–‡',
                    'fr': 'æ³•æ–‡',
                    'de': 'å¾·æ–‡',
                    'es': 'è¥¿ç­ç‰™æ–‡',
                    'it': 'ç¾©å¤§åˆ©æ–‡',
                    'pt': 'è‘¡è„ç‰™æ–‡',
                    'ru': 'ä¿„æ–‡',
                    'ar': 'é˜¿æ‹‰ä¼¯æ–‡',
                    'zh': 'ä¸­æ–‡'
                };
                return languages[code] || code.toUpperCase();
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            showErrorMessage(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `
                    <strong>âš ï¸ è™•ç†å¤±æ•—</strong><br>
                    ${this.escapeHtml(message)}<br>
                    <small>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡æ–°å˜—è©¦</small>
                `;
                
                this.resultsPanel.insertBefore(errorDiv, this.resultsPanel.firstChild);
                
                // 5ç§’å¾Œè‡ªå‹•ç§»é™¤éŒ¯èª¤è¨Šæ¯
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 5000);
            }
            
            resetButton() {
                this.recordButton.classList.remove('recording', 'processing');
                this.buttonText.textContent = 'é–‹å§‹éŒ„éŸ³';
                this.isProcessing = false;
                
                setTimeout(() => {
                    this.updateStatus('æº–å‚™å°±ç·’', 'ready');
                }, 2000);
            }
            
            startTimer() {
                this.timerInterval = setInterval(() => {
                    const elapsed = Date.now() - this.startTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    this.timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    this.timer.classList.add('recording');
                }, 1000);
            }
            
            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                    this.timer.classList.remove('recording');
                }
            }
            
            updateStatus(message, type) {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
            }
            
            clearResults() {
                if (this.results.length === 0) return;
                
                if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç¿»è­¯è¨˜éŒ„å—ï¼Ÿ')) {
                    this.results = [];
                    this.renderResults();
                    this.updateStatus('è¨˜éŒ„å·²æ¸…é™¤', 'success');
                }
            }
            
            downloadResults() {
                if (this.results.length === 0) {
                    alert('æ²’æœ‰å¯ä¸‹è¼‰çš„ç¿»è­¯è¨˜éŒ„');
                    return;
                }
                
                const content = this.results.map((result, index) => {
                    return `
=== ç ”è¨æœƒç¿»è­¯è¨˜éŒ„ #${index + 1} ===
éŒ„è£½æ™‚é–“: ${result.timestamp}
åµæ¸¬èªè¨€: ${this.getLanguageName(result.language_detected || 'unknown')}
éŸ³æª”é•·åº¦: ${result.audio_duration ? Math.round(result.audio_duration) + 'ç§’' : 'æœªçŸ¥'}
è™•ç†æ™‚é–“: ${result.processing_time || 'N/A'}
åŸæ–‡å­—æ•¸: ${result.word_count || 'N/A'}
è­¯æ–‡å­—æ•¸: ${result.char_count || 'N/A'}

ã€åŸæ–‡å…§å®¹ã€‘
${result.original_text || 'ç„¡æ³•è­˜åˆ¥èªéŸ³å…§å®¹'}

ã€ä¸­æ–‡ç¿»è­¯ã€‘
${result.translated_text || 'ç¿»è­¯å¤±æ•—'}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

`;
                }).join('\n');
                
                const header = `ç ”è¨æœƒå³æ™‚èªéŸ³ç¿»è­¯ç³»çµ±
åŒ¯å‡ºæ™‚é–“: ${new Date().toLocaleString('zh-TW')}
ç¸½è¨˜éŒ„æ•¸: ${this.results.length}ç­†
ç³»çµ±ç‰ˆæœ¬: v1.0

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

`;
                
                const blob = new Blob([header + content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ç ”è¨æœƒç¿»è­¯è¨˜éŒ„_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.updateStatus('ğŸ“¥ è¨˜éŒ„å·²ä¸‹è¼‰', 'success');
            }
        }
        
        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        document.addEventListener('DOMContentLoaded', () => {
            new AudioTranslator();
        });
        
        // é˜²æ­¢é é¢æ„å¤–é—œé–‰æ™‚ä¸Ÿå¤±éŒ„éŸ³
        window.addEventListener('beforeunload', (e) => {
            const audioTranslator = window.audioTranslator;
            if (audioTranslator && audioTranslator.isRecording) {
                e.preventDefault();
                e.returnValue = 'æ­£åœ¨éŒ„éŸ³ä¸­ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
            }
        });
    </script>
</body>
</html>