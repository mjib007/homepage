<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IRAC æ³•å¾‹æ€ç¶­å°èˆªå„€</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #c0392b;
            --success-color: #27ae60;
            --info-color: #3498db;
            --bg-color: #f4f7f6;
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Helvetica Neue", Arial, "PingFang TC", "Heiti TC", sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: #333;
            height: 100vh;
            height: 100dvh; /* é‡å°æ‰‹æ©Ÿç€è¦½å™¨çš„å‹•æ…‹é«˜åº¦å„ªåŒ– */
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 0.8rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0; /* é˜²æ­¢headerè¢«å£“ç¸® */
            z-index: 20;
        }

        h1 { margin: 0; font-size: 1.2rem; }
        .subtitle { font-size: 0.8rem; opacity: 0.8; display: block; }
        .course-info { font-size: 0.8rem; }

        /* Main Layout */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* Mobile Toggle Button (é è¨­éš±è—ï¼Œæ‰‹æ©Ÿç‰ˆé¡¯ç¤º) */
        .mobile-case-toggle {
            display: none;
            background: #ecf0f1;
            color: var(--primary-color);
            padding: 10px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
            font-size: 0.9rem;
            z-index: 15;
        }
        .mobile-case-toggle:hover { background: #dee2e6; }

        /* Left Panel: Case Facts */
        .left-panel {
            width: 35%;
            background-color: #eef2f5;
            padding: 2rem;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .case-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            line-height: 1.6;
        }

        .case-title {
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--accent-color);
            display: inline-block;
            padding-bottom: 5px;
        }

        /* Right Panel: Interaction */
        .right-panel {
            width: 65%;
            display: flex;
            flex-direction: column;
            background: white;
            position: relative;
        }

        /* Progress Bar */
        .progress-bar {
            display: flex;
            justify-content: space-around;
            padding: 1rem 0.5rem;
            background: #fff;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.4;
            transition: all 0.3s;
            flex: 1;
        }

        .step.active { opacity: 1; font-weight: bold; color: var(--primary-color); }
        .step.completed { opacity: 1; color: var(--success-color); }
        
        .step-circle {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #ccc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .step span { font-size: 0.8rem; }

        .step.active .step-circle { background: var(--primary-color); transform: scale(1.1); }
        .step.completed .step-circle { background: var(--success-color); }

        /* Chat Area */
        .chat-history {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background-color: #fff;
        }

        .message {
            max-width: 85%;
            padding: 0.8rem 1rem;
            border-radius: 12px;
            line-height: 1.5;
            font-size: 0.95rem;
            word-wrap: break-word;
        }

        .ai-message {
            align-self: flex-start;
            background-color: #f0f4f8;
            color: #2c3e50;
            border-left: 4px solid var(--primary-color);
            border-top-left-radius: 2px;
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .ai-message.feedback-fail { background-color: #fff5f5; border-left-color: var(--accent-color); }
        .ai-message.feedback-pass { background-color: #e8f8f5; border-left-color: var(--success-color); }
        .ai-message.hint { background-color: #fff9e6; border-left-color: #f39c12; }

        /* Input Area */
        .input-area {
            padding: 1rem;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
            flex-shrink: 0;
        }

        textarea {
            flex: 1;
            padding: 0.8rem;
            border: 1px solid #ccc;
            border-radius: 20px;
            resize: none;
            font-size: 1rem;
            height: 45px; /* é è¨­é«˜åº¦ */
            max-height: 100px;
            font-family: inherit;
            background: #f9f9f9;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: #fff;
        }

        button {
            padding: 0 1.2rem;
            height: 45px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            white-space: nowrap;
        }

        .practice-button { background: #f39c12; }
        .example-button { 
            width: 100%; margin-top: 15px; padding: 10px; 
            background: var(--info-color); border-radius: 5px; color: white; border: none;
        }
        .example-content { display: none; margin-top: 10px; padding: 10px; background: #ecf0f1; border-radius: 5px; font-size: 0.9rem; }
        
        /* =========================================
           MOBILE RESPONSIVE STYLES (é—œéµä¿®æ”¹)
           ========================================= */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            /* æ‰‹æ©Ÿç‰ˆHeaderèª¿æ•´ */
            header { padding: 0.8rem 1rem; }
            .course-info { display: none; } /* æ‰‹æ©Ÿç‰ˆéš±è—èª²ç¨‹åç¨±ä»¥ç¯€çœç©ºé–“ */

            /* é¡¯ç¤ºåˆ‡æ›æŒ‰éˆ• */
            .mobile-case-toggle { display: block; }

            /* å·¦å´é¢æ¿è®Šæˆã€Œæµ®å‹•æŠ½å±œã€ */
            .left-panel {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 10;
                display: none; /* é è¨­éš±è— */
                border-right: none;
            }

            .left-panel.show {
                display: block;
                animation: slideDown 0.3s ease-out;
            }

            /* å³å´é¢æ¿ä½”æ»¿ */
            .right-panel {
                width: 100%;
                height: 100%;
            }

            /* é€²åº¦æ¢èª¿æ•´ */
            .progress-bar { padding: 0.5rem; }
            .step span { font-size: 0.7rem; display: none; } /* æ‰‹æ©Ÿç‰ˆéš±è—é€²åº¦æ–‡å­—ï¼Œåªç•™åœˆåœˆ */
            .step.active span { display: block; } /* ç•¶å‰æ­¥é©Ÿæ‰é¡¯ç¤ºæ–‡å­— */

            /* è¼¸å…¥å€èª¿æ•´ */
            .input-area { padding: 0.8rem; }
            
            /* ç·´ç¿’æ¨¡å¼æç¤ºæ–‡å­—ç¸®å° */
            .practice-mode-indicator { font-size: 0.8rem; padding: 5px 10px; }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body>

<header>
    <div>
        <h1>IRAC æ³•å¾‹æ€ç¶­å°èˆªå„€</h1>
        <span class="subtitle">AI-Powered Legal Reasoning Trainer</span>
    </div>
    <div class="course-info">èª²ç¨‹ï¼šæ³•å¾‹èˆ‡äººå·¥æ™ºæ…§</div>
</header>

<div class="mobile-case-toggle" onclick="toggleMobileCase()">
    ğŸ“„ é»æ“ŠæŸ¥çœ‹/éš±è— æ¡ˆä¾‹äº‹å¯¦
</div>

<div class="container">
    <div class="left-panel" id="leftPanel">
        <div class="case-card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="case-title" style="margin-bottom:0;">æ¡ˆä¾‹äº‹å¯¦</div>
                <button onclick="toggleMobileCase()" style="display:none; background:none; color:#999; padding:0;" class="mobile-close-btn">âœ• é—œé–‰</button>
            </div>
            <hr style="border:0; border-top:1px solid #eee; margin: 10px 0;">
            
            <p id="caseFactsText">
                ç”²ï¼ˆç”·ï¼Œ30æ­²ï¼‰èˆ‡ä¹™ï¼ˆç”·ï¼Œ28æ­²ï¼‰ç‚ºé„°å±…ï¼Œç´ æœ‰ç©æ€¨ã€‚æŸæ—¥æ™šé–“ï¼Œå…©äººåœ¨ç¤¾å€é–€å£ç›¸é‡ï¼Œç™¼ç”Ÿæ¿€çƒˆå£è§’ã€‚ä¹™çªç„¶å¾å£è¢‹æ‹¿å‡ºæŠ˜ç–Šåˆ€ï¼Œå°ç”²å«å›‚ï¼šã€Œä¿¡ä¸ä¿¡æˆ‘æ…æ­»ä½ ï¼ã€ä¸¦å‘ç”²é€¼è¿‘ã€‚
                <br><br>
                ç”²è¦‹ç‹€é©šæï¼Œéš¨æ‰‹æ‹¿èµ·è·¯é‚Šçš„ç£šé ­ä¸Ÿå‘ä¹™ã€‚ç£šé ­æ“Šä¸­ä¹™çš„é ­éƒ¨ï¼Œä¹™ç•¶å ´å€’åœ°ï¼Œé€é†«å¾Œå› é¡±å…§å‡ºè¡€ä¸æ²»æ­»äº¡ã€‚
                <br><br>
                è«‹ä¾æ“šä¸Šè¿°äº‹å¯¦ï¼Œåˆ†æç”²çš„åˆ‘äº‹è²¬ä»»ã€‚
            </p>
            
            <button onclick="toggleMobileCase()" class="mobile-close-btn" style="width:100%; margin-top:15px; background:#7f8c8d; display:none;">
                å›åˆ°å°è©±
            </button>
        </div>

        <button class="example-button" onclick="toggleExample()">ğŸ“– æŸ¥çœ‹åƒè€ƒç¯„ä¾‹</button>
        <div id="exampleContent" class="example-content">
            <h4>ğŸ“ å„éšæ®µç­”é¡Œç¯„ä¾‹ï¼š</h4>
            <div style="margin-bottom: 15px;">
                <strong>Issue (çˆ­é»)ï¼š</strong>
                <p style="color:#27ae60; margin:5px 0;">ç”²çš„è¡Œç‚ºæ˜¯å¦ç¬¦åˆåˆ‘æ³•ç¬¬23æ¢ä¹‹æ­£ç•¶é˜²è¡›ï¼Ÿ</p>
            </div>
            <div style="margin-bottom: 15px;">
                <strong>Rule (è¦å‰‡)ï¼š</strong>
                <p style="color:#27ae60; margin:5px 0;">åˆ‘æ³•ç¬¬23æ¢æ­£ç•¶é˜²è¡›ï¼šç¾åœ¨ä¸æ³•ä¾µå®³ã€é˜²è¡›è¡Œç‚ºã€å¿…è¦æ€§ã€‚</p>
            </div>
            <div style="margin-bottom: 15px;">
                <strong>Application (æ¶µæ”)ï¼š</strong>
                <p style="color:#27ae60; margin:5px 0;">å› ç‚ºä¹™æŒåˆ€é€¼è¿‘å±¬ç¾åœ¨ä¸æ³•ä¾µå®³ï¼Œç”²ä¸Ÿç£šé ­æ˜¯ç‚ºäº†æ’é™¤ä¾µå®³ï¼Œç¬¦åˆæ­£ç•¶é˜²è¡›è¦ä»¶ã€‚</p>
            </div>
            <div>
                <strong>Conclusion (çµè«–)ï¼š</strong>
                <p style="color:#27ae60; margin:5px 0;">ç”²ä¹‹è¡Œç‚ºæ§‹æˆæ­£ç•¶é˜²è¡›ï¼Œä¸ç½°ã€‚</p>
            </div>
        </div>

        <div style="margin-top: 20px; color: #666; font-size: 0.85rem;">
            <p><strong>ğŸ’¡ è€å¸«çš„å°æç¤ºï¼š</strong></p>
            <ul>
                <li>è«‹ä¸è¦æ€¥è‘—åˆ¤æ–·æœ‰ç½ªç„¡ç½ªã€‚</li>
                <li>ä¾ç…§å³å´çš„å°èˆªï¼Œä¸€æ­¥ä¸€æ­¥å»ºç«‹è«–è­‰ã€‚</li>
            </ul>
        </div>
    </div>

    <div class="right-panel">
        <div class="progress-bar">
            <div class="step active" id="step-issue"><div class="step-circle">I</div><span>çˆ­é»</span></div>
            <div class="step" id="step-rule"><div class="step-circle">R</div><span>è¦å‰‡</span></div>
            <div class="step" id="step-application"><div class="step-circle">A</div><span>æ¶µæ”</span></div>
            <div class="step" id="step-conclusion"><div class="step-circle">C</div><span>çµè«–</span></div>
        </div>

        <div id="practiceModeIndicator" class="practice-mode-indicator" style="display:none; background:#f39c12; color:white; padding:8px; text-align:center; font-size:0.85rem;">
            ğŸ¯ ç·´ç¿’æ¨¡å¼é–‹å•Ÿä¸­
        </div>

        <div class="chat-history" id="chatHistory">
            <div class="message ai-message">
                æ­¡è¿ä¾†åˆ°æ€ç¶­è¨“ç·´ã€‚æˆ‘å€‘å¾ç¬¬ä¸€æ­¥é–‹å§‹ï¼š<br><br>
                <strong>è«‹æŒ‡å‡ºæœ¬æ¡ˆæœ€æ ¸å¿ƒçš„æ³•å¾‹çˆ­é»ï¼ˆIssueï¼‰æ˜¯ä»€éº¼ï¼Ÿ</strong><br>
                ï¼ˆè«‹è©¦è‘—ç”¨å•å¥å½¢å¼æå‡ºï¼Œä¾‹å¦‚ï¼šç”²çš„è¡Œç‚ºæ˜¯å¦æ§‹æˆ...ï¼Ÿï¼‰
            </div>
        </div>

        <div class="input-area">
            <textarea id="userInput" placeholder="è¼¸å…¥ä½ çš„æƒ³æ³•..."></textarea>
            <button id="sendBtn" onclick="handleSubmit()">é€å‡º</button>
            <button class="practice-button" onclick="togglePracticeMode()" style="padding:0 1rem;">ğŸ¯</button>
        </div>
    </div>
</div>

<script>
    // =================CONFIG=================
    const N8N_WEBHOOK_URL = "https://kf0630.zeabur.app/webhook/irac-tutor"; 
    // ========================================

    const stages = ['issue', 'rule', 'application', 'conclusion'];
    let currentStageIndex = 0;
    let attemptCount = 0;
    let practiceMode = false;

    const stagePrompts = {
        'issue': 'è«‹æŒ‡å‡ºæœ¬æ¡ˆæœ€æ ¸å¿ƒçš„æ³•å¾‹çˆ­é»ï¼ˆIssueï¼‰æ˜¯ä»€éº¼ï¼Ÿ',
        'rule': 'é‡å°ä½ æå‡ºçš„çˆ­é»ï¼Œæ³•å¾‹è¦ç¯„ï¼ˆRuleï¼‰æ˜¯ä»€éº¼ï¼Ÿè«‹åˆ—å‡ºå…·é«”çš„æ§‹æˆè¦ä»¶ã€‚',
        'application': 'ç¾åœ¨é€²è¡Œæ¶µæ”ï¼ˆApplicationï¼‰ã€‚è«‹å°‡æœ¬æ¡ˆäº‹å¯¦å¡«å…¥ä¸Šè¿°è¦ä»¶ä¸­ï¼Œä¸¦è«–è­‰ç‚ºä½•ç¬¦åˆï¼ˆæˆ–ä¸ç¬¦åˆï¼‰ã€‚',
        'conclusion': 'æœ€å¾Œï¼Œè«‹æ ¹æ“šä¸Šè¿°æ¨è«–ï¼Œçµ¦å‡ºç°¡æ½”çš„æ³•å¾‹çµè«–ï¼ˆConclusionï¼‰ã€‚'
    };

    const practiceHints = {
        'issue': ['æç¤ºï¼šæƒ³æƒ³ç”²çš„è¡Œç‚ºæ€§è³ªæ˜¯ä»€éº¼ï¼Ÿ', 'æç¤ºï¼šå¯ä»¥å•ã€Œç”²çš„è¡Œç‚ºæ˜¯å¦ç¬¦åˆæ­£ç•¶é˜²è¡›ï¼Ÿã€'],
        'rule': ['æç¤ºï¼šåˆ‘æ³•ç¬¬23æ¢æ­£ç•¶é˜²è¡›è¦ä»¶ç‚ºä½•ï¼Ÿ', 'æç¤ºï¼šéœ€è¦æœ‰ã€Œç¾åœ¨ä¸æ³•ä¾µå®³ã€'],
        'application': ['æç¤ºï¼šä½¿ç”¨ã€Œå› ç‚º...ç¬¦åˆ...æ‰€ä»¥ã€å¥å‹', 'æç¤ºï¼šå…ˆè«–è¿°å®¢è§€äº‹å¯¦ï¼Œå†é€£çµæ³•å¾‹è¦ä»¶'],
        'conclusion': ['æç¤ºï¼šè‹¥ç¬¦åˆæ­£ç•¶é˜²è¡›ï¼Œå‰‡ä¸ç½°', 'æç¤ºï¼šçµ¦å‡ºæ˜ç¢ºçš„æœ‰ç½ª/ç„¡ç½ª/ä¸ç½°çµè«–']
    };

    const chatHistory = document.getElementById('chatHistory');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const caseFacts = document.getElementById('caseFactsText').innerText;

    // æ‰‹æ©Ÿç‰ˆåˆ‡æ›æ¡ˆä¾‹é¡¯ç¤º
    function toggleMobileCase() {
        const panel = document.getElementById('leftPanel');
        panel.classList.toggle('show');
        
        // åœ¨æ‰‹æ©Ÿç‰ˆæ§åˆ¶é—œé–‰æŒ‰éˆ•é¡¯ç¤º
        const closeBtns = document.querySelectorAll('.mobile-close-btn');
        if (window.innerWidth <= 768) {
            closeBtns.forEach(btn => {
                btn.style.display = panel.classList.contains('show') ? 'block' : 'none';
            });
        }
    }

    function toggleExample() {
        const example = document.getElementById('exampleContent');
        const button = document.querySelector('.example-button');
        if (example.style.display === 'block') {
            example.style.display = 'none';
            button.textContent = 'ğŸ“– æŸ¥çœ‹åƒè€ƒç¯„ä¾‹';
        } else {
            example.style.display = 'block';
            button.textContent = 'ğŸ“– éš±è—åƒè€ƒç¯„ä¾‹';
        }
    }

    function togglePracticeMode() {
        practiceMode = !practiceMode;
        const indicator = document.getElementById('practiceModeIndicator');
        const button = document.querySelector('.practice-button');
        
        if (practiceMode) {
            indicator.style.display = 'block';
            button.style.background = '#e67e22';
            appendMessage('ğŸ¯ ç·´ç¿’æ¨¡å¼å·²é–‹å•Ÿï¼', 'ai-message hint');
        } else {
            indicator.style.display = 'none';
            button.style.background = '#f39c12';
            appendMessage('ç·´ç¿’æ¨¡å¼å·²é—œé–‰ã€‚', 'ai-message');
        }
    }

    userInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSubmit();
        }
    });

    async function handleSubmit() {
        const text = userInput.value.trim();
        if (!text) return;

        appendMessage(text, 'user-message');
        userInput.value = '';
        userInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.textContent = '...';

        const payload = {
            student_input: text,
            current_stage: stages[currentStageIndex],
            case_facts: caseFacts,
            practice_mode: practiceMode
        };

        try {
            const response = await fetch(N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error('Network error');
            const data = await response.json();
            handleAIResponse(data);

        } catch (error) {
            console.error(error);
            appendMessage("âš ï¸ é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– n8nã€‚", "ai-message feedback-fail");
        } finally {
            userInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = 'é€å‡º';
            userInput.focus();
        }
    }

    function handleAIResponse(data) {
        const isPass = data.pass;
        const feedbackClass = isPass ? 'feedback-pass' : 'feedback-fail';
        appendMessage(data.feedback, `ai-message ${feedbackClass}`);

        if (!isPass) {
            attemptCount++;
            if (practiceMode && attemptCount >= 1) {
                const hints = practiceHints[stages[currentStageIndex]];
                if(hints) {
                    const hint = hints[Math.min(attemptCount-1, hints.length-1)];
                    setTimeout(() => appendMessage(hint, 'ai-message hint'), 800);
                }
            }
            // å¤±æ•—3æ¬¡è‡ªå‹•çµ¦é
            if (attemptCount >= 3) {
                setTimeout(() => {
                    appendMessage('ğŸ’ª æ²’é—œä¿‚ï¼Œæˆ‘å€‘å…ˆé€²å…¥ä¸‹ä¸€æ­¥ï¼', 'ai-message feedback-pass');
                    proceedToNextStage();
                }, 2000);
            }
        } else {
            proceedToNextStage();
        }
    }

    function proceedToNextStage() {
        attemptCount = 0;
        if (currentStageIndex < stages.length - 1) {
            currentStageIndex++;
            updateProgressBar();
            setTimeout(() => {
                appendMessage(`âœ… ä¸‹ä¸€éšæ®µï¼š<br>${stagePrompts[stages[currentStageIndex]]}`, 'ai-message');
            }, 800);
        } else {
            setTimeout(() => {
                appendMessage("ğŸ‰ å¤ªæ£’äº†ï¼IRAC æ¨è«–å®Œæˆã€‚", 'ai-message feedback-pass');
            }, 800);
        }
    }

    function appendMessage(htmlText, className) {
        const div = document.createElement('div');
        div.className = `message ${className}`;
        div.innerHTML = htmlText ? htmlText.replace(/\n/g, '<br>') : '';
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function updateProgressBar() {
        const allSteps = document.querySelectorAll('.step');
        allSteps.forEach((step, index) => {
            step.classList.remove('active');
            if (index < currentStageIndex) step.classList.add('completed');
            else if (index === currentStageIndex) step.classList.add('active');
        });
    }
</script>

</body>
</html>