<!DOCTYPE html>
<html lang="zh-TW">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>AI ç¬é–“ç­†è¨˜</title>
Â  <style>
Â  Â  * {
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  box-sizing: border-box;
Â  Â  }

Â  Â  body {
Â  Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â  Â  Â  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
Â  Â  Â  min-height: 100vh;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 20px;
Â  Â  }

Â  Â  .container {
Â  Â  Â  display: flex;
Â  Â  Â  background: white;
Â  Â  Â  border-radius: 20px;
Â  Â  Â  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
Â  Â  Â  width: 80%;
Â  Â  Â  max-width: 1000px;
Â  Â  }

Â  Â  .left-panel {
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 30px;
Â  Â  Â  border-right: 2px solid #f0f0f0;
Â  Â  Â  overflow-y: auto;
Â  Â  }

Â  Â  .left-panel h2 {
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  color: #333;
Â  Â  }

Â  Â  .form-group {
Â  Â  Â  margin-bottom: 20px;
Â  Â  }

Â  Â  label {
Â  Â  Â  display: block;
Â  Â  Â  margin-bottom: 6px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: #333;
Â  Â  }

Â  Â  input[type="text"],Â 
Â  Â  textarea {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 12px;
Â  Â  Â  border: 2px solid #e1e5e9;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  font-size: 14px;
Â  Â  Â  transition: border-color 0.3s ease;
Â  Â  }

Â  Â  input[type="text"]:focus,Â 
Â  Â  textarea:focus {
Â  Â  Â  outline: none;
Â  Â  Â  border-color: #667eea;
Â  Â  }

Â  Â  textarea {
Â  Â  Â  resize: vertical;
Â  Â  Â  font-family: inherit;
Â  Â  Â  height: 120px;
Â  Â  }

Â  Â  .btn {
Â  Â  Â  display: inline-block;
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  background: linear-gradient(45deg, #667eea, #764ba2);
Â  Â  Â  color: white;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  font-size: 14px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.3s ease;
Â  Â  }

Â  Â  .btn:hover {
Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
Â  Â  }

Â  Â  .btn:disabled {
Â  Â  Â  opacity: 0.6;
Â  Â  Â  cursor: not-allowed;
Â  Â  Â  transform: none;
Â  Â  }

Â  Â  .voice-controls {
Â  Â  Â  margin-top: 10px;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  gap: 15px;
Â  Â  }

Â  Â  .action-buttons {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 15px;
Â  Â  Â  margin-bottom: 20px;
Â  Â  }

Â  Â  .save-btn {
Â  Â  Â  flex: 1;
Â  Â  Â  background: linear-gradient(45deg, #28a745, #20c997);
Â  Â  }

Â  Â  .voice-btn {
Â  Â  Â  flex: 1;
Â  Â  Â  background: linear-gradient(45deg, #dc3545, #e74c3c);
Â  Â  Â  min-width: 120px;
Â  Â  }

Â  Â  .voice-btn.recording {
Â  Â  Â  background: #dc3545;
Â  Â  Â  animation: pulse 1s infinite;
Â  Â  }

Â  Â  @keyframes pulse {
Â  Â  Â  0% { opacity: 1; }
Â  Â  Â  50% { opacity: 0.7; }
Â  Â  Â  100% { opacity: 1; }
Â  Â  }

Â  Â  #recordingStatus {
Â  Â  Â  font-size: 14px;
Â  Â  Â  color: #666;
Â  Â  Â  font-weight: 500;
Â  Â  }

Â  Â  #recordingStatus.recording {
Â  Â  Â  color: #dc3545;
Â  Â  }

Â  Â  .right-panel {
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 30px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  overflow: hidden;
Â  Â  }

Â  Â  .right-panel h2 {
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  color: #333;
Â  Â  }

Â  Â  .chat-box {
Â  Â  Â  flex: 1;
Â  Â  Â  border: 2px solid #e1e5e9;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  padding: 15px;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  background: #fafafa;
Â  Â  Â  max-height: 400px;
Â  Â  }

Â  Â  .chat-message {
Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  padding: 10px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  position: relative; /* ç‚ºäº†è¤‡è£½æŒ‰éˆ•å®šä½ */
Â  Â  Â  white-space: pre-wrap;
Â  Â  Â  word-wrap: break-word;
Â  Â  }

Â  Â  .chat-message.user {
Â  Â  Â  background: #e3f2fd;
Â  Â  Â  margin-left: 20%;
Â  Â  Â  text-align: right;
Â  Â  }

Â  Â  .chat-message.ai {
Â  Â  Â  background: #f5f5f5;
Â  Â  Â  margin-right: 20%;
Â  Â  Â  text-align: left;
Â  Â  Â  padding-right: 40px; /* é¿å…æ–‡å­—è¢«æŒ‰éˆ•è“‹ä½ */
Â  Â  }

Â  Â  /* --- æ–°å¢è¤‡è£½æŒ‰éˆ•æ¨£å¼ --- */
Â  Â  .copy-btn {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 8px;
Â  Â  Â  right: 8px;
Â  Â  Â  background: #d1d5db;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 5px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  padding: 3px 6px;
Â  Â  Â  font-size: 12px;
Â  Â  Â  opacity: 0.5;
Â  Â  Â  transition: opacity 0.3s, background-color 0.3s;
Â  Â  }
Â  Â  .chat-message.ai:hover .copy-btn {
Â  Â  Â  opacity: 1;
Â  Â  }
Â  Â  .copy-btn:hover {
Â  Â  Â  background-color: #b0b5bd;
Â  Â  }
Â  Â  /* --- æ¨£å¼æ–°å¢çµæŸ --- */

Â  Â  .chat-input {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 10px;
Â  Â  }

Â  Â  .chat-input textarea {
Â  Â  Â  flex: 1;
Â  Â  Â  height: 60px;
Â  Â  Â  resize: none;
Â  Â  }

Â  Â  .chat-input button {
Â  Â  Â  flex-shrink: 0;
Â  Â  }

Â  Â  .page-header {
Â  Â  Â  text-align: center;
Â  Â  Â  color: white;
Â  Â  Â  margin-bottom: 20px;
Â  Â  }

Â  Â  .page-header h1 {
Â  Â  Â  font-size: 2rem;
Â  Â  Â  margin-bottom: 10px;
Â  Â  }

Â  Â  .page-header p {
Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  opacity: 0.9;
Â  Â  }

Â  Â  .search-results {
Â  Â  Â  margin-top: 20px;
Â  Â  Â  max-height: 400px;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  border: 1px solid #e1e5e9;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  padding: 10px;
Â  Â  }

Â  Â  .search-item {
Â  Â  Â  padding: 10px;
Â  Â  Â  border: 1px solid #e1e5e9;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background-color 0.3s;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: flex-start;
Â  Â  Â  gap: 10px;
Â  Â  Â  text-align: left;
Â  Â  }

Â  Â  .search-item:hover {
Â  Â  Â  background-color: #f0f7ff;
Â  Â  }

Â  Â  .search-item.selected {
Â  Â  Â  background-color: #e3f2fd;
Â  Â  Â  border-color: #667eea;
Â  Â  }

Â  Â  .search-item input[type="checkbox"] {
Â  Â  Â  margin-top: 5px;
Â  Â  Â  transform: scale(1.2);
Â  Â  Â  flex-shrink: 0;
Â  Â  }

Â  Â  .search-item-content {
Â  Â  Â  flex: 1;
Â  Â  Â  text-align: left;
Â  Â  }

Â  Â  .search-item-content label {
Â  Â  Â  text-align: left;
Â  Â  Â  width: 100%;
Â  Â  Â  cursor: pointer;
Â  Â  }

Â  Â  .search-item-content strong {
Â  Â  Â  display: block;
Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  text-align: left;
Â  Â  }

Â  Â  .search-item-content p {
Â  Â  Â  margin: 0;
Â  Â  Â  text-align: left;
Â  Â  Â  color: #666;
Â  Â  Â  line-height: 1.4;
Â  Â  }

Â  Â  .selection-controls {
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  display: flex;
Â  Â  Â  gap: 10px;
Â  Â  }

Â  Â  .selection-controls .btn {
Â  Â  Â  padding: 8px 12px;
Â  Â  Â  font-size: 12px;
Â  Â  Â  width: auto;
Â  Â  }

Â  Â  .status-message {
Â  Â  Â  padding: 10px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  text-align: center;
Â  Â  }

Â  Â  .status-success {
Â  Â  Â  background-color: #d4edda;
Â  Â  Â  color: #155724;
Â  Â  Â  border: 1px solid #c3e6cb;
Â  Â  }

Â  Â  .status-error {
Â  Â  Â  background-color: #f8d7da;
Â  Â  Â  color: #721c24;
Â  Â  Â  border: 1px solid #f5c6cb;
Â  Â  }

Â  Â  .status-info {
Â  Â  Â  background-color: #d1ecf1;
Â  Â  Â  color: #0c5460;
Â  Â  Â  border: 1px solid #bee5eb;
Â  Â  }

Â  Â  /* æ‰‹æ©Ÿç‰ˆæ¨£å¼ */
Â  Â  @media (max-width: 768px) {
Â  Â  Â  .container {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  margin: 0 10px;
Â  Â  Â  }

Â  Â  Â  .left-panel {
Â  Â  Â  Â  border-right: none;
Â  Â  Â  Â  border-bottom: 2px solid #f0f0f0;
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  }

Â  Â  Â  .right-panel {
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  }

Â  Â  Â  .chat-box {
Â  Â  Â  Â  max-height: 300px;
Â  Â  Â  Â  min-height: 250px;
Â  Â  Â  }

Â  Â  Â  .chat-input textarea {
Â  Â  Â  Â  height: 80px;
Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  }

Â  Â  Â  .chat-input {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 10px;
Â  Â  Â  }

Â  Â  Â  .chat-input button {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  }

Â  Â  Â  .page-header h1 {
Â  Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  }

Â  Â  Â  .page-header p {
Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  }

Â  Â  Â  body {
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  }

Â  Â  Â  .search-results {
Â  Â  Â  Â  max-height: 300px;
Â  Â  Â  }

Â  Â  Â  .btn {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  }

Â  Â  Â  .chat-message {
Â  Â  Â  Â  margin-left: 5%;
Â  Â  Â  Â  margin-right: 5%;
Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  line-height: 1.5;
Â  Â  Â  }

Â  Â  Â  .chat-message.user {
Â  Â  Â  Â  margin-left: 10%;
Â  Â  Â  Â  margin-right: 5%;
Â  Â  Â  }

Â  Â  Â  .chat-message.ai {
Â  Â  Â  Â  margin-left: 5%;
Â  Â  Â  Â  margin-right: 10%;
Â  Â  Â  }
Â  Â  }
Â  </style>
</head>
<body>
Â  <header class="page-header">
Â  Â  <h1>ğŸ“ AI ç¬é–“ç­†è¨˜</h1>
Â  Â  <p>è¼¸å…¥å­¸ç¿’å…§å®¹ï¼ŒAI å¹«ä½ å¿«é€Ÿç”Ÿæˆæ‘˜è¦ã€é‡é»ä¸¦é€²è¡Œäº’å‹•è¨è«–v02</p>
Â  </header>

Â  <div class="container">
Â  Â  <div class="left-panel">
Â  Â  Â  <h2>æ–°å¢ç­†è¨˜</h2>
Â  Â  Â  <div id="saveStatus"></div>
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="userId">ç”¨æˆ¶IDï¼š</label>
Â  Â  Â  Â  <input type="text" id="userId" value="demo_user">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="noteTitle">ç­†è¨˜æ¨™é¡Œï¼š</label>
Â  Â  Â  Â  <input type="text" id="noteTitle" placeholder="è¼¸å…¥æ¨™é¡Œ...">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="fileContent">å­¸ç¿’å…§å®¹ï¼š</label>
Â  Â  Â  Â  <textarea id="fileContent" placeholder="è²¼ä¸Šä½ çš„å­¸ç¿’å…§å®¹..."></textarea>
Â  Â  Â  Â  <div class="voice-controls">
Â  Â  Â  Â  Â  <span id="recordingStatus"></span>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="action-buttons">
Â  Â  Â  Â  <button class="btn save-btn" id="saveBtn">ğŸ’¾ å„²å­˜ä¸¦åˆ†æ</button>
Â  Â  Â  Â  <button type="button" class="btn voice-btn" id="voiceBtn">ğŸ”´ é–‹å§‹éŒ„éŸ³</button>
Â  Â  Â  </div>

Â  Â  Â  <h2 style="margin-top:30px;">æœå°‹ç­†è¨˜</h2>
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <input type="text" id="searchKeyword" placeholder="è¼¸å…¥é—œéµå­—...">
Â  Â  Â  </div>
Â  Â  Â  <button class="btn" id="searchBtn">ğŸ” æœå°‹</button>
Â  Â  Â Â 
Â  Â  Â  <div id="searchResults" class="search-results"></div>
Â  Â  </div>

Â  Â  <div class="right-panel">
Â  Â  Â  <h2>AI è¨è«–</h2>
Â  Â  Â  <p id="selectedNote">é¸å®šçš„ç­†è¨˜ï¼šå°šæœªé¸æ“‡</p>
Â  Â  Â  <div class="chat-box" id="chatBox">
Â  Â  Â  Â  <div class="chat-message ai">
Â  Â  Â  Â  Â  æ­¡è¿ä½¿ç”¨ AI ç¬é–“ç­†è¨˜ï¼æœå°‹ç­†è¨˜å¾Œï¼Œè«‹é¸æ“‡ç­†è¨˜é–‹å§‹AIæ™ºèƒ½å°è©±ï¼Œæˆ–ç›´æ¥ä»¥æ–‡å­—æˆ–éŒ„éŸ³å‰µå»ºæ–°ç­†è¨˜ã€‚
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="chat-input">
Â  Â  Â  Â  <textarea id="chatInput" placeholder="è¼¸å…¥ä½ æƒ³è¨è«–çš„å•é¡Œ..." disabled>æ‘˜è¦èˆ‡æŠ“é‡é»</textarea>
Â  Â  Â  Â  <button class="btn" id="sendBtn" disabled>ğŸ¤– èˆ‡ AI è¨è«–</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // é…ç½®ï¼šn8n webhook URLs
Â  Â  const API_BASE = "https://kf0630.zeabur.app/webhook";
Â  Â  const CONFIG = {
Â  Â  Â  uploadUrl: API_BASE + '/upload-notes',
Â  Â  Â  searchUrl: API_BASE + '/search-records',
Â  Â  Â  discussUrl: API_BASE + '/discuss-note'
Â  Â  };

Â  Â  // DOM å…ƒç´ 
Â  Â  const chatBox = document.getElementById('chatBox');
Â  Â  const chatInput = document.getElementById('chatInput');
Â  Â  const sendBtn = document.getElementById('sendBtn');
Â  Â  const saveBtn = document.getElementById('saveBtn');
Â  Â  const searchBtn = document.getElementById('searchBtn');
Â  Â  const saveStatus = document.getElementById('saveStatus');
Â  Â  const searchResults = document.getElementById('searchResults');
Â  Â  const selectedNote = document.getElementById('selectedNote');
Â  Â  const voiceBtn = document.getElementById('voiceBtn');
Â  Â  const recordingStatus = document.getElementById('recordingStatus');

Â  Â  let currentSelectedNote = null;
Â  Â  let selectedNotes = [];
Â  Â  let mediaRecorder;
Â  Â  let audioChunks = [];
Â  Â  let isRecording = false;

Â  Â  // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
Â  Â  function showStatus(message, type = 'info') {
Â  Â  Â  saveStatus.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  saveStatus.innerHTML = '';
Â  Â  Â  }, 5000);
Â  Â  }

Â  Â  // åˆä½µå¤šå€‹ç­†è¨˜å…§å®¹çš„å‡½æ•¸
Â  Â  function combineNotesContent(notes) {
Â  Â  Â  if (!Array.isArray(notes) || notes.length === 0) return '';
Â  Â  Â Â 
Â  Â  Â  return notes.map((note, index) => {
Â  Â  Â  Â  const title = note.json?.FileName || `ç­†è¨˜ ${index + 1}`;
Â  Â  Â  Â  const content = note.json?.Content || '';
Â  Â  Â  Â  return `=== ${title} ===\n${content}`;
Â  Â  Â  }).join('\n\n');
Â  Â  }

Â  Â  // èªéŸ³éŒ„éŸ³åŠŸèƒ½
Â  Â  async function initVoiceRecording() {
Â  Â  Â  try {
Â  Â  Â  Â  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
Â  Â  Â  Â  mediaRecorder = new MediaRecorder(stream);
Â  Â  Â  Â Â 
Â  Â  Â  Â  mediaRecorder.ondataavailable = (event) => {
Â  Â  Â  Â  Â  if (event.data.size > 0) {
Â  Â  Â  Â  Â  Â  audioChunks.push(event.data);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  mediaRecorder.onstop = async () => {
Â  Â  Â  Â  Â  const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
Â  Â  Â  Â  Â  audioChunks = [];
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  await uploadAudioForTranscription(audioBlob);
Â  Â  Â  Â  Â  stream.getTracks().forEach(track => track.stop());
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  return true;
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('ç„¡æ³•å­˜å–éº¥å…‹é¢¨:', error);
Â  Â  Â  Â  showStatus('ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®š', 'error');
Â  Â  Â  Â  return false;
Â  Â  Â  }
Â  Â  }

Â  Â  async function toggleRecording() {
Â  Â  Â  if (!isRecording) {
Â  Â  Â  Â  const canRecord = await initVoiceRecording();
Â  Â  Â  Â  if (!canRecord) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  mediaRecorder.start();
Â  Â  Â  Â  isRecording = true;
Â  Â  Â  Â Â 
Â  Â  Â  Â  voiceBtn.textContent = 'â¹ï¸ åœæ­¢éŒ„éŸ³';
Â  Â  Â  Â  voiceBtn.classList.add('recording');
Â  Â  Â  Â  recordingStatus.textContent = 'æ­£åœ¨éŒ„éŸ³ä¸­... æŒ‰åœæ­¢éŒ„éŸ³çµæŸ';
Â  Â  Â  Â  recordingStatus.classList.add('recording');
Â  Â  Â  Â Â 
Â  Â  Â  } else {
Â  Â  Â  Â  mediaRecorder.stop();
Â  Â  Â  Â  isRecording = false;
Â  Â  Â  Â Â 
Â  Â  Â  Â  voiceBtn.textContent = 'ğŸ”´ é–‹å§‹éŒ„éŸ³';
Â  Â  Â  Â  voiceBtn.classList.remove('recording');
Â  Â  Â  Â  recordingStatus.textContent = 'è™•ç†ä¸­...';
Â  Â  Â  Â  recordingStatus.classList.remove('recording');
Â  Â  Â  Â Â 
Â  Â  Â  Â  voiceBtn.disabled = true;
Â  Â  Â  Â  saveBtn.disabled = true;
Â  Â  Â  }
Â  Â  }

Â  Â  async function uploadAudioForTranscription(audioBlob) {
Â  Â  Â  try {
Â  Â  Â  Â  const userId = document.getElementById('userId').value;
Â  Â  Â  Â  const fileName = document.getElementById('noteTitle').value || 'èªéŸ³ç­†è¨˜ ' + new Date().toLocaleString();
Â  Â  Â  Â Â 
Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  formData.append('audio_file', audioBlob, 'recording.wav');
Â  Â  Â  Â  formData.append('userId', userId);
Â  Â  Â  Â  formData.append('fileName', fileName);
Â  Â  Â  Â  formData.append('fileType', 'voice');
Â  Â  Â  Â  formData.append('isVoice', 'true');

Â  Â  Â  Â  recordingStatus.textContent = 'èªéŸ³è½‰æ–‡å­—ä¸¦åˆ†æä¸­...';

Â  Â  Â  Â  const response = await fetch(CONFIG.uploadUrl, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  body: formData
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
Â  Â  Â  Â  }

Â  Â  Â  Â  const result = await response.text();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (result && result.includes('æˆåŠŸå„²å­˜')) {
Â  Â  Â  Â  Â  showStatus('èªéŸ³ç­†è¨˜å·²æˆåŠŸå„²å­˜ï¼', 'success');
Â  Â  Â  Â  Â  recordingStatus.textContent = 'å®Œæˆï¼';
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  document.getElementById('noteTitle').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('fileContent').value = '';
Â  Â  Â  Â  Â  Â  recordingStatus.textContent = '';
Â  Â  Â  Â  Â  }, 2000);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  showStatus('èªéŸ³è™•ç†å¤±æ•—ï¼šæœªæ”¶åˆ°æœ‰æ•ˆå›æ‡‰', 'error');
Â  Â  Â  Â  Â  recordingStatus.textContent = '';
Â  Â  Â  Â  }

Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('èªéŸ³ä¸Šå‚³éŒ¯èª¤:', error);
Â  Â  Â  Â  showStatus('èªéŸ³ä¸Šå‚³å¤±æ•—ï¼š' + error.message, 'error');
Â  Â  Â  Â  recordingStatus.textContent = '';
Â  Â  Â  } finally {
Â  Â  Â  Â  voiceBtn.disabled = false;
Â  Â  Â  Â  saveBtn.disabled = false;
Â  Â  Â  }
Â  Â  }

Â  Â  // æ–‡å­—å„²å­˜åŠŸèƒ½
Â  Â  saveBtn.addEventListener('click', async () => {
Â  Â  Â  const userId = document.getElementById('userId').value;
Â  Â  Â  const fileName = document.getElementById('noteTitle').value;
Â  Â  Â  const fileContent = document.getElementById('fileContent').value;

Â  Â  Â  if (!fileName || !fileContent) {
Â  Â  Â  Â  showStatus('è«‹å¡«å¯«æ¨™é¡Œå’Œå…§å®¹', 'error');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  saveBtn.disabled = true;
Â  Â  Â  saveBtn.textContent = 'è™•ç†ä¸­...';
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(CONFIG.uploadUrl, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  'Accept': 'application/json'
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  userId: userId,
Â  Â  Â  Â  Â  Â  fileName: fileName,
Â  Â  Â  Â  Â  Â  fileType: 'text',
Â  Â  Â  Â  Â  Â  fileContent: fileContent
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
Â  Â  Â  Â  }

Â  Â  Â  Â  const result = await response.text();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (result && result.includes('æˆåŠŸå„²å­˜')) {
Â  Â  Â  Â  Â  showStatus('ç­†è¨˜å·²æˆåŠŸå„²å­˜ï¼', 'success');
Â  Â  Â  Â  Â  document.getElementById('noteTitle').value = '';
Â  Â  Â  Â  Â  document.getElementById('fileContent').value = '';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  showStatus('å„²å­˜å¤±æ•—ï¼šæœªæ”¶åˆ°æœ‰æ•ˆå›æ‡‰', 'error');
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('è©³ç´°éŒ¯èª¤:', error);
Â  Â  Â  Â  if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
Â  Â  Â  Â  Â  showStatus('é€£æ¥å¤±æ•—ï¼šç„¡æ³•é€£æ¥åˆ°æœå‹™å™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æœå‹™ç‹€æ…‹', 'error');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  showStatus('è™•ç†å¤±æ•—ï¼š' + error.message, 'error');
Â  Â  Â  Â  }
Â  Â  Â  } finally {
Â  Â  Â  Â  saveBtn.disabled = false;
Â  Â  Â  Â  saveBtn.textContent = 'ğŸ’¾ å„²å­˜ä¸¦åˆ†æ';
Â  Â  Â  }
Â  Â  });

Â  Â  // èªéŸ³æŒ‰éˆ•äº‹ä»¶
Â  Â  voiceBtn.addEventListener('click', toggleRecording);

Â  Â  // æœå°‹ç­†è¨˜
Â  Â  searchBtn.addEventListener('click', async () => {
Â  Â  Â  const keyword = document.getElementById('searchKeyword').value;
Â  Â  Â Â 
Â  Â  Â  if (!keyword) {
Â  Â  Â  Â  showStatus('è«‹è¼¸å…¥æœå°‹é—œéµå­—', 'error');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  searchBtn.disabled = true;
Â  Â  Â  searchBtn.textContent = 'æœå°‹ä¸­...';

Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(CONFIG.searchUrl, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  keyword: keyword
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  });

Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (result.success && result.records) {
Â  Â  Â  Â  Â  displaySearchResults(result.records);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  searchResults.innerHTML = '<p>æ²’æœ‰æ‰¾åˆ°ç›¸é—œç­†è¨˜</p>';
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error:', error);
Â  Â  Â  Â  searchResults.innerHTML = '<p>æœå°‹å¤±æ•—ï¼Œè«‹é‡è©¦</p>';
Â  Â  Â  } finally {
Â  Â  Â  Â  searchBtn.disabled = false;
Â  Â  Â  Â  searchBtn.textContent = 'ğŸ” æœå°‹';
Â  Â  Â  }
Â  Â  });

Â  Â  function displaySearchResults(records) {
Â  Â  Â  searchResults.innerHTML = '';
Â  Â  Â Â 
Â  Â  Â  const controlsDiv = document.createElement('div');
Â  Â  Â  controlsDiv.className = 'selection-controls';
Â  Â  Â  controlsDiv.innerHTML = `
Â  Â  Â  Â  <button class="btn" id="selectAllBtn">å…¨é¸</button>
Â  Â  Â  Â  <button class="btn" id="clearSelectionBtn">æ¸…ç©ºé¸æ“‡</button>
Â  Â  Â  Â  <span id="selectedCount">å·²é¸æ“‡: 0 ç¯‡</span>
Â  Â  Â  `;
Â  Â  Â  searchResults.appendChild(controlsDiv);
Â  Â  Â Â 
Â  Â  Â  document.getElementById('selectAllBtn').addEventListener('click', () => {
Â  Â  Â  Â  const checkboxes = searchResults.querySelectorAll('.note-checkbox');
Â  Â  Â  Â  checkboxes.forEach(checkbox => {
Â  Â  Â  Â  Â  if (!checkbox.checked) {
Â  Â  Â  Â  Â  Â  checkbox.checked = true;
Â  Â  Â  Â  Â  Â  checkbox.dispatchEvent(new Event('change'));
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  document.getElementById('clearSelectionBtn').addEventListener('click', () => {
Â  Â  Â  Â  const checkboxes = searchResults.querySelectorAll('.note-checkbox');
Â  Â  Â  Â  checkboxes.forEach(checkbox => {
Â  Â  Â  Â  Â  if (checkbox.checked) {
Â  Â  Â  Â  Â  Â  checkbox.checked = false;
Â  Â  Â  Â  Â  Â  checkbox.dispatchEvent(new Event('change'));
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  records.forEach((record, index) => {
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.className = 'search-item';
Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  <input type="checkbox" id="note_${index}" class="note-checkbox" data-index="${index}">
Â  Â  Â  Â  Â  <div class="search-item-content">
Â  Â  Â  Â  Â  Â  <label for="note_${index}">
Â  Â  Â  Â  Â  Â  Â  <strong>${record.json?.FileName || 'ç„¡æ¨™é¡Œ'}</strong>
Â  Â  Â  Â  Â  Â  Â  <p>${(record.json?.Content || '').substring(0, 100)}...</p>
Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const checkbox = div.querySelector('.note-checkbox');
Â  Â  Â  Â  checkbox.addEventListener('change', () => {
Â  Â  Â  Â  Â  if (checkbox.checked) {
Â  Â  Â  Â  Â  Â  selectedNotes.push(record);
Â  Â  Â  Â  Â  Â  div.classList.add('selected');
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  selectedNotes = selectedNotes.filter(note =>Â 
Â  Â  Â  Â  Â  Â  Â  note.json?.FileName !== record.json?.FileName
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  div.classList.remove('selected');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  updateSelectedNotes();
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  div.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  if (e.target.type !== 'checkbox') {
Â  Â  Â  Â  Â  Â  checkbox.checked = !checkbox.checked;
Â  Â  Â  Â  Â  Â  checkbox.dispatchEvent(new Event('change'));
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  searchResults.appendChild(div);
Â  Â  Â  });
Â  Â  }

Â  Â  function updateSelectedNotes() {
Â  Â  Â  const count = selectedNotes.length;
Â  Â  Â  document.getElementById('selectedCount').textContent = `å·²é¸æ“‡: ${count} ç¯‡`;
Â  Â  Â Â 
Â  Â  Â  if (count > 0) {
Â  Â  Â  Â  currentSelectedNote = selectedNotes;
Â  Â  Â  Â  selectedNote.textContent = `é¸å®šçš„ç­†è¨˜ï¼š${count} ç¯‡ (${selectedNotes.map(note => note.json?.FileName || 'ç„¡æ¨™é¡Œ').join(', ')})`;
Â  Â  Â  Â  chatInput.disabled = false;
Â  Â  Â  Â  sendBtn.disabled = false;
Â  Â  Â  Â Â 
Â  Â  Â  Â  chatBox.innerHTML = `
Â  Â  Â  Â  Â  <div class="chat-message ai">
å·²é¸å®š ${count} ç¯‡ç­†è¨˜ï¼š
${selectedNotes.map(note => `â€¢ ${note.json?.FileName || 'ç„¡æ¨™é¡Œ'}`).join('\n')}

ç¾åœ¨ä½ å¯ä»¥å•æˆ‘é—œæ–¼é€™äº›ç­†è¨˜çš„ä»»ä½•å•é¡Œï¼
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  } else {
Â  Â  Â  Â  currentSelectedNote = null;
Â  Â  Â  Â  selectedNote.textContent = 'é¸å®šçš„ç­†è¨˜ï¼šå°šæœªé¸æ“‡';
Â  Â  Â  Â  chatInput.disabled = true;
Â  Â  Â  Â  sendBtn.disabled = true;
Â  Â  Â  Â Â 
Â  Â  Â  Â  chatBox.innerHTML = '<div class="chat-message ai">æ­¡è¿ä½¿ç”¨ AI ç¬é–“ç­†è¨˜ï¼æœå°‹ç­†è¨˜å¾Œï¼Œè«‹é¸æ“‡ç­†è¨˜é–‹å§‹AIæ™ºèƒ½å°è©±ï¼Œæˆ–ç›´æ¥ä»¥æ–‡å­—æˆ–éŒ„éŸ³å‰µå»ºæ–°ç­†è¨˜ã€‚</div>';
Â  Â  Â  }
Â  Â  }

Â  Â  // AI è¨è«–
Â  Â  sendBtn.addEventListener('click', async () => {
Â  Â  Â  const userMessage = chatInput.value.trim();
Â  Â  Â Â 
Â  Â  Â  if (!userMessage || !currentSelectedNote) return;

Â  Â  Â  const userDiv = document.createElement('div');
Â  Â  Â  userDiv.className = 'chat-message user';
Â  Â  Â  userDiv.textContent = userMessage;
Â  Â  Â  chatBox.appendChild(userDiv);

Â  Â  Â  chatInput.value = '';
Â  Â  Â  sendBtn.disabled = true;
Â  Â  Â  sendBtn.textContent = 'æ€è€ƒä¸­...';

Â  Â  Â  try {
Â  Â  Â  Â  let noteContent = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (Array.isArray(currentSelectedNote)) {
Â  Â  Â  Â  Â  noteContent = combineNotesContent(currentSelectedNote);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  noteContent = currentSelectedNote.json?.Content || '';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const response = await fetch(CONFIG.discussUrl, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  noteContent: noteContent,
Â  Â  Â  Â  Â  Â  question: userMessage
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  });

Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (result.success) {
Â  Â  Â  Â  Â  Â  /* --- æ ¸å¿ƒä¿®æ”¹è™• --- */
Â  Â  Â  Â  Â  const aiDiv = document.createElement('div');
Â  Â  Â  Â  Â  aiDiv.className = 'chat-message ai';

Â  Â  Â  Â  Â  Â  // å»ºç«‹è¨Šæ¯å…§å®¹å…ƒç´ 
Â  Â  Â  Â  Â  const messageContent = document.createElement('span');
Â  Â  Â  Â  Â  messageContent.textContent = result.answer;

Â  Â  Â  Â  Â  Â  // å»ºç«‹è¤‡è£½æŒ‰éˆ•
Â  Â  Â  Â  Â  const copyBtn = document.createElement('button');
Â  Â  Â  Â  Â  copyBtn.className = 'copy-btn';
Â  Â  Â  Â  Â  copyBtn.textContent = 'ğŸ“‹'; // è¤‡è£½åœ–ç¤º
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // å¹«è¤‡è£½æŒ‰éˆ•åŠ ä¸Šé»æ“Šäº‹ä»¶
Â  Â  Â  Â  Â  copyBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  navigator.clipboard.writeText(result.answer).then(() => {
Â  Â  Â  Â  Â  Â  Â  copyBtn.textContent = 'âœ… å·²è¤‡è£½';
Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  copyBtn.textContent = 'ğŸ“‹';
Â  Â  Â  Â  Â  Â  Â  }, 2000); // 2ç§’å¾Œæ¢å¾©
Â  Â  Â  Â  Â  Â  }).catch(err => {
Â  Â  Â  Â  Â  Â  Â  console.error('è¤‡è£½å¤±æ•—:', err);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // å°‡è¨Šæ¯å…§å®¹å’ŒæŒ‰éˆ•éƒ½åŠ å…¥åˆ° AI è¨Šæ¯æ¡†ä¸­
Â  Â  Â  Â  Â  aiDiv.appendChild(messageContent);
Â  Â  Â  Â  Â  aiDiv.appendChild(copyBtn);
Â  Â  Â  Â  Â  chatBox.appendChild(aiDiv);
Â  Â  Â  Â  Â  Â  /* --- ä¿®æ”¹çµæŸ --- */
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  const aiDiv = document.createElement('div');
Â  Â  Â  Â  Â  aiDiv.className = 'chat-message ai';
Â  Â  Â  Â  Â  aiDiv.textContent = 'æŠ±æ­‰ï¼Œæˆ‘ç¾åœ¨ç„¡æ³•å›ç­”é€™å€‹å•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
Â  Â  Â  Â  Â  chatBox.appendChild(aiDiv);
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error:', error);
Â  Â  Â  Â  const aiDiv = document.createElement('div');
Â  Â  Â  Â  aiDiv.className = 'chat-message ai';
Â  Â  Â  Â  aiDiv.textContent = 'é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚';
Â  Â  Â  Â  chatBox.appendChild(aiDiv);
Â  Â  Â  } finally {
Â  Â  Â  Â  sendBtn.disabled = false;
Â  Â  Â  Â  sendBtn.textContent = 'ğŸ¤– èˆ‡ AI è¨è«–';
Â  Â  Â  Â  chatBox.scrollTop = chatBox.scrollHeight;
Â  Â  Â  }
Â  Â  });

Â  Â  // Enter éµç™¼é€è¨Šæ¯
Â  Â  chatInput.addEventListener('keypress', (e) => {
Â  Â  Â  if (e.key === 'Enter' && !e.shiftKey) {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  if (!sendBtn.disabled) {
Â  Â  Â  Â  Â  sendBtn.click();
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });
Â  </script>
</body>
</html>